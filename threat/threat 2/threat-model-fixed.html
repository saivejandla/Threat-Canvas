<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ThreatCanvas ‚Äî OWASP Threat Modeler</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

:root {
  --bg:#080e1a; --surface:#0c1426; --s2:#111d35; --s3:#172343;
  --border:#1e2d4a; --accent:#f59e0b; --text:#e8eef7; --text2:#7a90b0; --text3:#3d5275;
  --crit:#ef4444; --high:#f97316; --med:#facc15; --low:#34d399; --info:#60a5fa;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;}

header{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;border-bottom:1px solid var(--border);background:var(--surface);z-index:200;flex-shrink:0;gap:12px;}
.logo{display:flex;align-items:center;gap:9px;font-size:17px;font-weight:800;letter-spacing:-.5px;white-space:nowrap;}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,#f59e0b,#1d4ed8);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:15px;}
.logo span{color:var(--accent);}
.step-tabs{display:flex;gap:4px;flex:1;justify-content:center;}
.step-tab{padding:7px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text3);border:1px solid transparent;transition:all .15s;white-space:nowrap;}
.step-num{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;border:1.5px solid currentColor;font-size:9px;font-weight:800;line-height:1;margin-right:4px;vertical-align:middle;font-family:system-ui,sans-serif;}
.step-tab.active{background:var(--accent);color:#000;}
.step-tab.done:not(.active){color:var(--accent);border-color:rgba(245,158,11,.3);}
.step-tab.active.done{background:var(--accent);color:#000;}
.step-tab:hover:not(.active){background:var(--s2);color:var(--text2);}
.hdr-actions{display:flex;gap:7px;align-items:center;flex-shrink:0;}
.btn{padding:7px 14px;border-radius:6px;border:none;cursor:pointer;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:700;transition:all .15s;}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--s2);color:var(--text);}
.btn-primary{background:var(--accent);color:#000;}
.btn-primary:hover{background:#fbbf24;}
.btn-sm{padding:5px 10px;font-size:11px;}

.main{display:flex;flex:1;overflow:hidden;}
.step-panel{display:none;flex:1;overflow:hidden;}
.step-panel.active{display:flex;}

/* STEP 1 */
.scope-layout{display:flex;flex:1;overflow:hidden;}
.scope-sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column;}
.scope-nav-item{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);border-bottom:1px solid var(--border);transition:all .15s;}
.scope-nav-item:hover{background:var(--s2);color:var(--text);}
.scope-nav-item.anav{color:var(--accent);background:rgba(245,158,11,.06);}
.scope-nav-num{width:20px;height:20px;border-radius:50%;background:var(--s3);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;flex-shrink:0;}
.scope-main{flex:1;overflow-y:auto;padding:20px;}
.scope-section{display:none;}
.scope-section.asec{display:block;}
.sec-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px;overflow:hidden;}
.sec-hdr{padding:12px 16px;background:var(--s2);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.sec-title{font-size:13px;font-weight:800;display:flex;align-items:center;gap:8px;}
.sec-body{padding:14px;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.fg{margin-bottom:12px;}
.fg:last-child{margin-bottom:0;}
.lbl{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:5px;display:block;letter-spacing:.5px;text-transform:uppercase;}
.inp{width:100%;padding:8px 11px;background:var(--s2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:12px;outline:none;transition:border-color .15s;}
.inp:focus{border-color:var(--accent);}
textarea.inp{resize:vertical;min-height:70px;}
select.inp{cursor:pointer;}
.dtable{width:100%;border-collapse:collapse;font-size:12px;}
.dtable th{padding:8px 10px;text-align:left;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border);background:var(--s3);}
.dtable td{padding:9px 10px;border-bottom:1px solid var(--border);color:var(--text2);vertical-align:top;}
.dtable tr:last-child td{border-bottom:none;}
.dtable tr:hover td{background:var(--s2);}
.dtable td:first-child{color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:11px;white-space:nowrap;}
.add-btn{width:100%;padding:8px;border:1px dashed var(--border);border-radius:6px;background:transparent;color:var(--text3);font-size:12px;cursor:pointer;margin-top:8px;transition:all .15s;}
.add-btn:hover{border-color:var(--accent);color:var(--accent);}
.del-btn{background:transparent;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:2px 6px;border-radius:4px;transition:all .15s;}
.del-btn:hover{background:rgba(255,68,68,.15);color:var(--crit);}

/* STEP 2 */
.threats-layout{display:flex;flex:1;overflow:hidden;}
.palette{width:180px;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;}
.pal-sec{padding:10px;border-bottom:1px solid var(--border);}
.pal-lbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;}
.pal-item{display:flex;align-items:center;gap:8px;padding:8px 9px;border-radius:6px;cursor:grab;transition:all .15s;border:1px solid transparent;margin-bottom:3px;font-size:12px;font-weight:600;color:var(--text2);}
.pal-item:hover{background:var(--s2);border-color:var(--border);color:var(--text);transform:translateX(2px);}
.pal-item:active{cursor:grabbing;opacity:.7;}
.pal-ico{width:26px;height:26px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--bg);background-image:radial-gradient(circle at 50% 50%,rgba(245,158,11,.04) 0%,transparent 60%),linear-gradient(rgba(255,255,255,.012) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.012) 1px,transparent 1px);background-size:100% 100%,28px 28px,28px 28px;}
/* #viewport is the single transform target ‚Äî large fixed virtual canvas so nodes
   never stretch to fill a percentage-based parent. 4000√ó3000 gives ample space. */
#viewport{position:absolute;top:0;left:0;width:4000px;height:3000px;transform-origin:0 0;}
/* #canvas and #svgLayer fill the virtual canvas, not the screen viewport */
#canvas{width:4000px;height:3000px;position:relative;}
#svgLayer{position:absolute;top:0;left:0;width:4000px;height:3000px;pointer-events:none;z-index:5;}
/* Zoom controls bar */
.zoom-bar{position:absolute;bottom:14px;right:14px;display:flex;align-items:center;gap:2px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px 6px;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,.4);}
.zoom-btn{background:transparent;border:none;color:var(--text2);font-size:14px;font-weight:700;cursor:pointer;padding:3px 8px;border-radius:5px;transition:all .12s;font-family:'JetBrains Mono',monospace;line-height:1;}
.zoom-btn:hover{background:var(--s2);color:var(--text);}
.zoom-pct{font-size:12px;font-weight:700;color:var(--text);font-family:'JetBrains Mono',monospace;min-width:38px;text-align:center;cursor:default;}
.zoom-sep{width:1px;height:16px;background:var(--border);margin:0 3px;}
/* empty-hint is a sibling of #viewport (not inside it) so top:50% = 50% of canvas-wrap */
.empty-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--text3);pointer-events:none;z-index:50;}
.empty-hint h3{font-size:15px;font-weight:700;margin-bottom:8px;}
.empty-hint p{font-size:12px;}
.node{position:absolute;min-width:116px;border-radius:9px;cursor:move;user-select:none;z-index:10;border:1.5px solid var(--border);background:var(--surface);transition:box-shadow .2s;}
.node:hover{box-shadow:0 0 0 2px var(--accent),0 6px 24px rgba(245,158,11,.18);}
.node.selected{box-shadow:0 0 0 2px var(--accent),0 6px 24px rgba(245,158,11,.3)!important;border-color:var(--accent);}
.node.threatened{box-shadow:0 0 0 2px var(--crit),0 6px 24px rgba(255,68,68,.2);border-color:var(--crit);}
.node-hdr{display:flex;align-items:center;gap:7px;padding:9px 10px;border-radius:8px 8px 0 0;}
.node-ico{font-size:15px;}
.node-title{font-size:11px;font-weight:800;flex:1;}
.node-body{padding:5px 10px;font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;border-top:1px solid var(--border);}
.node-pills{display:flex;gap:3px;padding:5px 8px;border-top:1px solid var(--border);flex-wrap:wrap;min-height:18px;}
.pill{font-size:9px;padding:2px 5px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-weight:700;}
.port{width:10px;height:10px;background:var(--s3);border:2px solid var(--border);border-radius:50%;position:absolute;cursor:crosshair;transition:all .15s;z-index:20;}
.port:hover,.port.active{background:var(--accent);border-color:var(--accent);transform:scale(1.4);}
.port-r{right:-5px;top:50%;transform:translateY(-50%);}
.port-r:hover,.port-r.active{transform:translateY(-50%) scale(1.4);}
.port-l{left:-5px;top:50%;transform:translateY(-50%);}
.port-l:hover,.port-l.active{transform:translateY(-50%) scale(1.4);}
.particle{position:absolute;width:5px;height:5px;border-radius:50%;pointer-events:none;z-index:5;}
.rpanel{width:270px;background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;padding:14px;}
.rp-title{font-size:11px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;}
.threat-card{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:7px;}
.tc-head{display:flex;align-items:flex-start;gap:7px;margin-bottom:5px;}
.sev-dot{width:7px;height:7px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.tc-name{font-size:11px;font-weight:700;flex:1;line-height:1.3;}
.tc-id{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text3);}
.tc-stride{font-size:10px;padding:2px 6px;border-radius:3px;border:1px solid;font-family:'JetBrains Mono',monospace;font-weight:700;display:inline-block;margin-bottom:6px;}
.tc-desc{font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:6px;}
.tc-mit{padding:2px 0 2px 12px;position:relative;line-height:1.4;font-size:11px;color:var(--text2);}
.tc-mit::before{content:'‚Ä∫';position:absolute;left:0;color:var(--accent);}
.atk-btn{padding:7px 10px;background:var(--s2);border:1px solid var(--border);border-radius:6px;margin-bottom:5px;cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;}
.atk-btn:hover{border-color:var(--accent);color:var(--accent);}

/* STEP 3 */
.cm-layout{display:flex;flex:1;overflow:hidden;}
.cm-main{flex:1;overflow-y:auto;padding:18px;}
.cm-sidebar{width:260px;background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;padding:14px;flex-shrink:0;}
.stride-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-bottom:16px;}
.stride-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px;cursor:pointer;transition:all .15s;}
.stride-card:hover,.stride-card.af{border-color:var(--accent);}
.stride-card.af{background:rgba(245,158,11,.06);}
.stride-ico{font-size:20px;margin-bottom:5px;}
.stride-name{font-size:12px;font-weight:800;margin-bottom:2px;}
.stride-desc{font-size:10px;color:var(--text2);line-height:1.3;}
.stride-cnt{font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-top:5px;}
.sec-card-hdr{padding:11px 14px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.sec-card-title{font-size:13px;font-weight:800;}
.cm-select{width:100%;padding:4px 7px;background:var(--s3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;cursor:pointer;outline:none;}
.cm-select:focus{border-color:var(--accent);}

/* STEP 4 */
.assess-layout{display:flex;flex:1;overflow:hidden;}
.assess-main{flex:1;overflow-y:auto;padding:18px;}
.assess-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px;}
.assess-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.assess-num{font-size:32px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:3px;}
.assess-lbl{font-size:11px;color:var(--text2);}
.chk-item{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;}
.chk-ico{font-size:17px;}
.chk-text{flex:1;font-size:13px;font-weight:600;}
.chk-sub{font-size:11px;color:var(--text2);}
.chk-status{font-size:11px;font-weight:700;padding:3px 9px;border-radius:4px;white-space:nowrap;}
.chk-ok{background:rgba(52,211,153,.12);color:var(--low);}
.chk-fail{background:rgba(255,68,68,.15);color:var(--crit);}

/* ‚îÄ‚îÄ Executive Summary Modal ‚îÄ‚îÄ */
.exec-modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:26px 28px;width:740px;max-width:92vw;max-height:86vh;overflow-y:auto;}
.exec-modal::-webkit-scrollbar{width:5px;}.exec-modal::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.exec-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px;}
.exec-title{font-size:18px;font-weight:800;letter-spacing:-.3px;}
.exec-subtitle{font-size:11px;color:var(--text2);margin-top:3px;}
.exec-close{background:transparent;border:none;color:var(--text3);font-size:18px;cursor:pointer;padding:2px 6px;border-radius:4px;flex-shrink:0;transition:color .15s;}
.exec-close:hover{color:var(--text);}
/* Maturity badge */
.maturity-band{display:flex;align-items:center;gap:18px;padding:16px 18px;border-radius:10px;border:1px solid;margin-bottom:18px;}
.maturity-level{font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;}
.maturity-label{font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;opacity:.75;margin-top:2px;}
.maturity-desc{font-size:12px;line-height:1.55;flex:1;}
/* KPI row */
.exec-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px;}
.exec-kpi{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:13px 12px;text-align:center;}
.exec-kpi-val{font-size:24px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:3px;}
.exec-kpi-lbl{font-size:10px;color:var(--text2);font-weight:700;letter-spacing:.4px;text-transform:uppercase;}
/* Sections */
.exec-section{margin-bottom:16px;}
.exec-section-title{font-size:11px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.exec-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.exec-narrative{font-size:12px;line-height:1.7;color:var(--text);background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;}
/* Risk items */
.exec-risk-item{display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border-radius:7px;border-left:3px solid;margin-bottom:7px;background:var(--s2);}
.exec-risk-cat{font-size:10px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:.5px;white-space:nowrap;margin-top:1px;}
.exec-risk-text{font-size:11px;color:var(--text2);line-height:1.5;}
/* Action plan */
.exec-action{display:flex;align-items:flex-start;gap:10px;padding:9px 12px;border-radius:7px;background:var(--s2);border:1px solid var(--border);margin-bottom:7px;}
.exec-action-tag{font-size:9px;font-weight:800;letter-spacing:.5px;padding:2px 7px;border-radius:4px;white-space:nowrap;margin-top:1px;flex-shrink:0;}
.exec-action-text{font-size:11px;color:var(--text2);line-height:1.5;}
/* Progress bar */
.exec-progress-wrap{background:var(--s3);border-radius:6px;height:10px;overflow:hidden;margin-top:6px;}
.exec-progress-bar{height:100%;border-radius:6px;transition:width .5s ease;}
.exec-progress-label{display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-bottom:4px;}
/* Detection confidence */
.detect-nodes{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.detect-node-chip{font-size:10px;padding:3px 9px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-weight:700;}
/* Footer actions */
.exec-footer{display:flex;gap:8px;margin-top:20px;padding-top:14px;border-top:1px solid var(--border);}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px);display:none;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;width:440px;max-height:80vh;overflow-y:auto;}
.modal-title{font-size:17px;font-weight:800;margin-bottom:14px;}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end;}

/* BARS */
.sim-bar{display:flex;align-items:center;gap:10px;padding:7px 16px;border-top:1px solid var(--border);background:var(--s2);flex-shrink:0;font-size:11px;}
.sim-dot{width:8px;height:8px;border-radius:50%;background:var(--text3);}
.sim-dot.run{background:var(--accent);box-shadow:0 0 6px var(--accent);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:.6;}50%{opacity:1;}}
.sv{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--accent);}
.toolbar{display:flex;align-items:center;gap:10px;padding:7px 16px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0;font-size:11px;color:var(--text2);}
.tb-sep{width:1px;height:16px;background:var(--border);}

/* SVG */
@keyframes dash{to{stroke-dashoffset:-20;}}
@keyframes adash{to{stroke-dashoffset:-10;}}
.c-norm{stroke-dasharray:6 4;animation:dash .7s linear infinite;}
.c-atk{stroke-dasharray:3 3;animation:adash .25s linear infinite;}

::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--s3);border-radius:2px;}

/* STRIDE canvas highlight */
.node.stride-highlight{box-shadow:0 0 0 2px var(--med),0 0 18px rgba(255,215,0,.35)!important;border-color:var(--med);animation:strideGlow .9s ease-in-out infinite alternate;}
@keyframes strideGlow{from{box-shadow:0 0 0 2px var(--med),0 0 10px rgba(255,215,0,.2);}to{box-shadow:0 0 0 2px var(--med),0 0 24px rgba(255,215,0,.55);}}

/* Collapsible threat cards */
.tc-collapsed{padding-bottom:8px;}
.threat-card{cursor:default;}

/* Save button */
.btn-save{background:rgba(245,158,11,.12);color:var(--accent);border:1px solid rgba(245,158,11,.35);}
.btn-save:hover{background:rgba(245,158,11,.25);border-color:var(--accent);}

/* ‚îÄ‚îÄ BLAST RADIUS ‚îÄ‚îÄ */
.node.blast-source{box-shadow:0 0 0 3px #ef4444,0 0 32px rgba(239,68,68,.5)!important;border-color:#ef4444;z-index:30;}
.node.blast-reached{box-shadow:0 0 0 2px #f97316,0 0 18px rgba(249,115,22,.35)!important;border-color:#f97316;}
.node.blast-reached-2{box-shadow:0 0 0 2px #facc15,0 0 14px rgba(250,204,21,.25)!important;border-color:#facc15;}
.node.blast-safe{opacity:.28;filter:grayscale(.6);}
@keyframes blastPulse{0%,100%{opacity:.7;}50%{opacity:1;}}
.node.blast-reached,.node.blast-reached-2{animation:blastPulse .8s ease-in-out infinite;}
.blast-bar{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);border-radius:8px;margin-bottom:10px;font-size:11px;}
/* Disclaimer shown in blast radius panel to warn against treating model outputs as authoritative measurements */
.blast-disclaimer{margin-top:10px;padding:9px 11px;background:rgba(250,204,21,.07);border:1px solid rgba(250,204,21,.25);border-radius:7px;display:flex;gap:8px;align-items:flex-start;}
.blast-disclaimer-icon{font-size:13px;flex-shrink:0;margin-top:1px;}
.blast-disclaimer-text{font-size:10px;color:var(--text2);line-height:1.55;}
.blast-disclaimer-text strong{color:var(--med);font-size:10.5px;}
.blast-disclaimer-text em{font-style:italic;color:var(--text);}
.blast-label{font-weight:800;color:#ef4444;}
.btn-mode{padding:6px 12px;border-radius:6px;border:1px solid var(--border);cursor:pointer;font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;transition:all .15s;background:transparent;color:var(--text2);}
.btn-mode.active{background:rgba(239,68,68,.15);border-color:#ef4444;color:#ef4444;}
.btn-mode:hover:not(.active){background:var(--s2);color:var(--text);}

/* ‚îÄ‚îÄ COMPONENT THREAT PROFILE ‚îÄ‚îÄ */
.ctp-panel{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px;}
.ctp-header{display:flex;align-items:center;gap:7px;margin-bottom:8px;padding-bottom:7px;border-bottom:1px solid var(--border);}
.ctp-icon{font-size:18px;}
.ctp-name{font-size:12px;font-weight:800;flex:1;}
.ctp-close{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 2px;}
.ctp-close:hover{color:var(--text);}
.ctp-stride-row{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;}
.ctp-badge{font-size:9px;padding:2px 6px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-weight:700;border:1px solid;}
.ctp-threat{margin-bottom:7px;padding:7px 9px;background:var(--surface);border:1px solid var(--border);border-radius:6px;border-left:3px solid;}
.ctp-tname{font-size:11px;font-weight:700;margin-bottom:3px;}
.ctp-mit{font-size:10px;color:var(--text2);padding-left:10px;position:relative;line-height:1.5;}
.ctp-mit::before{content:'‚Ä∫';position:absolute;left:0;color:var(--accent);}

/* ‚îÄ‚îÄ EDGE EDITOR ‚îÄ‚îÄ */
.edge-editor{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px;}
.edge-editor-title{font-size:11px;font-weight:800;color:var(--text2);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.ee-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.ee-fg{display:flex;flex-direction:column;gap:3px;}
.ee-lbl{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;}
.ee-sel{width:100%;padding:4px 6px;background:var(--s3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:10px;cursor:pointer;outline:none;}
.ee-sel:focus{border-color:var(--accent);}
.ee-del{width:100%;padding:5px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:5px;color:#ef4444;font-size:11px;font-weight:700;cursor:pointer;margin-top:4px;transition:all .15s;}
.ee-del:hover{background:rgba(239,68,68,.25);}

/* SVG pointer events on hit areas */
.edge-hit{pointer-events:all;cursor:pointer;}

/* ‚îÄ‚îÄ NETWORK ZONES ‚îÄ‚îÄ */
.node[data-zone="public"]{border-top:3px solid #ef4444;}
.node[data-zone="dmz"]{border-top:3px solid #f97316;}
.node[data-zone="private"]{border-top:3px solid #60a5fa;}
.node[data-zone="isolated"]{border-top:3px solid #34d399;}
.zone-badge{font-size:8px;padding:1px 5px;border-radius:2px;font-family:'JetBrains Mono',monospace;font-weight:700;margin-right:3px;}

/* ‚îÄ‚îÄ PRIVILEGE BADGES ‚îÄ‚îÄ */
.priv-badge{font-size:8px;padding:1px 5px;border-radius:2px;font-family:'JetBrains Mono',monospace;font-weight:700;}
.priv-admin{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid rgba(239,68,68,.4);}
.priv-assumerole{background:rgba(249,115,22,.2);color:#f97316;border:1px solid rgba(249,115,22,.4);}
.priv-standard{background:rgba(96,165,250,.12);color:#60a5fa;border:1px solid rgba(96,165,250,.3);}

/* ‚îÄ‚îÄ DETECTION PROBABILITY overlay on blast nodes ‚îÄ‚îÄ */
.node .detect-badge{position:absolute;top:-9px;right:4px;font-size:8px;font-family:'JetBrains Mono',monospace;font-weight:700;padding:1px 5px;border-radius:3px;pointer-events:none;z-index:25;}
.detect-low{background:rgba(239,68,68,.85);color:#fff;}
.detect-med{background:rgba(249,115,22,.85);color:#fff;}
.detect-high{background:rgba(52,211,153,.85);color:#000;}

/* ‚îÄ‚îÄ NODE PROPERTIES PANEL (extended) ‚îÄ‚îÄ */
.np-panel{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px;}
.np-title{font-size:10px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;}
.np-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.np-fg{display:flex;flex-direction:column;gap:3px;}
.np-lbl{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;}
.np-sel{width:100%;padding:3px 5px;background:var(--s3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:10px;cursor:pointer;outline:none;}
.np-sel:focus{border-color:var(--accent);}

/* ‚îÄ‚îÄ BLAST CONFIDENCE METER ‚îÄ‚îÄ */
.conf-bar-wrap{margin-top:6px;background:var(--s3);border-radius:3px;height:5px;overflow:hidden;}
.conf-bar{height:100%;border-radius:3px;transition:width .3s;}


/* ‚îÄ‚îÄ Trust Zone Swim Lanes ‚îÄ‚îÄ */
/* Full-height vertical lanes ‚Äî each zone gets its own X column band.
   All lanes share the same top/bottom so the column separation is immediately obvious.
   z-index:2 ‚Üí above canvas grid bg (0), below nodes (10) and SVG edges (5). */
.trust-zone-overlay{
  position:absolute;
  border-radius:10px;
  border-left:2px solid;
  border-right:2px solid;
  border-top:2px solid;
  border-bottom:2px solid;
  pointer-events:none;
  z-index:2;
  box-sizing:border-box;
}
.tz-internet{
  border-color:rgba(255,107,107,.5);
  background:linear-gradient(180deg, rgba(255,107,107,.09) 0%, rgba(255,107,107,.04) 100%);
}
.tz-dmz{
  border-color:rgba(255,140,0,.5);
  background:linear-gradient(180deg, rgba(255,140,0,.09) 0%, rgba(255,140,0,.04) 100%);
}
.tz-internal{
  border-color:rgba(96,165,250,.45);
  background:linear-gradient(180deg, rgba(96,165,250,.08) 0%, rgba(96,165,250,.03) 100%);
}
.tz-secure{
  border-color:rgba(52,211,153,.45);
  background:linear-gradient(180deg, rgba(52,211,153,.08) 0%, rgba(52,211,153,.03) 100%);
}

/* Zone label ‚Äî pinned to top-center of the swim lane header band */
.tz-label{
  position:absolute;
  top:7px;
  left:50%;
  transform:translateX(-50%);
  font-size:8px;
  font-weight:800;
  letter-spacing:1.4px;
  text-transform:uppercase;
  padding:3px 9px;
  border-radius:4px;
  font-family:'JetBrains Mono',monospace;
  white-space:nowrap;
  line-height:14px;
}
.tz-label-internet{
  background:rgba(255,107,107,.2);
  color:#ff6b6b;
  border:1px solid rgba(255,107,107,.5);
  box-shadow:0 0 8px rgba(255,107,107,.15);
}
.tz-label-dmz{
  background:rgba(255,140,0,.2);
  color:#ff8c00;
  border:1px solid rgba(255,140,0,.5);
  box-shadow:0 0 8px rgba(255,140,0,.15);
}
.tz-label-internal{
  background:rgba(96,165,250,.2);
  color:#60a5fa;
  border:1px solid rgba(96,165,250,.5);
  box-shadow:0 0 8px rgba(96,165,250,.15);
}
.tz-label-secure{
  background:rgba(52,211,153,.2);
  color:#34d399;
  border:1px solid rgba(52,211,153,.5);
  box-shadow:0 0 8px rgba(52,211,153,.15);
}

/* ‚îÄ‚îÄ Attack Path Highlighting ‚îÄ‚îÄ */
.node.atk-path-critical{box-shadow:0 0 0 2px #ef4444,0 0 20px rgba(239,68,68,.4)!important;border-color:#ef4444;animation:atk-pulse 1.5s ease-in-out infinite;}
.node.atk-path-high{box-shadow:0 0 0 2px #f97316,0 0 16px rgba(249,115,22,.35)!important;border-color:#f97316;}
.node.atk-path-entry{box-shadow:0 0 0 2.5px #ef4444,0 0 24px rgba(239,68,68,.5)!important;border-color:#ef4444;}
@keyframes atk-pulse{0%,100%{box-shadow:0 0 0 2px #ef4444,0 0 20px rgba(239,68,68,.4);}50%{box-shadow:0 0 0 3px #ef4444,0 0 32px rgba(239,68,68,.65);}}
.node.boundary-violation{outline:2px dashed #f97316;outline-offset:2px;}

/* Trust zone node header badges */
.tz-internet-node .node-hdr::after{content:'INTERNET';font-size:7px;color:#ff6b6b;font-family:'JetBrains Mono',monospace;font-weight:800;letter-spacing:.8px;margin-left:auto;opacity:.8;}
.tz-dmz-node .node-hdr::after{content:'DMZ';font-size:7px;color:#ff8c00;font-family:'JetBrains Mono',monospace;font-weight:800;letter-spacing:.8px;margin-left:auto;opacity:.8;}
.tz-internal-node .node-hdr::after{content:'INT';font-size:7px;color:#60a5fa;font-family:'JetBrains Mono',monospace;font-weight:800;letter-spacing:.8px;margin-left:auto;opacity:.8;}
.tz-secure-node .node-hdr::after{content:'SEC';font-size:7px;color:#34d399;font-family:'JetBrains Mono',monospace;font-weight:800;letter-spacing:.8px;margin-left:auto;opacity:.8;}

/* ‚îÄ‚îÄ Attack Path Panel ‚îÄ‚îÄ */
.ap-panel{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:7px;cursor:pointer;transition:border-color .15s;}
.ap-panel:hover{border-color:rgba(239,68,68,.5);}
.ap-header{display:flex;align-items:center;gap:7px;margin-bottom:6px;}
.ap-risk-badge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:3px;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
.ap-path-viz{display:flex;align-items:center;gap:4px;flex-wrap:wrap;margin-bottom:5px;}
.ap-node-chip{font-size:9px;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:3px;background:var(--s3);border:1px solid var(--border);}
.ap-node-chip.ap-entry{border-color:rgba(239,68,68,.5);color:#ef4444;}
.ap-node-chip.ap-target{border-color:rgba(239,68,68,.5);color:#ef4444;background:rgba(239,68,68,.08);}
.ap-arrow{font-size:10px;color:var(--text3);}
.ap-reason{font-size:10px;color:var(--text2);line-height:1.4;}
.ap-owasp{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--info);margin-top:3px;}

/* ‚îÄ‚îÄ Boundary Violation Card ‚îÄ‚îÄ */
.bv-card{background:var(--s2);border:1px solid rgba(249,115,22,.3);border-radius:8px;padding:10px;margin-bottom:7px;border-left:3px solid #f97316;}
.bv-flow{display:flex;align-items:center;gap:5px;margin-bottom:4px;font-size:10px;font-family:'JetBrains Mono',monospace;}
.bv-zone{padding:2px 6px;border-radius:3px;font-weight:700;font-size:9px;}

/* ‚îÄ‚îÄ Right Panel Mode Tabs ‚îÄ‚îÄ */
.mode-bar{display:flex;gap:3px;margin-bottom:10px;background:var(--s3);border-radius:6px;padding:3px;}
.mode-tab{flex:1;text-align:center;padding:4px 6px;border-radius:4px;font-size:10px;font-weight:700;cursor:pointer;color:var(--text3);transition:all .15s;}
.mode-tab.active{background:var(--accent);color:#000;}
</style>
</head>
<body>

<header>
  <div class="logo"><div class="logo-icon">üõ°</div>Threat<span>Canvas</span></div>
  <div class="step-tabs">
    <div class="step-tab active" onclick="goStep(1)" id="stab1"><span class="step-num">1</span> Scope</div>
    <div class="step-tab" onclick="goStep(2)" id="stab2"><span class="step-num">2</span> Threats / DFD</div>
    <div class="step-tab" onclick="goStep(3)" id="stab3"><span class="step-num">3</span> Countermeasures</div>
    <div class="step-tab" onclick="goStep(4)" id="stab4"><span class="step-num">4</span> Assess</div>
    <div class="step-tab" onclick="goStep(5)" id="stab5"><span class="step-num">5</span> Cloud Sync</div>
  </div>
  <div class="hdr-actions">
    <button class="btn btn-ghost btn-sm" onclick="loadExample()">Load Example</button>
    <div style="width:1px;height:16px;background:var(--border)"></div>
    <button class="btn btn-save btn-sm" onclick="saveProject()" title="Download full project as JSON">üíæ Save Project</button>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('loadFileInput').click()" title="Restore project from JSON">üìÇ Load Project</button>
    <input type="file" id="loadFileInput" accept=".json,application/json" style="display:none" onchange="loadProject(this)">
    <div style="width:1px;height:16px;background:var(--border)"></div>
    <button class="btn btn-primary btn-sm" onclick="exportReport()">‚¨á Export Report</button>
  </div>
</header>

<div class="main">

<!-- ‚îÄ‚îÄ‚îÄ STEP 1: SCOPE ‚îÄ‚îÄ‚îÄ -->
<div class="step-panel active" id="panel1">
<div class="scope-layout">
  <div class="scope-sidebar">
    <div style="padding:11px 14px;border-bottom:1px solid var(--border);font-size:10px;font-weight:800;letter-spacing:1.5px;color:var(--text3)">STEP 1 ‚Äî SCOPE</div>
    <div class="scope-nav-item anav" onclick="showSec('info',this)"><div class="scope-nav-num">1</div>Project Info</div>
    <div class="scope-nav-item" onclick="showSec('deps',this)"><div class="scope-nav-num">2</div>External Dependencies</div>
    <div class="scope-nav-item" onclick="showSec('entry',this)"><div class="scope-nav-num">3</div>Entry Points</div>
    <div class="scope-nav-item" onclick="showSec('exit',this)"><div class="scope-nav-num">4</div>Exit Points</div>
    <div class="scope-nav-item" onclick="showSec('assets',this)"><div class="scope-nav-num">5</div>Assets</div>
    <div class="scope-nav-item" onclick="showSec('trust',this)"><div class="scope-nav-num">6</div>Trust Levels</div>
    <div style="padding:12px;margin-top:auto;border-top:1px solid var(--border);">
      <button class="btn btn-primary" style="width:100%" onclick="goStep(2)">Next: Build DFD ‚Üí</button>
    </div>
  </div>
  <div class="scope-main">
    <!-- Project Info -->
    <div class="scope-section asec" id="sec-info">
      <div class="sec-card">
        <div class="sec-hdr"><div class="sec-title">üìã Threat Model Information</div></div>
        <div class="sec-body">
          <div class="frow">
            <div class="fg"><label class="lbl">Application Name</label><input class="inp" id="appName" placeholder="e.g. College Library Website"></div>
            <div class="fg"><label class="lbl">Version</label><input class="inp" id="appVersion" placeholder="e.g. 1.0"></div>
          </div>
          <div class="fg"><label class="lbl">Description</label><textarea class="inp" id="appDesc" placeholder="High-level description of the application and its purpose..."></textarea></div>
          <div class="frow">
            <div class="fg"><label class="lbl">Document Owner</label><input class="inp" id="docOwner" placeholder="e.g. David Lowry"></div>
            <div class="fg"><label class="lbl">Participants</label><input class="inp" id="docParticipants" placeholder="e.g. David Rook"></div>
          </div>
          <div class="frow">
            <div class="fg"><label class="lbl">Reviewer</label><input class="inp" id="docReviewer" placeholder="e.g. Eoin Keary"></div>
            <div class="fg"><label class="lbl">Date</label><input class="inp" id="docDate" type="date"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- External Dependencies -->
    <div class="scope-section" id="sec-deps">
      <div class="sec-card">
        <div class="sec-hdr"><div class="sec-title">üîó External Dependencies</div><span style="font-size:11px;color:var(--text2)">Items outside codebase that may pose threats</span></div>
        <div class="sec-body">
          <table class="dtable"><thead><tr><th>ID</th><th>Description</th><th></th></tr></thead><tbody id="depsTbody"></tbody></table>
          <button class="add-btn" onclick="addRow('deps')">+ Add External Dependency</button>
        </div>
      </div>
    </div>
    <!-- Entry Points -->
    <div class="scope-section" id="sec-entry">
      <div class="sec-card">
        <div class="sec-hdr"><div class="sec-title">üö™ Entry Points</div><span style="font-size:11px;color:var(--text2)">Where attackers interact with the system</span></div>
        <div class="sec-body">
          <table class="dtable"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Trust Levels</th><th></th></tr></thead><tbody id="entryTbody"></tbody></table>
          <button class="add-btn" onclick="addRow('entry')">+ Add Entry Point</button>
        </div>
      </div>
    </div>
    <!-- Exit Points -->
    <div class="scope-section" id="sec-exit">
      <div class="sec-card">
        <div class="sec-hdr"><div class="sec-title">üö™ Exit Points</div><span style="font-size:11px;color:var(--text2)">Where data leaves the system (XSS, info disclosure)</span></div>
        <div class="sec-body">
          <table class="dtable"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Risk</th><th></th></tr></thead><tbody id="exitTbody"></tbody></table>
          <button class="add-btn" onclick="addRow('exit')">+ Add Exit Point</button>
        </div>
      </div>
    </div>
    <!-- Assets -->
    <div class="scope-section" id="sec-assets">
      <div class="sec-card">
        <div class="sec-hdr"><div class="sec-title">üíé Assets</div><span style="font-size:11px;color:var(--text2)">Physical and abstract items worth protecting</span></div>
        <div class="sec-body">
          <table class="dtable"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Required Trust Levels</th><th></th></tr></thead><tbody id="assetsTbody"></tbody></table>
          <button class="add-btn" onclick="addRow('assets')">+ Add Asset</button>
        </div>
      </div>
    </div>
    <!-- Trust Levels -->
    <div class="scope-section" id="sec-trust">
      <div class="sec-card">
        <div class="sec-hdr"><div class="sec-title">üîë Trust Levels</div><span style="font-size:11px;color:var(--text2)">Access rights granted to external entities</span></div>
        <div class="sec-body">
          <table class="dtable"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th></th></tr></thead><tbody id="trustTbody"></tbody></table>
          <button class="add-btn" onclick="addRow('trust')">+ Add Trust Level</button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ STEP 2: THREATS / DFD ‚îÄ‚îÄ‚îÄ -->
<div class="step-panel" id="panel2">
<div class="threats-layout">
  <div class="palette">
    <div class="pal-sec"><div class="pal-lbl">External</div>
      <div class="pal-item" draggable="true" data-type="internet"><div class="pal-ico" style="background:rgba(255,107,107,.15)">üåê</div>Internet</div>
      <div class="pal-item" draggable="true" data-type="user"><div class="pal-ico" style="background:rgba(77,157,224,.15)">üë§</div>User</div>
      <div class="pal-item" draggable="true" data-type="attacker"><div class="pal-ico" style="background:rgba(255,68,68,.15)">‚ò†Ô∏è</div>Attacker</div>
    </div>
    <div class="pal-sec"><div class="pal-lbl">Network</div>
      <div class="pal-item" draggable="true" data-type="firewall"><div class="pal-ico" style="background:rgba(255,140,0,.15)">üî•</div>Firewall</div>
      <div class="pal-item" draggable="true" data-type="loadbalancer"><div class="pal-ico" style="background:rgba(245,158,11,.15)">‚öñÔ∏è</div>Load Balancer</div>
      <div class="pal-item" draggable="true" data-type="vpn"><div class="pal-ico" style="background:rgba(77,157,224,.15)">üîí</div>VPN</div>
      <div class="pal-item" draggable="true" data-type="cdn"><div class="pal-ico" style="background:rgba(245,158,11,.15)">‚òÅÔ∏è</div>CDN</div>
    </div>
    <div class="pal-sec"><div class="pal-lbl">Compute</div>
      <div class="pal-item" draggable="true" data-type="webserver"><div class="pal-ico" style="background:rgba(0,102,255,.15)">üñ•</div>Web Server</div>
      <div class="pal-item" draggable="true" data-type="api"><div class="pal-ico" style="background:rgba(245,158,11,.15)">‚ö°</div>API Server</div>
      <div class="pal-item" draggable="true" data-type="microservice"><div class="pal-ico" style="background:rgba(77,157,224,.15)">üîß</div>Microservice</div>
      <div class="pal-item" draggable="true" data-type="lambda"><div class="pal-ico" style="background:rgba(255,140,0,.15)">Œª</div>Serverless</div>
    </div>
    <div class="pal-sec"><div class="pal-lbl">Data</div>
      <div class="pal-item" draggable="true" data-type="database"><div class="pal-ico" style="background:rgba(255,107,107,.15)">üóÑ</div>Database</div>
      <div class="pal-item" draggable="true" data-type="cache"><div class="pal-ico" style="background:rgba(255,217,61,.15)">‚ö°</div>Cache</div>
      <div class="pal-item" draggable="true" data-type="storage"><div class="pal-ico" style="background:rgba(245,158,11,.15)">üì¶</div>Storage</div>
      <div class="pal-item" draggable="true" data-type="messagequeue"><div class="pal-ico" style="background:rgba(77,157,224,.15)">üì®</div>Msg Queue</div>
    </div>
    <div class="pal-sec"><div class="pal-lbl">Security</div>
      <div class="pal-item" draggable="true" data-type="waf"><div class="pal-ico" style="background:rgba(255,140,0,.15)">üõ°</div>WAF</div>
      <div class="pal-item" draggable="true" data-type="idp"><div class="pal-ico" style="background:rgba(245,158,11,.15)">üîë</div>Identity Provider</div>
      <div class="pal-item" draggable="true" data-type="siem"><div class="pal-ico" style="background:rgba(255,68,68,.15)">üëÅ</div>SIEM</div>
    </div>
  </div>
  <div class="canvas-wrap" id="canvasWrap">
    <!-- #viewport is the single transform target for zoom + pan.
         Both the SVG edge layer and the node layer live inside it
         so all coordinates stay in the same space regardless of zoom. -->
    <div id="viewport">
      <svg id="svgLayer"></svg>
      <div id="canvas"></div>
    </div>

    <!-- Empty-hint lives outside #viewport so it always centres
         in the visible canvas-wrap area, not the 4000px virtual canvas -->
    <div class="empty-hint" id="emptyHint">
      <div style="font-size:42px;margin-bottom:14px;opacity:.2">üèó</div>
      <h3>Build your Data Flow Diagram</h3>
      <p>Drag components from the left ‚Ä¢ Click ports to connect ‚Ä¢ Right-click an edge to edit/delete ‚Ä¢ Press <kbd style="background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:11px">A</kbd> to analyze</p>
      <button class="btn btn-primary" style="margin-top:16px;font-size:12px" onclick="loadExample()">‚ñ∂ Load Example Architecture</button>
    </div>

    <!-- Zoom controls ‚Äî bottom-right corner, always on top -->
    <div class="zoom-bar" id="zoomBar">
      <button class="zoom-btn" onclick="zoomStep(-1)" title="Zoom out (-)">‚àí</button>
      <span class="zoom-pct" id="zoomPct">100%</span>
      <button class="zoom-btn" onclick="zoomStep(+1)" title="Zoom in (+)">+</button>
      <div class="zoom-sep"></div>
      <button class="zoom-btn" onclick="zoomFit()" title="Fit all nodes in view">‚ä°</button>
      <button class="zoom-btn" onclick="zoomReset()" title="Reset to 100%">1:1</button>
    </div>
  </div>
  <div class="rpanel" id="rpanel">
    <!-- ‚îÄ‚îÄ Mode toggle ‚îÄ‚îÄ -->
    <div style="display:flex;gap:6px;margin-bottom:12px">
      <button class="btn-mode" id="modeAnalyze" onclick="setMode('analyze')" style="flex:1">üîç Analyze</button>
      <button class="btn-mode" id="modeBlast" onclick="setMode('blast')" style="flex:1">üí• Blast Radius</button>
    </div>

    <!-- ‚îÄ‚îÄ Component Threat Profile (shown when node selected) ‚îÄ‚îÄ -->
    <div id="ctpSection" style="display:none"></div>

    <!-- ‚îÄ‚îÄ Edge Editor (shown when edge clicked) ‚îÄ‚îÄ -->
    <div id="edgeEditorSection" style="display:none"></div>

    <!-- ‚îÄ‚îÄ Blast radius info ‚îÄ‚îÄ -->
    <div id="blastInfo" style="display:none">
      <div class="blast-bar">
        <span class="blast-label">üí• BLAST RADIUS</span>
        <span id="blastCount" style="color:var(--text2)">Click a node to simulate compromise</span>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Analyze mode content ‚îÄ‚îÄ -->
    <div id="analyzeContent">
      <!-- Mode tabs: Threats vs Attack Paths -->
      <div class="mode-bar">
        <div class="mode-tab active" id="rpTab-threats" onclick="switchRpTab('threats')">üîç Threats</div>
        <div class="mode-tab" id="rpTab-paths" onclick="switchRpTab('paths')">‚öîÔ∏è Attack Paths <span id="apTabBadge" style="background:rgba(239,68,68,.2);color:#ef4444;border-radius:10px;padding:0 5px;font-size:9px;font-family:'JetBrains Mono',monospace">0</span></div>
      </div>

      <!-- Threats sub-panel -->
      <div id="rpPanel-threats">
        <div id="detectedThreats" style="margin-bottom:10px">
          <div style="text-align:center;color:var(--text3);padding:24px 0;font-size:12px">Build DFD then press Analyze</div>
        </div>
      </div>

      <!-- Attack Paths sub-panel -->
      <div id="rpPanel-paths" style="display:none">
        <div id="attackPathsContainer">
          <div style="text-align:center;color:var(--text3);padding:24px 0;font-size:12px">Run analysis to detect attack paths</div>
        </div>
        <button class="btn btn-ghost" style="width:100%;font-size:11px;margin-top:8px" onclick="clearAttackPathHighlights()">‚úï Clear Highlights</button>
      </div>

      <button class="btn btn-primary" style="width:100%;margin-bottom:7px;margin-top:6px" onclick="runAnalysis()">‚ñ∂ Analyze Architecture</button>
      <button class="btn btn-ghost" style="width:100%;font-size:11px;margin-bottom:14px" onclick="clearCanvas()">Clear Canvas</button>
      <div class="rp-title">‚öîÔ∏è Attack Simulation</div>
      <button class="btn btn-ghost" style="width:100%;font-size:11px;margin-bottom:7px" onclick="toggleSim()" id="simToggleBtn">‚ñ∂ Start Traffic Sim</button>
      <div class="atk-btn" onclick="runAttack('sqli')">üíâ SQL Injection</div>
      <div class="atk-btn" onclick="runAttack('ddos')">üí• DDoS Flood</div>
      <div class="atk-btn" onclick="runAttack('lateral')">‚ÜîÔ∏è Lateral Movement</div>
      <div class="atk-btn" onclick="runAttack('exfil')">üì§ Data Exfiltration</div>
    </div>

    <!-- ‚îÄ‚îÄ Blast mode content ‚îÄ‚îÄ -->
    <div id="blastContent" style="display:none">
      <div style="font-size:11px;color:var(--text2);line-height:1.8;margin-bottom:12px">
        <strong style="color:var(--text)">Node colors:</strong><br>
        <span style="color:#ef4444">‚ñ†</span> Source (compromised)<br>
        <span style="color:#f97316">‚ñ†</span> Reachable (1 hop)<br>
        <span style="color:#facc15">‚ñ†</span> Reachable (2+ hops)<br>
        <span style="color:#a78bfa">‚ñ†</span> Reachable via priv-esc<br>
        <span style="color:var(--text3)">‚ñ†</span> Blocked / unreachable<br><br>
        <strong style="color:var(--text)">Edge colors:</strong><br>
        <span style="color:#ef4444">‚Äî‚Äî</span> Traversed blast path<br>
        <span style="color:#34d399">- -</span> üõ° Blocked by auth+TLS<br>
        <span style="color:#34d399">- -</span> üîë Credential not scoped<br>
        <span style="color:#374151">¬∑¬∑</span> üöß No network route<br>
        <span style="color:#a78bfa">‚Äî‚Äî</span> ‚¨ÜÔ∏è Privilege escalation<br><br>
        <strong style="color:var(--text)">Detection badges:</strong><br>
        <span style="background:#ef4444;color:#fff;padding:1px 4px;border-radius:2px;font-size:9px">low%</span> Low detection risk<br>
        <span style="background:#f97316;color:#fff;padding:1px 4px;border-radius:2px;font-size:9px">med%</span> Moderate risk<br>
        <span style="background:#34d399;color:#000;padding:1px 4px;border-radius:2px;font-size:9px">high%</span> Likely detected<br><br>
        <span style="color:var(--text3);font-size:10px;line-height:1.6">
          <strong style="color:var(--text2)">6 factors modeled:</strong><br>
          1. Auth strength + TLS version<br>
          2. Credential scope (shared vs vault)<br>
          3. Network zone + route existence<br>
          4. Compromise impact level<br>
          5. Detection probability (SIEM/WAF)<br>
          6. IAM privilege escalation paths
        </span>
      </div>
      <button class="btn btn-ghost" style="width:100%;font-size:11px" onclick="clearBlast()">‚úï Clear Blast Radius</button>

      <!-- ‚ö†Ô∏è Professional disclaimer ‚Äî detection % are model estimates, not measured values -->
      <div class="blast-disclaimer">
        <div class="blast-disclaimer-icon">‚ö†Ô∏è</div>
        <div class="blast-disclaimer-text">
          <strong>Design-Time Model Only</strong><br>
          Detection probabilities and reachability scores model <em>theoretical</em> attack paths based on your architecture configuration. They are <strong>not</strong> measured against live infrastructure.<br><br>
          This is not a substitute for penetration testing or attack simulation tools (e.g. MITRE ATT&CK, Atomic Red Team, or professional red-team engagements).
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ STEP 3: COUNTERMEASURES ‚îÄ‚îÄ‚îÄ -->
<div class="step-panel" id="panel3">
<div class="cm-layout">
  <div class="cm-main">
    <div style="font-size:14px;font-weight:800;margin-bottom:14px">STRIDE Threat Categories <span style="font-size:11px;font-weight:400;color:var(--text2)">‚Äî Click to filter</span></div>
    <div class="stride-grid" id="strideGrid">
      <div class="stride-card" onclick="filterSTRIDE('S',this)"><div class="stride-ico">üé≠</div><div class="stride-name">Spoofing</div><div class="stride-desc">Identity / credential abuse</div><div class="stride-cnt" id="cS" style="color:#9b59b6">0</div></div>
      <div class="stride-card" onclick="filterSTRIDE('T',this)"><div class="stride-ico">‚úèÔ∏è</div><div class="stride-name">Tampering</div><div class="stride-desc">Malicious data modification</div><div class="stride-cnt" id="cT" style="color:#e67e22">0</div></div>
      <div class="stride-card" onclick="filterSTRIDE('R',this)"><div class="stride-ico">üö´</div><div class="stride-name">Repudiation</div><div class="stride-desc">Untraceable operations</div><div class="stride-cnt" id="cR" style="color:#3498db">0</div></div>
      <div class="stride-card" onclick="filterSTRIDE('I',this)"><div class="stride-ico">üëÅ</div><div class="stride-name">Info Disclosure</div><div class="stride-desc">Unauthorized data access</div><div class="stride-cnt" id="cI" style="color:#e74c3c">0</div></div>
      <div class="stride-card" onclick="filterSTRIDE('D',this)"><div class="stride-ico">üí•</div><div class="stride-name">Denial of Service</div><div class="stride-desc">Availability disruption</div><div class="stride-cnt" id="cD" style="color:#2ecc71">0</div></div>
      <div class="stride-card" onclick="filterSTRIDE('E',this)"><div class="stride-ico">‚¨ÜÔ∏è</div><div class="stride-name">Elevation of Privilege</div><div class="stride-desc">Unauthorized privilege gain</div><div class="stride-cnt" id="cE" style="color:#ff6b6b">0</div></div>
    </div>
    <div class="sec-card">
      <div class="sec-card-hdr"><div class="sec-card-title">üìã Threat Countermeasure Register</div><span style="font-size:11px;color:var(--text2)">Set Accept / Eliminate / Mitigate / Transfer per threat</span></div>
      <table class="dtable" id="cmTable">
        <thead><tr><th>ID</th><th>Threat</th><th>STRIDE</th><th>Severity</th><th>Likelihood</th><th>Impact</th><th>Risk</th><th>Response</th><th>Status</th></tr></thead>
        <tbody id="cmTbody"><tr><td colspan="9" style="text-align:center;color:var(--text3);padding:28px">Run analysis in Step 2 first</td></tr></tbody>
      </table>
    </div>
  </div>
  <div class="cm-sidebar">
    <div class="rp-title">üìñ STRIDE ‚Üí Controls</div>
    <div style="font-size:11px;line-height:1.7;color:var(--text2)">
      <div style="margin-bottom:11px"><strong style="color:#9b59b6">üé≠ Spoofing ‚Üí Authentication</strong><br>‚Ä¢ Strong authentication<br>‚Ä¢ Protect secret data<br>‚Ä¢ Don't store secrets</div>
      <div style="margin-bottom:11px"><strong style="color:#e67e22">‚úèÔ∏è Tampering ‚Üí Integrity</strong><br>‚Ä¢ Authorization<br>‚Ä¢ Hashes / MACs<br>‚Ä¢ Digital signatures<br>‚Ä¢ Tamper-resistant protocols</div>
      <div style="margin-bottom:11px"><strong style="color:#3498db">üö´ Repudiation ‚Üí Non-Repudiation</strong><br>‚Ä¢ Digital signatures<br>‚Ä¢ Timestamps<br>‚Ä¢ Audit trails</div>
      <div style="margin-bottom:11px"><strong style="color:#e74c3c">üëÅ Info Disclosure ‚Üí Confidentiality</strong><br>‚Ä¢ Authorization<br>‚Ä¢ Privacy-enhanced protocols<br>‚Ä¢ Encryption<br>‚Ä¢ Don't store secrets</div>
      <div style="margin-bottom:11px"><strong style="color:#2ecc71">üí• DoS ‚Üí Availability</strong><br>‚Ä¢ Authentication + AuthZ<br>‚Ä¢ Filtering & throttling<br>‚Ä¢ Quality of service</div>
      <div style="margin-bottom:11px"><strong style="color:#ff6b6b">‚¨ÜÔ∏è EoP ‚Üí Authorization</strong><br>‚Ä¢ Least privilege<br>‚Ä¢ RBAC enforcement<br>‚Ä¢ Privilege separation</div>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:6px">
      <div class="rp-title">üìä Qualitative Risk Model</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7">
        <span style="color:var(--crit)">Critical</span> = High √ó High<br>
        <span style="color:var(--high)">High</span> = High √ó Med<br>
        <span style="color:var(--med)">Medium</span> = Med √ó Med<br>
        <span style="color:var(--low)">Low</span> = Low √ó Low
      </div>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:10px">
      <div class="rp-title">üõ° Response Options</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.8">
        <strong style="color:var(--text)">Accept</strong> ‚Äî Business impact acceptable, documented<br>
        <strong style="color:var(--text)">Eliminate</strong> ‚Äî Remove vulnerable component<br>
        <strong style="color:var(--text)">Mitigate</strong> ‚Äî Add controls to reduce risk<br>
        <strong style="color:var(--text)">Transfer</strong> ‚Äî Insurer or customer bears risk
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ STEP 4: ASSESS ‚îÄ‚îÄ‚îÄ -->
<div class="step-panel" id="panel4">
<div class="assess-layout">
<div class="assess-main">
  <div style="font-size:14px;font-weight:800;margin-bottom:14px">Step 4 ‚Äî Assess Your Work</div>
  <div class="assess-grid" id="assessGrid">
    <div class="assess-card"><div class="assess-num" id="aN" style="color:var(--info)">0</div><div class="assess-lbl">DFD Components</div></div>
    <div class="assess-card"><div class="assess-num" id="aE" style="color:var(--accent)">0</div><div class="assess-lbl">Data Flows</div></div>
    <div class="assess-card"><div class="assess-num" id="aT" style="color:var(--crit)">0</div><div class="assess-lbl">Threats Found</div></div>
    <div class="assess-card"><div class="assess-num" id="aC" style="color:var(--crit)">0</div><div class="assess-lbl">Critical</div></div>
    <div class="assess-card"><div class="assess-num" id="aH" style="color:var(--high)">0</div><div class="assess-lbl">High</div></div>
    <div class="assess-card"><div class="assess-num" id="aM" style="color:var(--med)">0</div><div class="assess-lbl">Medium</div></div>
    <div class="assess-card"><div class="assess-num" id="aMit" style="color:var(--accent)">0</div><div class="assess-lbl">Mitigated</div></div>
    <div class="assess-card"><div class="assess-num" id="aPar" style="color:var(--med)">0</div><div class="assess-lbl">Partial</div></div>
    <div class="assess-card"><div class="assess-num" id="aUnm" style="color:var(--crit)">0</div><div class="assess-lbl">Unmitigated</div></div>
  </div>
  <div style="font-size:13px;font-weight:800;margin-bottom:10px">‚úÖ OWASP Completeness Checklist</div>
  <div class="chk-item"><div class="chk-ico">üèó</div><div><div class="chk-text">Data Flow Diagram</div><div class="chk-sub">Components and data flows drawn on canvas</div></div><div class="chk-status chk-fail" id="kDfd">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">üìã</div><div><div class="chk-text">Project Scoped</div><div class="chk-sub">App name, description, owner defined</div></div><div class="chk-status chk-fail" id="kScope">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">üö™</div><div><div class="chk-text">Entry / Exit Points</div><div class="chk-sub">Attack surface documented</div></div><div class="chk-status chk-fail" id="kEntry">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">üîë</div><div><div class="chk-text">Trust Levels Defined</div><div class="chk-sub">Access rights for external entities specified</div></div><div class="chk-status chk-fail" id="kTrust">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">üíé</div><div><div class="chk-text">Assets Identified</div><div class="chk-sub">Physical and abstract assets inventoried</div></div><div class="chk-status chk-fail" id="kAssets">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">‚ö†Ô∏è</div><div><div class="chk-text">Threat List</div><div class="chk-sub">STRIDE threats identified and documented</div></div><div class="chk-status chk-fail" id="kThreats">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">üõ°</div><div><div class="chk-text">Countermeasure Register</div><div class="chk-sub">All threats have a mitigation response assigned</div></div><div class="chk-status chk-fail" id="kControls">‚úó Missing</div></div>
  <div class="chk-item"><div class="chk-ico">üìä</div><div><div class="chk-text">Risk Ranked</div><div class="chk-sub">Threats ranked by likelihood √ó impact (qualitative)</div></div><div class="chk-status chk-fail" id="kRisk">‚úó Missing</div></div>
  <div style="display:flex;gap:10px;margin-top:14px">
    <button class="btn btn-primary" onclick="refreshAssess()">‚Üª Refresh</button>
    <button class="btn btn-primary" onclick="openExecSummary()" style="background:#1d4ed8;flex:1">üìã Generate Executive Summary</button>
    <button class="btn btn-ghost" onclick="exportReport()">‚¨á Export Full Report</button>
  </div>
</div>
</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ EXECUTIVE SUMMARY MODAL ‚îÄ‚îÄ‚îÄ -->
<div class="overlay" id="execModal" onclick="if(event.target===this)closeExecSummary()">
  <div class="exec-modal" id="execModalContent">
    <!-- content injected by openExecSummary() -->
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ STEP 5: CLOUD SYNC ‚îÄ‚îÄ‚îÄ -->
<!-- Bug fix: panel5 was missing ‚Äî goStep(5) would blank the entire app since -->
<!-- querySelectorAll('.step-panel')[4] doesn't exist. Panel added as placeholder. -->
<div class="step-panel" id="panel5">
<div style="flex:1;overflow-y:auto;padding:28px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:0">
  <div style="max-width:520px;width:100%">
    <div style="font-size:14px;font-weight:800;margin-bottom:6px">‚ë§ Cloud Sync</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:24px">Share and sync your threat model with your team.</div>

    <!-- Coming soon notice -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px 22px;margin-bottom:18px">
      <div style="font-size:13px;font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:8px">
        <span style="background:rgba(245,158,11,.15);color:var(--accent);font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700;letter-spacing:.5px">COMING SOON</span>
        Real-time collaboration
      </div>
      <div style="font-size:12px;color:var(--text2);line-height:1.7">
        Cloud sync will let your team co-edit threat models in real time, leave review comments, and track model version history ‚Äî without leaving ThreatCanvas.
      </div>
    </div>

    <!-- Available now: local save/load -->
    <div style="font-size:12px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px">Available Now ‚Äî Local File Sync</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:18px">
      <div style="padding:14px 16px;border-bottom:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:4px">üíæ Save Project</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:10px">Download your complete threat model as a portable JSON file. Share it with teammates who can load it directly into ThreatCanvas.</div>
        <button class="btn btn-primary btn-sm" onclick="saveProject()">‚¨á Download .json</button>
      </div>
      <div style="padding:14px 16px">
        <div style="font-size:12px;font-weight:700;margin-bottom:4px">üìÇ Load Project</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:10px">Open a previously saved ThreatCanvas JSON file. Your scope, DFD topology, and countermeasure decisions will be restored. Threats are always recomputed fresh.</div>
        <label class="btn btn-ghost btn-sm" style="cursor:pointer">
          ‚¨Ü Open .json
          <input type="file" accept=".json" onchange="loadProject(this)" style="display:none">
        </label>
      </div>
    </div>

    <!-- Export -->
    <div style="font-size:12px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px">Export</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px">
      <div style="font-size:12px;font-weight:700;margin-bottom:4px">üìã Export Threat Report</div>
      <div style="font-size:11px;color:var(--text2);margin-bottom:10px">Generate a standalone HTML report containing your full threat register, risk ratings, and countermeasure decisions ‚Äî ready to share with stakeholders.</div>
      <button class="btn btn-ghost btn-sm" onclick="exportReport()">‚¨á Export HTML Report</button>
    </div>
  </div>
</div>
</div>

</div><!-- /main -->

<!-- SIM BAR -->
<div class="sim-bar" id="simBar" style="display:none">
  <div class="sim-dot" id="simDot"></div>
  <span id="simLbl" style="color:var(--text3)">IDLE</span>
  <div class="tb-sep"></div>
  <span>Packets: <span class="sv" id="pktCnt">0</span></span>
  <span>Attacks triggered: <span class="sv" style="color:var(--crit)" id="trigCnt">0</span></span>
  <div style="margin-left:auto;font-size:11px;color:var(--text2)">DEL = delete selected node ‚Ä¢ A = analyze ‚Ä¢ Click edge label = edit/delete connection</div>
</div>
<div class="toolbar" id="mainToolbar">
  <span>Step 1: Scope ‚Üí Step 2: DFD + Threats ‚Üí Step 3: Countermeasures ‚Üí Step 4: Assess</span>
  <div class="tb-sep"></div>
  <span id="statusBar" style="color:var(--text3)">No analysis run yet</span>
</div>

<!-- MODAL -->
<div class="overlay" id="connModal">
  <div class="modal">
    <div class="modal-title">üîó Configure Data Flow</div>
    <div class="frow">
      <div class="fg"><label class="lbl">Protocol</label>
        <select class="inp" id="cp"><option>HTTPS</option><option>HTTP</option><option>TCP</option><option>UDP</option><option>gRPC</option><option>WebSocket</option><option>AMQP</option><option>SQL</option><option>Redis</option><option>S3</option></select>
      </div>
      <div class="fg"><label class="lbl">Data Classification</label>
        <select class="inp" id="cd"><option>Public</option><option>Internal</option><option>Confidential</option><option>Restricted</option><option>PII</option><option>PHI</option><option>PCI</option></select>
      </div>
    </div>
    <div class="frow">
      <div class="fg"><label class="lbl">Authentication</label>
        <select class="inp" id="ca"><option>None</option><option>API Key</option><option>JWT</option><option>OAuth2</option><option>mTLS</option><option>IAM Role</option><option>Basic Auth</option></select>
      </div>
      <div class="fg"><label class="lbl">Encryption</label>
        <select class="inp" id="ce">
          <option>TLS 1.3</option>
          <option>TLS 1.2 (strong)</option>
          <option>TLS 1.2 (weak ciphers)</option>
          <option>TLS 1.0/1.1</option>
          <option>None</option>
        </select>
      </div>
    </div>
    <div class="frow">
      <div class="fg"><label class="lbl">Credential Scope</label>
        <select class="inp" id="ccs" title="Who owns the credential for this connection?">
          <option value="shared">Shared ‚Äî any upstream node has it</option>
          <option value="service-bound">Service-Bound ‚Äî source service only</option>
          <option value="vault">Vault-Managed ‚Äî requires secret retrieval</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Network Route</label>
        <select class="inp" id="cnr" title="Does a network-layer route exist between these zones?">
          <option value="direct">Direct Route</option>
          <option value="vpc-peering">VPC Peering</option>
          <option value="none">No Route (zone-isolated)</option>
        </select>
      </div>
    </div>
    <div class="fg"><label class="lbl">Trust Boundary Crossed?</label>
      <select class="inp" id="ctb"><option>No</option><option>Yes ‚Äî Internet to DMZ</option><option>Yes ‚Äî DMZ to Internal</option><option>Yes ‚Äî Internal to Restricted</option></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="cancelConn()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmConn()">Add Data Flow</button>
    </div>
  </div>
</div>

<script>
/**
 * ThreatCanvas ‚Äî OWASP Threat Modeler
 * =====================================
 * A single-file, self-contained threat modeling tool implementing:
 *   - STRIDE threat classification (Spoofing, Tampering, Repudiation,
 *     Info Disclosure, Denial of Service, Elevation of Privilege)
 *   - 4-step workflow: Scope ‚Üí DFD + Threats ‚Üí Countermeasures ‚Üí Assessment
 *   - Blast Radius simulation: 6-factor theoretical attack path model
 *     (NOT a substitute for live penetration testing or attack simulation)
 *   - Traffic simulation and attack pattern visualization
 *   - JSON save/load for project persistence
 *
 * Architecture:
 *   - All state lives in the `S` singleton (nodes, edges, threats, cmRows)
 *   - `DEFS` maps node types ‚Üí visual/security defaults
 *   - `COMPONENT_THREATS` maps node types ‚Üí STRIDE threat rules
 *   - Blast radius uses BFS with 6 security factors (see runBlast())
 *   - No external runtime dependencies ‚Äî pure HTML/CSS/JS
 *
 * File sections (use Ctrl+F to jump):
 *   STATE            ‚Äî central app state object
 *   STEP NAV         ‚Äî tab switching & wizard navigation
 *   TABLE ROWS       ‚Äî scope table CRUD helpers
 *   COMPONENT DEFS   ‚Äî node type definitions (DEFS)
 *   COMPONENT THREATS ‚Äî per-type STRIDE rule library
 *   APP MODE         ‚Äî analyze vs blast-radius mode toggle
 *   BLAST RADIUS     ‚Äî 6-factor attack path BFS simulation
 *   EDGE EDITOR      ‚Äî edge property inspector
 *   NODES            ‚Äî node creation, drag, selection
 *   CONNECTIONS      ‚Äî port-based edge drawing
 *   REDRAW           ‚Äî SVG edge rendering
 *   ANALYSIS         ‚Äî STRIDE threat detection engine
 *   COUNTERMEASURES  ‚Äî threat register rendering
 *   ASSESSMENT       ‚Äî checklist scoring
 *   SIMULATION       ‚Äî traffic + attack visualization
 *   IMPORT/EXPORT    ‚Äî JSON save, load, report generation
 */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// Central singleton holding all mutable application state.
// Passed by reference; mutated in-place throughout the app.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  nodes:    {},   // { [nodeId]: NodeObject } ‚Äî all DFD nodes on canvas
  edges:    [],   // EdgeObject[] ‚Äî directed data-flow connections
  sel:      null, // currently selected node ID (or null)
  connecting: null, // port element being dragged for a new edge
  pendConn: null, // { from: nodeId } ‚Äî pending connection awaiting confirmation
  nextId:   1,    // auto-increment counter for generating unique IDs
  simRunning: false, // is traffic simulation active?
  simInt:   null, // setInterval handle for simulation tick
  pkt:      0,    // simulation packet counter
  trig:     0,    // simulation attack trigger counter
  threats:  [],   // ThreatObject[] ‚Äî results of last runAnalysis() call
  cmRows:   {},   // { [threatId]: { response, status } } ‚Äî countermeasure decisions
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZOOM & PAN ENGINE
// All canvas content lives inside #viewport which receives a
// CSS transform: scale(vpZ) translate(vpX, vpY).
// Node coordinates (nd.x, nd.y) are always in canvas-space px.
// Screen-to-canvas: canvasX = (screenX - vpX) / vpZ
// Canvas-to-screen: screenX = canvasX * vpZ + vpX
//
// Zoom steps:  50 ‚Üí 67 ‚Üí 80 ‚Üí 90 ‚Üí 100 ‚Üí 110 ‚Üí 125 ‚Üí 150 ‚Üí 175 ‚Üí 200%
// Middle-click + drag = pan  |  Ctrl+wheel = zoom  |  Scroll = pan
// Keyboard: Ctrl+= zoom in, Ctrl+- zoom out, Ctrl+0 reset, Ctrl+Shift+F fit
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ZOOM_STEPS=[0.5,0.67,0.8,0.9,1.0,1.1,1.25,1.5,1.75,2.0];
let vpZ=1.0;   // current zoom scale (1.0 = 100%)
// Debounced trust-zone overlay refresh (avoids thrashing DOM on every drag frame)
let _tzTimer=0;
function _debounceTZOverlay(){clearTimeout(_tzTimer);_tzTimer=setTimeout(renderTrustZoneOverlays,60);}
let vpX=0;     // viewport pan X offset in screen-px
let vpY=0;     // viewport pan Y offset in screen-px

function _applyViewport(){
  const vp=document.getElementById('viewport');
  if(!vp)return;
  vp.style.transform=`translate(${vpX}px,${vpY}px) scale(${vpZ})`;
  document.getElementById('zoomPct').textContent=Math.round(vpZ*100)+'%';
}

// Step zoom in (+1) or out (-1) centered on the canvas midpoint
function zoomStep(dir){
  const idx=ZOOM_STEPS.findIndex(z=>Math.abs(z-vpZ)<0.01);
  const cur=idx<0?4:idx;
  const next=Math.max(0,Math.min(ZOOM_STEPS.length-1,cur+dir));
  _zoomAround(ZOOM_STEPS[next],_canvasMid());
}

// Zoom toward a specific {x,y} screen point (used by wheel zoom)
function _zoomAround(newZ,pivot){
  // Keep the pivot point stationary in screen space
  vpX=pivot.x-(pivot.x-vpX)*(newZ/vpZ);
  vpY=pivot.y-(pivot.y-vpY)*(newZ/vpZ);
  vpZ=newZ;
  _applyViewport();
}

function _canvasMid(){
  const cw=document.getElementById('canvasWrap');
  if(!cw)return{x:0,y:0};
  const r=cw.getBoundingClientRect();
  return{x:r.width/2,y:r.height/2};
}

// Fit all nodes in view with 40px padding
function zoomFit(){
  const nodes=Object.values(S.nodes);
  if(!nodes.length)return;
  const cw=document.getElementById('canvasWrap');
  const r=cw.getBoundingClientRect();
  // Find bounding box in canvas-space
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  nodes.forEach(nd=>{
    const el=document.getElementById(nd.id);
    // Use actual dimensions; if offsetWidth is 0 (not yet painted) use generous fallback
    const w=el&&el.offsetWidth>0?el.offsetWidth:160;
    const h=el&&el.offsetHeight>0?el.offsetHeight:75;
    minX=Math.min(minX,nd.x);minY=Math.min(minY,nd.y);
    maxX=Math.max(maxX,nd.x+w);maxY=Math.max(maxY,nd.y+h);
  });
  const PAD=40;
  const scaleX=(r.width-PAD*2)/(maxX-minX);
  const scaleY=(r.height-PAD*2)/(maxY-minY);
  const z=Math.min(scaleX,scaleY,2.0);  // cap at 200%
  // Snap to nearest zoom step for clean display
  const snapped=ZOOM_STEPS.reduce((a,b)=>Math.abs(b-z)<Math.abs(a-z)?b:a);
  vpZ=snapped;
  vpX=PAD-minX*vpZ+(r.width-PAD*2-(maxX-minX)*vpZ)/2;
  vpY=PAD-minY*vpZ+(r.height-PAD*2-(maxY-minY)*vpZ)/2;
  _applyViewport();
}

// Reset to 100% with a small top-left offset so nodes near (0,0) are visible
function zoomReset(){
  vpZ=1.0;vpX=16;vpY=16;
  _applyViewport();
}

// Wire up mouse-wheel zoom (Ctrl+wheel) and trackpad pan (scroll)
(function(){
  // Initialized after DOM is ready ‚Äî use event delegation on canvasWrap
  document.addEventListener('DOMContentLoaded',()=>{
    const cw=document.getElementById('canvasWrap');
    if(!cw)return;

    // Ctrl+wheel = zoom, plain scroll = pan
    cw.addEventListener('wheel',e=>{
      e.preventDefault();
      if(e.ctrlKey||e.metaKey){
        // Pinch-to-zoom or Ctrl+scroll
        const delta=e.deltaY>0?-1:1;
        const cwr=cw.getBoundingClientRect();
        const pivot={x:e.clientX-cwr.left,y:e.clientY-cwr.top};
        const idx=ZOOM_STEPS.findIndex(z=>Math.abs(z-vpZ)<0.01);
        const cur=idx<0?4:idx;
        const next=Math.max(0,Math.min(ZOOM_STEPS.length-1,cur+delta));
        _zoomAround(ZOOM_STEPS[next],pivot);
      } else {
        // Plain scroll = pan
        vpX-=e.deltaX;vpY-=e.deltaY;
        _applyViewport();
      }
    },{passive:false});

    // Middle-mouse-button drag = pan
    let panActive=false,panSX=0,panSY=0,panOX=0,panOY=0;
    cw.addEventListener('mousedown',e=>{
      if(e.button===1){e.preventDefault();panActive=true;panSX=e.clientX;panSY=e.clientY;panOX=vpX;panOY=vpY;}
    });
    document.addEventListener('mousemove',e=>{
      if(!panActive)return;
      vpX=panOX+(e.clientX-panSX);vpY=panOY+(e.clientY-panSY);
      _applyViewport();
    });
    document.addEventListener('mouseup',e=>{if(e.button===1)panActive=false;});
  });
})();

// Keyboard shortcuts for zoom
document.addEventListener('keydown',e=>{
  if(e.ctrlKey||e.metaKey){
    if(e.key==='='||e.key==='+'){e.preventDefault();zoomStep(+1);}
    if(e.key==='-'){e.preventDefault();zoomStep(-1);}
    if(e.key==='0'){e.preventDefault();zoomReset();}
    if(e.key==='f'||e.key==='F'){e.preventDefault();zoomFit();}
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP NAV
// Manages the 4-step wizard tabs and panel visibility.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goStep(n){
  document.querySelectorAll('.step-panel').forEach((p,i)=>p.classList.toggle('active',i===n-1));
  document.querySelectorAll('.step-tab').forEach((t,i)=>t.classList.toggle('active',i===n-1));
  const isC=n===2;
  document.getElementById('simBar').style.display=isC?'flex':'none';
  document.getElementById('mainToolbar').style.display=isC?'none':'flex';
  // When entering the DFD canvas with no nodes, reset the viewport so the
  // empty-hint is centered and the user isn't staring at a blank zoomed-out grid
  if(isC&&!Object.keys(S.nodes).length){vpZ=1.0;vpX=16;vpY=16;_applyViewport();}
  if(n===3)renderCM();
  if(n===4)refreshAssess();
}
function showSec(id,el){
  document.querySelectorAll('.scope-section').forEach(s=>s.classList.remove('asec'));
  document.querySelectorAll('.scope-nav-item').forEach(n=>n.classList.remove('anav'));
  document.getElementById('sec-'+id).classList.add('asec');
  el.classList.add('anav');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABLE ROWS
// Templates and counters for scope table CRUD (Step 1).
// ROW_COUNTS tracks per-table row counts for ID generation.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROW_TEMPLATES={
  deps:(i)=>`<tr><td>DEP-${i}</td><td contenteditable="true" style="outline:none;color:var(--text2)" placeholder="Describe...">Click to edit</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`,
  entry:(i)=>`<tr><td>EP-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">Name</td><td contenteditable="true" style="outline:none;color:var(--text2)">Description</td><td contenteditable="true" style="outline:none;color:var(--text2)">TL-1</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`,
  exit:(i)=>`<tr><td>XP-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">Name</td><td contenteditable="true" style="outline:none;color:var(--text2)">Description</td><td><select style="background:var(--s2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;padding:2px"><option>High</option><option>Medium</option><option>Low</option></select></td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`,
  assets:(i)=>`<tr><td>A-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">Name</td><td contenteditable="true" style="outline:none;color:var(--text2)">What and why protect</td><td contenteditable="true" style="outline:none;color:var(--text2)">TL-1</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`,
  trust:(i)=>`<tr><td>TL-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">Name</td><td contenteditable="true" style="outline:none;color:var(--text2)">Description</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`,
};
const ROW_COUNTS={deps:0,entry:0,exit:0,assets:0,trust:0};
function addRow(type){
  ROW_COUNTS[type]++;
  document.getElementById(type+'Tbody').insertAdjacentHTML('beforeend',ROW_TEMPLATES[type](ROW_COUNTS[type]));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT DEFS
// Maps node type keys ‚Üí default visual and security properties.
// These defaults are used when creating new nodes on the canvas.
//   label       ‚Äî display name
//   icon        ‚Äî emoji shown in node header
//   color       ‚Äî hex accent color for the node type
//   body        ‚Äî short description shown in node body
//   trust       ‚Äî initial trust level ('trusted' | 'untrusted' | 'internal')
//   zone        ‚Äî network zone for blast radius routing
//   iamPriv     ‚Äî IAM privilege level for priv-esc modeling
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFS={
  internet:{label:'Internet',icon:'üåê',color:'#ff6b6b',body:'External Network',trust:'untrusted',zone:'public',trustZone:'internet',iamPriv:'none'},
  user:{label:'User',icon:'üë§',color:'#4d9de0',body:'Client / Browser',trust:'untrusted',zone:'public',trustZone:'internet',iamPriv:'none'},
  attacker:{label:'Attacker',icon:'‚ò†Ô∏è',color:'#ff4444',body:'Threat Actor',trust:'hostile',zone:'public',trustZone:'internet',iamPriv:'none'},
  firewall:{label:'Firewall',icon:'üî•',color:'#ff8c00',body:'Rules Engine',trust:'trusted',zone:'dmz',trustZone:'dmz',iamPriv:'none',isDetector:true},
  loadbalancer:{label:'Load Balancer',icon:'‚öñÔ∏è',color:'#f59e0b',body:'L7 LB',trust:'trusted',zone:'dmz',trustZone:'dmz',iamPriv:'none'},
  vpn:{label:'VPN Gateway',icon:'üîí',color:'#4d9de0',body:'Encrypted Tunnel',trust:'trusted',zone:'dmz',trustZone:'dmz',iamPriv:'none'},
  cdn:{label:'CDN',icon:'‚òÅÔ∏è',color:'#60a5fa',body:'Edge Cache',trust:'trusted',zone:'public',trustZone:'internet',iamPriv:'none'},
  webserver:{label:'Web Server',icon:'üñ•',color:'#0066ff',body:'nginx / Apache',trust:'internal',zone:'private',trustZone:'internal',iamPriv:'standard'},
  api:{label:'API Server',icon:'‚ö°',color:'#f59e0b',body:'REST / GraphQL',trust:'internal',zone:'private',trustZone:'internal',iamPriv:'standard'},
  microservice:{label:'Microservice',icon:'üîß',color:'#4d9de0',body:'Service Mesh',trust:'internal',zone:'private',trustZone:'internal',iamPriv:'standard'},
  lambda:{label:'Serverless',icon:'Œª',color:'#ff8c00',body:'FaaS',trust:'internal',zone:'private',trustZone:'internal',iamPriv:'standard'},
  database:{label:'Database',icon:'üóÑ',color:'#ff6b6b',body:'PostgreSQL/MySQL',trust:'restricted',zone:'isolated',trustZone:'restricted',iamPriv:'none'},
  cache:{label:'Cache',icon:'‚ö°',color:'#ffd93d',body:'Redis/Memcached',trust:'restricted',zone:'isolated',trustZone:'restricted',iamPriv:'none'},
  storage:{label:'Object Storage',icon:'üì¶',color:'#60a5fa',body:'S3 / GCS',trust:'restricted',zone:'isolated',trustZone:'restricted',iamPriv:'none'},
  messagequeue:{label:'Message Queue',icon:'üì®',color:'#4d9de0',body:'Kafka/RabbitMQ',trust:'internal',zone:'private',trustZone:'internal',iamPriv:'none'},
  waf:{label:'WAF',icon:'üõ°',color:'#ff8c00',body:'Web App Firewall',trust:'trusted',zone:'dmz',trustZone:'dmz',iamPriv:'none',isDetector:true},
  idp:{label:'Identity Provider',icon:'üîë',color:'#f59e0b',body:'OAuth2/SAML',trust:'trusted',zone:'private',trustZone:'internal',iamPriv:'none'},
  siem:{label:'SIEM',icon:'üëÅ',color:'#ff4444',body:'Log Analytics',trust:'trusted',zone:'private',trustZone:'internal',iamPriv:'none',isDetector:true},
};

// ‚ïê‚ïê‚ïê GRAPH TRAVERSAL ENGINE ‚ïê‚ïê‚ïê
// Builds a directed adjacency map once per analysis run ‚Äî O(E)
function buildAdjacency(nodes,edges){
  const adj={};
  Object.keys(nodes).forEach(id=>adj[id]=[]);
  edges.forEach(e=>{if(adj[e.from])adj[e.from].push({to:e.to,edge:e});});
  return adj;
}
// BFS: can srcId reach dstId through any directed path? Returns the path array or null.
function findPath(srcId,dstId,adj){
  if(srcId===dstId)return[srcId];
  const visited=new Set();
  const queue=[[srcId,[srcId]]];
  while(queue.length){
    const[cur,path]=queue.shift();
    if(visited.has(cur))continue;
    visited.add(cur);
    for(const{to}of(adj[cur]||[])){
      if(to===dstId)return[...path,to];
      if(!visited.has(to))queue.push([to,[...path,to]]);
    }
  }
  return null;
}
// Returns Set of all node IDs reachable from srcId (not including src itself)
function reachableFrom(srcId,adj){
  const visited=new Set();
  const queue=[srcId];
  while(queue.length){
    const cur=queue.shift();
    if(visited.has(cur))continue;
    visited.add(cur);
    (adj[cur]||[]).forEach(({to})=>queue.push(to));
  }
  visited.delete(srcId);
  return visited;
}
// Detect cycles via DFS ‚Äî returns true if any cycle exists
function hasCycle(adj){
  const WHITE=0,GRAY=1,BLACK=2;
  const color={};
  Object.keys(adj).forEach(id=>color[id]=WHITE);
  function dfs(u){
    color[u]=GRAY;
    for(const{to}of(adj[u]||[])){
      if(color[to]===GRAY)return true;
      if(color[to]===WHITE&&dfs(to))return true;
    }
    color[u]=BLACK;return false;
  }
  return Object.keys(adj).some(id=>color[id]===WHITE&&dfs(id));
}
// Count how many trust-level escalations exist on the best path between two nodes
function trustBoundaryCrossings(path,edges){
  let count=0;
  for(let i=0;i<path.length-1;i++){
    const e=edges.find(ed=>ed.from===path[i]&&ed.to===path[i+1]);
    if(e&&e.trustBoundary!=='No')count++;
  }
  return count;
}

// ‚ïê‚ïê‚ïê THREAT RULES (OWASP STRIDE) ‚Äî graph-traversal-aware ‚ïê‚ïê‚ïê
const RULES=[
  // T-001: checks if any untrusted node can reach a webserver/api WITHOUT passing through waf/firewall
  {id:'T-001',name:'Missing WAF / Firewall',stride:'T',sev:'critical',like:'High',imp:'High',cat:'Tampering',ctrl:'Integrity',
   check:(N,E,adj)=>{
     const ext=Object.values(N).filter(n=>['internet','user','attacker'].includes(n.type));
     const svcs=Object.values(N).filter(n=>['webserver','api'].includes(n.type));
     const guards=new Set(Object.values(N).filter(n=>['waf','firewall'].includes(n.type)).map(n=>n.id));
     if(!ext.length||!svcs.length||guards.size)return null;
     // No guard nodes exist at all ‚Äî any path is unguarded
     const aff=[...new Set(svcs.filter(svc=>ext.some(e=>findPath(e.id,svc.id,adj))).map(s=>s.id))];
     return aff.length?{aff}:null;
   },
   desc:'External traffic can reach internal services without passing through any WAF or Firewall. Enables direct exploitation of web vulnerabilities.',
   mits:['Deploy WAF (AWS WAF, Cloudflare, ModSecurity)','Add firewall with deny-by-default rules','Implement DMZ and network segmentation']},

  // T-002: upgraded ‚Äî finds multi-hop paths from untrusted nodes to unauthenticated APIs
  {id:'T-002',name:'Unauthenticated API Reachable from Untrusted Node',stride:'S',sev:'critical',like:'High',imp:'High',cat:'Spoofing',ctrl:'Authentication',
   check:(N,E,adj)=>{
     const untrusted=Object.values(N).filter(n=>['untrusted','hostile'].includes(n.trust));
     const apis=Object.values(N).filter(n=>n.type==='api');
     const aff=[];
     for(const src of untrusted){
       for(const api of apis){
         // Check if any edge *arriving* at the API has no auth
         const inEdges=E.filter(e=>e.to===api.id&&e.auth==='None');
         if(inEdges.length&&findPath(src.id,api.id,adj))aff.push(api.id);
       }
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'An untrusted node can reach an API endpoint with no authentication through one or more hops. Any actor can spoof identity and make unauthorized calls.',
   mits:['Require JWT or OAuth2 on all API endpoints','Implement API gateway with mandatory auth','Add rate limiting and IP allowlisting']},

  // T-003: upgraded ‚Äî traversal to find any path reaching a DB with no encryption
  {id:'T-003',name:'Unencrypted Database Connection',stride:'I',sev:'high',like:'Medium',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   check:(N,E,adj)=>{
     const dbs=Object.values(N).filter(n=>n.type==='database');
     const aff=[];
     for(const db of dbs){
       const badEdge=E.find(e=>e.to===db.id&&e.encryption==='None');
       if(badEdge)aff.push(db.id);
     }
     return aff.length?{aff}:null;
   },
   desc:'Database connections transmit plaintext, exposing credentials and sensitive records to eavesdropping.',
   mits:['Enable TLS/SSL for all DB connections','Use mTLS for service-to-DB authentication','Encrypt data at rest and in transit']},

  // T-004: checks if sensitive data can flow toward any node reachable from untrusted sources
  {id:'T-004',name:'PII / Sensitive Data over Plaintext',stride:'I',sev:'critical',like:'High',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   check:(N,E,adj)=>{
     const aff=[];
     for(const e of E){
       if(['PII','PHI','PCI'].includes(e.dataClass)&&e.encryption==='None')aff.push(e.to);
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'PII, PHI, or PCI data transmitted without encryption. Violates GDPR, HIPAA, PCI-DSS requirements.',
   mits:['Enforce TLS 1.2+ on all sensitive flows','Implement data masking at API layer','Classify and audit all data flows']},

  // T-005: upgraded ‚Äî checks if attacker has reachable path to any internal/restricted node
  {id:'T-005',name:'Attacker Has Active Data Flow Path',stride:'S',sev:'critical',like:'High',imp:'High',cat:'Spoofing',ctrl:'Authentication',
   check:(N,E,adj)=>{
     const atk=Object.values(N).find(n=>n.type==='attacker');
     if(!atk)return null;
     const reachable=reachableFrom(atk.id,adj);
     const highValue=Object.values(N).filter(n=>['internal','restricted'].includes(n.trust)&&reachable.has(n.id));
     return highValue.length?{aff:[atk.id,...highValue.map(n=>n.id)]}:null;
   },
   desc:'Adversary node has a directed path to internal or restricted nodes. Models a live attack path into the protected architecture.',
   mits:['Explicitly model attacker capabilities','Add detection (SIEM, IDS/IPS)','Implement zero-trust network segmentation']},

  {id:'T-006',name:'No Audit Trail / SIEM',stride:'R',sev:'medium',like:'Medium',imp:'Medium',cat:'Repudiation',ctrl:'Non-Repudiation',
   check:(N,E,adj)=>{
     const s=Object.values(N).some(n=>n.type==='siem');
     return(Object.keys(N).length>2&&!s)?{aff:[]}:null;
   },
   desc:'No SIEM or audit component. Operations are unlogged; attacks go undetected; repudiation is enabled.',
   mits:['Deploy SIEM (Splunk, Elastic, Wazuh)','Enable centralized audit logging','Implement digital signatures on critical ops','Set up anomaly detection alerts']},

  {id:'T-007',name:'Unauthenticated Cache Access',stride:'I',sev:'high',like:'Medium',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   check:(N,E,adj)=>{
     const aff=[];
     for(const e of E){const t=N[e.to];if(t&&t.type==='cache'&&e.auth==='None')aff.push(t.id);}
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Cache accessible without authentication leaks session data, tokens, or sensitive cached responses.',
   mits:['Enable Redis AUTH / Memcached SASL','Restrict to localhost/private network only','Encrypt sensitive values before caching']},

  // T-008: upgraded ‚Äî checks if storage is reachable from any untrusted node via any path
  {id:'T-008',name:'Public Object Storage Exposure',stride:'I',sev:'high',like:'High',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   check:(N,E,adj)=>{
     const untrusted=Object.values(N).filter(n=>['internet','user','attacker'].includes(n.type));
     const stores=Object.values(N).filter(n=>n.type==='storage');
     const aff=[];
     for(const src of untrusted)
       for(const st of stores)
         if(findPath(src.id,st.id,adj))aff.push(st.id);
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Object storage is reachable from an untrusted node through one or more hops. Risk of public bucket misconfiguration or indirect access.',
   mits:['Block all public access by default','Use pre-signed URLs with short TTL','Enable S3 Block Public Access policy']},

  {id:'T-009',name:'Single Point of Failure ‚Äî No LB',stride:'D',sev:'medium',like:'Medium',imp:'Medium',cat:'Denial of Service',ctrl:'Availability',
   check:(N,E,adj)=>{
     const lb=Object.values(N).some(n=>n.type==='loadbalancer');
     const wc=Object.values(N).filter(n=>['webserver','api'].includes(n.type)).length;
     return(wc>0&&!lb)?{aff:[]}:null;
   },
   desc:'No load balancer detected. A single server crash causes complete service outage.',
   mits:['Add load balancer with health checks','Deploy across multiple availability zones','Implement circuit breaker patterns']},

  // T-010: upgraded ‚Äî uses path traversal to find internal‚Üírestricted escalation chains
  {id:'T-010',name:'Lateral Movement to Data Store',stride:'E',sev:'high',like:'Medium',imp:'High',cat:'Elevation of Privilege',ctrl:'Authorization',
   check:(N,E,adj)=>{
     const aff=[];
     for(const e of E){
       const f=N[e.from],t=N[e.to];
       if(f&&t&&f.trust==='internal'&&t.trust==='restricted'&&e.auth==='None')aff.push(t.id);
     }
     // Additionally check multi-hop: untrusted‚Üíinternal‚Üírestricted
     const untrusted=Object.values(N).filter(n=>['untrusted','hostile'].includes(n.trust));
     const restricted=Object.values(N).filter(n=>n.trust==='restricted');
     for(const src of untrusted)
       for(const dst of restricted){
         const path=findPath(src.id,dst.id,adj);
         if(path&&path.length>2)aff.push(dst.id);
       }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Direct or multi-hop path exists from internal/untrusted node to restricted data store without authentication. Enables lateral movement post-compromise.',
   mits:['Require mTLS between services and data stores','Use service mesh with AuthZ policies','Least-privilege DB credentials per service']},

  {id:'T-011',name:'HTTP on External Channel',stride:'I',sev:'high',like:'High',imp:'Medium',cat:'Information Disclosure',ctrl:'Confidentiality',
   check:(N,E,adj)=>{
     const aff=[];
     for(const e of E){const f=N[e.from];if(f&&['internet','user'].includes(f.type)&&e.protocol==='HTTP')aff.push(e.to);}
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Unencrypted HTTP on external-facing connections. Susceptible to MITM, credential theft, session hijacking.',
   mits:['Enforce HTTPS via HSTS','Redirect all HTTP to HTTPS','Configure TLS 1.2+ with strong cipher suites']},

  {id:'T-012',name:'No Centralized Identity Provider',stride:'S',sev:'medium',like:'Medium',imp:'Medium',cat:'Spoofing',ctrl:'Authentication',
   check:(N,E,adj)=>{
     const idp=Object.values(N).some(n=>n.type==='idp');
     const usr=Object.values(N).some(n=>n.type==='user');
     return(usr&&!idp)?{aff:[]}:null;
   },
   desc:'No centralized identity provider. Fragmented authentication increases credential exposure and inconsistent session handling.',
   mits:['Implement SSO with SAML 2.0 or OIDC','Centralize AuthN in Identity Provider','Enable MFA for all user accounts']},

  // ‚îÄ‚îÄ NEW RULES from audit ‚îÄ‚îÄ

  // T-013: Multi-boundary traversal ‚Äî path crosses more than one trust boundary = escalation risk
  {id:'T-013',name:'Excessive Trust Boundary Traversal',stride:'E',sev:'high',like:'Medium',imp:'High',cat:'Elevation of Privilege',ctrl:'Authorization',
   check:(N,E,adj)=>{
     const untrusted=Object.values(N).filter(n=>['untrusted','hostile'].includes(n.trust));
     const restricted=Object.values(N).filter(n=>n.trust==='restricted');
     const aff=[];
     for(const src of untrusted)
       for(const dst of restricted){
         const path=findPath(src.id,dst.id,adj);
         if(path&&trustBoundaryCrossings(path,E)>=2)aff.push(dst.id);
       }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'A path crosses two or more trust boundaries to reach a restricted node. Each boundary crossing is a privilege escalation opportunity if controls are inconsistent.',
   mits:['Enforce re-authentication at each trust boundary','Implement consistent AuthZ policy across zones','Use network micro-segmentation between trust levels']},

  // T-014: Data classification mismatch ‚Äî sensitive data flows into public/untrusted nodes
  {id:'T-014',name:'Sensitive Data Flows to Low-Trust Node',stride:'I',sev:'critical',like:'High',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   check:(N,E,adj)=>{
     const aff=[];
     for(const e of E){
       const tNode=N[e.to];
       if(!tNode)continue;
       if(['PII','PHI','PCI','Confidential','Restricted'].includes(e.dataClass)&&['untrusted','hostile'].includes(tNode.trust))
         aff.push(tNode.id);
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Sensitive or regulated data (PII/PHI/PCI/Confidential) is being sent directly to an untrusted or hostile node. This is an unconditional data exposure.',
   mits:['Never transmit classified data to untrusted endpoints','Enforce data classification policies at API layer','Add DLP controls and egress filtering']},

  // T-015: Cyclic dependency ‚Äî service graph contains a loop, creates DoS / deadlock surface
  {id:'T-015',name:'Cyclic Service Dependency',stride:'D',sev:'medium',like:'Low',imp:'High',cat:'Denial of Service',ctrl:'Availability',
   check:(N,E,adj)=>{
     // Only check among internal/restricted nodes ‚Äî cycles between external actors are expected
     const internal=new Set(Object.values(N).filter(n=>['internal','restricted'].includes(n.trust)).map(n=>n.id));
     const internalAdj={};
     internal.forEach(id=>{internalAdj[id]=(adj[id]||[]).filter(({to})=>internal.has(to));});
     const WHITE=0,GRAY=1,BLACK=2;
     const color={};internal.forEach(id=>color[id]=WHITE);
     let cyclic=false;
     function dfs(u){if(color[u]===GRAY){cyclic=true;return;}if(color[u]===BLACK)return;color[u]=GRAY;(internalAdj[u]||[]).forEach(({to})=>dfs(to));color[u]=BLACK;}
     internal.forEach(id=>{if(color[id]===WHITE)dfs(id);});
     return cyclic?{aff:[]}:null;
   },
   desc:'Internal service graph contains a cycle. Circular dependencies create deadlock risk, cascading failures, and amplified DoS surface under load.',
   mits:['Break cycles with async messaging (queues/events)','Introduce timeout and circuit-breaker patterns','Audit service call graph for unintentional loops']},

  // T-016: No rate limiting ‚Äî user/internet connects to auth-handling node without API key/rate controls
  {id:'T-016',name:'Missing Rate Limiting on Auth Endpoint',stride:'D',sev:'high',like:'High',imp:'Medium',cat:'Denial of Service',ctrl:'Availability',
   check:(N,E,adj)=>{
     const aff=[];
     const external=Object.values(N).filter(n=>['internet','user','attacker'].includes(n.type));
     const authSvcs=Object.values(N).filter(n=>['api','webserver','idp'].includes(n.type));
     for(const src of external){
       for(const svc of authSvcs){
         const path=findPath(src.id,svc.id,adj);
         if(!path)continue;
         // If every edge on the path has auth=None and no WAF/firewall sits between them
         const pathEdges=[];
         for(let i=0;i<path.length-1;i++){const e=E.find(ed=>ed.from===path[i]&&ed.to===path[i+1]);if(e)pathEdges.push(e);}
         const noProtection=pathEdges.every(e=>e.auth==='None');
         const noGuard=!path.slice(1,-1).some(id=>['waf','firewall','loadbalancer'].includes(N[id]?.type));
         if(noProtection&&noGuard)aff.push(svc.id);
       }
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'An external actor can reach an authentication-handling service with no rate limiting or throttling controls on the path. Enables brute force and credential stuffing.',
   mits:['Implement rate limiting at WAF or API gateway','Add CAPTCHA on login endpoints','Deploy account lockout and progressive delay policies']},

  // T-017: Supply chain / dependency risk ‚Äî external dep nodes connected to internal services
  {id:'T-017',name:'Uncontrolled External Dependency Ingress',stride:'T',sev:'high',like:'Medium',imp:'High',cat:'Tampering',ctrl:'Integrity',
   check:(N,E,adj)=>{
     const internet=Object.values(N).filter(n=>n.type==='internet');
     const internal=Object.values(N).filter(n=>['internal','restricted'].includes(n.trust));
     const aff=[];
     for(const src of internet){
       const reachable=reachableFrom(src.id,adj);
       internal.forEach(nd=>{if(reachable.has(nd.id))aff.push(nd.id);});
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Internet-facing nodes have a directed path to internal services with no explicit trust validation. Supply chain or dependency tampering can propagate inward.',
   mits:['Pin and verify all external dependencies (SBOMs)','Enforce input validation at every trust boundary','Use network egress filtering to limit outbound connections']},

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ENHANCED RULE ENGINE ‚Äî 6 REQUIRED OWASP/STRIDE RULES
  // These implement the formal rule-based threat engine
  // with data-aware edge semantics and graph analysis.
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // R-001: Broken Authentication ‚Äî API node with auth disabled
  // RULE: IF node.type == "api" AND node.props.auth == false
  {id:'R-001',name:'Broken Authentication',stride:'S',sev:'high',like:'High',imp:'High',cat:'Spoofing',ctrl:'Authentication',
   owasp:'A07:2021 Identification and Authentication Failures',
   check:(N,E,adj)=>{
     const aff=[];
     for(const nd of Object.values(N)){
       if(nd.type==='api'){
         // Check normalized props.auth first, fall back to edge-level auth check
         const propAuthFalse=nd.props&&nd.props.auth===false;
         // Also detect if ALL incoming edges to this API have auth=None (no auth enforced)
         const inEdges=E.filter(e=>e.to===nd.id);
         const allEdgesUnauthenticated=inEdges.length>0&&inEdges.every(e=>e.auth==='None');
         if(propAuthFalse||allEdgesUnauthenticated)aff.push(nd.id);
       }
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'API endpoint has authentication disabled. Any actor can make unauthorized calls, spoof identities, and access protected resources without credentials. Maps to OWASP A07:2021.',
   mits:['Enable JWT or OAuth2 on all API endpoints','Implement API Gateway with mandatory authentication policy','Add MFA for privileged API operations','Audit all API routes for missing auth middleware']},

  // R-002: Sensitive Data Exposure ‚Äî Database without encryption at rest
  // RULE: IF node.type == "database" AND node.props.encryption == false
  {id:'R-002',name:'Sensitive Data Exposure ‚Äî Unencrypted Database',stride:'I',sev:'critical',like:'High',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   owasp:'A02:2021 Cryptographic Failures',
   check:(N,E,adj)=>{
     const aff=[];
     for(const nd of Object.values(N)){
       if(nd.type==='database'){
         // Check normalized props.encryption, also flag if any incoming edge has encryption=None
         const propEncFalse=nd.props&&nd.props.encryption===false;
         const inEdges=E.filter(e=>e.to===nd.id);
         const hasUnencryptedInbound=inEdges.some(e=>e.encryption==='None');
         if(propEncFalse||hasUnencryptedInbound)aff.push(nd.id);
       }
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Database lacks encryption at rest or receives unencrypted connections. Sensitive records, credentials, and PII are exposed to anyone with physical or logical access to storage. Maps to OWASP A02:2021.',
   mits:['Enable transparent data encryption (TDE) at the database engine level','Encrypt all DB connection strings with TLS 1.2+','Use column-level encryption for PII/PCI/PHI fields','Rotate encryption keys on a regular schedule']},

  // R-003: MITM Attack ‚Äî Edge using HTTP with no encryption
  // RULE: IF edge.protocol == "http" AND edge.encryption == "none"
  {id:'R-003',name:'Man-in-the-Middle Attack',stride:'I',sev:'high',like:'High',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   owasp:'A02:2021 Cryptographic Failures',
   check:(N,E,adj)=>{
     const aff=[];
     for(const e of E){
       // Match HTTP (case-insensitive) with no encryption
       const isHttp=e.protocol&&e.protocol.toUpperCase()==='HTTP';
       const noEnc=!e.encryption||e.encryption==='None';
       if(isHttp&&noEnc){aff.push(e.to);if(e.from)aff.push(e.from);}
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Data flow uses unencrypted HTTP with no transport security. An attacker positioned on the network can intercept, read, and modify all traffic between these components. Maps to OWASP A02:2021.',
   mits:['Upgrade all connections to HTTPS/TLS 1.2+','Enforce HTTP Strict Transport Security (HSTS)','Redirect all HTTP requests to HTTPS at the load balancer','Use TLS 1.3 for maximum forward secrecy']},

  // R-004: Plaintext Sensitive Data ‚Äî PII or secret data on unencrypted edge
  // RULE: IF edge.dataClassification IN ["pii","secret"] AND edge.encryption == "none"
  {id:'R-004',name:'Plaintext Sensitive Data Exposure',stride:'I',sev:'critical',like:'High',imp:'High',cat:'Information Disclosure',ctrl:'Confidentiality',
   owasp:'A02:2021 Cryptographic Failures',
   check:(N,E,adj)=>{
     const sensitiveClasses=['PII','PHI','PCI','Confidential','Restricted','secret','pii','phi','pci','confidential','restricted'];
     const aff=[];
     for(const e of E){
       const isSensitive=sensitiveClasses.includes(e.dataClass)||sensitiveClasses.includes(e.dataClassification);
       const noEnc=!e.encryption||e.encryption==='None';
       if(isSensitive&&noEnc){aff.push(e.to);if(e.from)aff.push(e.from);}
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Personally Identifiable Information (PII), secrets, or regulated data is transmitted without encryption. This violates GDPR, HIPAA, and PCI-DSS requirements and exposes individuals to identity theft. Maps to OWASP A02:2021.',
   mits:['Enforce TLS 1.2+ on all channels carrying PII/secret data','Implement end-to-end encryption for sensitive payloads','Apply data minimization ‚Äî transmit only essential fields','Audit all data flows against a data classification register']},

  // R-005: Unauthorized Data Access ‚Äî Edge with no auth carrying non-public data
  // RULE: IF edge.auth == "none" AND edge.dataClassification != "public"
  {id:'R-005',name:'Unauthorized Data Access',stride:'E',sev:'high',like:'High',imp:'High',cat:'Elevation of Privilege',ctrl:'Authorization',
   owasp:'A01:2021 Broken Access Control',
   check:(N,E,adj)=>{
     const publicClasses=['Public','public'];
     const aff=[];
     for(const e of E){
       const noAuth=!e.auth||e.auth==='None';
       const dataClass=e.dataClass||e.dataClassification||'Public';
       const isNonPublic=!publicClasses.includes(dataClass);
       if(noAuth&&isNonPublic){aff.push(e.to);if(e.from)aff.push(e.from);}
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'Non-public data flows across a connection with no authentication. Any actor with network access can read or exfiltrate internal, confidential, or regulated data without presenting credentials. Maps to OWASP A01:2021.',
   mits:['Require authentication on every connection carrying non-public data','Implement zero-trust: authenticate every request regardless of network zone','Use API keys or JWT for service-to-service calls','Log and alert on unauthenticated access to sensitive endpoints']},

  // R-006: Privilege Escalation Path ‚Äî client‚Üíapi‚Üídatabase with admin role and no auth
  // RULE: Graph path: client‚Üíapi‚Üídatabase where api.props.role=="admin" AND edge.auth=="none"
  {id:'R-006',name:'Privilege Escalation Path',stride:'E',sev:'critical',like:'Medium',imp:'High',cat:'Elevation of Privilege',ctrl:'Authorization',
   owasp:'A01:2021 Broken Access Control',
   check:(N,E,adj)=>{
     const aff=[];
     // Find all client/user nodes
     const clients=Object.values(N).filter(n=>['user','client','internet','attacker'].includes(n.type));
     // Find API nodes that have admin role (via props.role or trust level or iamPriv)
     const adminApis=Object.values(N).filter(n=>
       n.type==='api'&&(
         (n.props&&(n.props.role==='admin'||n.props.role==='service'))||
         n.iamPriv==='admin'||
         n.trust==='restricted'
       )
     );
     // Find database nodes
     const dbs=Object.values(N).filter(n=>n.type==='database');

     for(const client of clients){
       for(const api of adminApis){
         // Check client‚Üíapi path exists
         const pathToApi=findPath(client.id,api.id,adj);
         if(!pathToApi)continue;
         // Check the connecting edge to API has no auth
         const edgeToApi=E.find(e=>e.to===api.id&&pathToApi.includes(e.from));
         const apiEdgeUnauthenticated=!edgeToApi||edgeToApi.auth==='None';
         if(!apiEdgeUnauthenticated)continue;
         // Now check if api‚Üídatabase path exists with no auth
         for(const db of dbs){
           const pathToDb=findPath(api.id,db.id,adj);
           if(!pathToDb)continue;
           const edgeToDb=E.find(e=>e.from===api.id&&e.to===db.id);
           const dbEdgeUnauthenticated=!edgeToDb||edgeToDb.auth==='None';
           if(dbEdgeUnauthenticated){
             aff.push(client.id,api.id,db.id);
           }
         }
       }
     }
     // Also check more broadly: any unauthenticated path where intermediate node has admin/assumerole
     for(const e of E){
       const fromNd=N[e.from];const toNd=N[e.to];
       if(!fromNd||!toNd)continue;
       const fromIsAdmin=fromNd.iamPriv==='admin'||(fromNd.props&&fromNd.props.role==='admin');
       const edgeNoAuth=!e.auth||e.auth==='None';
       if(fromIsAdmin&&edgeNoAuth&&toNd.type==='database'){
         aff.push(fromNd.id,toNd.id);
       }
     }
     return aff.length?{aff:[...new Set(aff)]}:null;
   },
   desc:'A privilege escalation path exists: a client can reach an admin-role API, and that API connects to a database without authentication. An attacker exploiting the unauthenticated API gains full database access via admin privileges. Maps to OWASP A01:2021.',
   mits:['Enforce strict role-based access control (RBAC) on all API‚ÜíDB connections','Require mTLS for service-to-database authentication','Apply least privilege: never use admin credentials for application DB connections','Implement database proxies (e.g. AWS RDS Proxy) to enforce connection-level AuthZ']},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT THREAT PROFILES
// Per-node-type STRIDE threat library. Each entry maps to:
//   stride ‚Äî STRIDE category letter (S/T/R/I/D/E)
//   sev    ‚Äî severity level (critical/high/medium/low)
//   name   ‚Äî human-readable threat name
//   mits   ‚Äî array of recommended mitigations
//
// These are shown immediately when a node is selected and are
// used by runAnalysis() to populate the threat register.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COMPONENT_THREATS={
  internet:[
    {stride:'S',sev:'critical',name:'Spoofed Origin / IP Forgery',mits:['Validate all inbound request origins','Implement strict CORS policy','Use request signing (HMAC)']},
    {stride:'D',sev:'high',name:'DDoS / Volumetric Flood',mits:['Deploy CDN with rate limiting','Use anycast traffic scrubbing','Implement SYN cookie protection']},
    {stride:'T',sev:'high',name:'Man-in-the-Middle Interception',mits:['Enforce HTTPS everywhere with HSTS','Pin TLS certificates','Use TLS 1.3 only']},
  ],
  user:[
    {stride:'S',sev:'high',name:'Credential Theft / Phishing',mits:['Enforce MFA for all accounts','Implement phishing-resistant auth (WebAuthn)','Detect anomalous login patterns']},
    {stride:'E',sev:'medium',name:'Privilege Escalation via Broken Access Control',mits:['Enforce least-privilege RBAC','Validate role on every request server-side','Audit permission changes']},
    {stride:'I',sev:'medium',name:'Session Hijacking',mits:['Use HttpOnly + Secure cookie flags','Rotate session tokens on privilege change','Implement absolute session timeouts']},
  ],
  attacker:[
    {stride:'S',sev:'critical',name:'Identity Spoofing / Impersonation',mits:['Require strong authentication on all paths','Zero-trust: verify every request','Deploy behavioral analytics (UEBA)']},
    {stride:'T',sev:'critical',name:'Data Tampering / Injection',mits:['Input validation on all entry points','Parameterized queries / ORM','Integrity checksums on critical data']},
    {stride:'E',sev:'critical',name:'Full System Compromise Path',mits:['Network segmentation and micro-segmentation','Implement deception technology (honeypots)','Continuous threat hunting']},
  ],
  webserver:[
    {stride:'T',sev:'high',name:'SQL / Command Injection',mits:['Use parameterized queries only','Deploy WAF with OWASP Core Rule Set','Restrict DB account permissions']},
    {stride:'I',sev:'high',name:'Directory Traversal / File Exposure',mits:['Restrict file system access to webroot','Disable directory listing','Validate all file path inputs']},
    {stride:'D',sev:'medium',name:'Resource Exhaustion / Slow Loris',mits:['Set request size and timeout limits','Use reverse proxy (nginx) with connection limits','Implement circuit breakers']},
  ],
  api:[
    {stride:'S',sev:'critical',name:'Broken Object Level Authorization (BOLA)',mits:['Validate object ownership on every request','Never expose internal IDs directly','Implement row-level security']},
    {stride:'I',sev:'high',name:'Excessive Data Exposure',mits:['Return only fields the client needs','Use response schemas (allowlists)','Log and alert on anomalous response sizes']},
    {stride:'D',sev:'high',name:'API Abuse / Rate Limit Bypass',mits:['Enforce rate limits per API key and IP','Implement API gateway throttling','Detect scraping patterns']},
    {stride:'T',sev:'high',name:'Mass Assignment / Parameter Pollution',mits:['Allowlist accepted request fields','Use strict DTOs','Reject unexpected parameters']},
  ],
  database:[
    {stride:'I',sev:'critical',name:'Unauthorized Data Access / Exfiltration',mits:['Encrypt data at rest (AES-256)','Enforce column-level encryption for PII/PCI/PHI','Audit all SELECT queries on sensitive tables']},
    {stride:'T',sev:'high',name:'SQL Injection via Application Layer',mits:['Use stored procedures and parameterized queries','Restrict DB user to minimum required privileges','Deploy DB activity monitoring (DAM)']},
    {stride:'D',sev:'high',name:'Database Unavailability / Lock Contention',mits:['Implement read replicas for failover','Set query timeouts and connection pool limits','Use distributed caching to reduce load']},
    {stride:'R',sev:'medium',name:'Insufficient DB Audit Logging',mits:['Enable binary logging / WAL','Forward DB logs to SIEM in real time','Implement tamper-evident audit trail']},
  ],
  storage:[
    {stride:'I',sev:'critical',name:'Public Bucket Misconfiguration',mits:['Enable S3 Block Public Access at account level','Audit bucket ACLs and policies weekly','Alert on public-read policy changes']},
    {stride:'T',sev:'high',name:'Malicious File Upload / Overwrite',mits:['Validate file type via magic bytes not extension','Store uploads in separate account/bucket','Scan uploads with antivirus before serving']},
    {stride:'I',sev:'high',name:'Unencrypted Sensitive Objects',mits:['Enable default encryption (SSE-S3 or SSE-KMS)','Use customer-managed keys (CMK) for PII','Enforce encryption in bucket policy (deny http)']},
  ],
  cache:[
    {stride:'I',sev:'high',name:'Sensitive Data Leakage via Cache',mits:['Never cache auth tokens or PII unencrypted','Set appropriate TTLs and cache-control headers','Use Redis ACLs to restrict key access']},
    {stride:'S',sev:'high',name:'Cache Poisoning',mits:['Validate cache key inputs','Use separate cache namespaces per tenant','Monitor for unexpected cache writes']},
    {stride:'D',sev:'medium',name:'Cache Stampede / Thundering Herd',mits:['Implement cache-aside pattern with jitter','Use probabilistic early expiration','Set stale-while-revalidate headers']},
  ],
  firewall:[
    {stride:'T',sev:'high',name:'Misconfigured Ruleset Allowing Lateral Movement',mits:['Audit firewall rules quarterly','Default deny ‚Äî whitelist only required ports','Segment internal zones with separate rule sets']},
    {stride:'D',sev:'medium',name:'Firewall as Single Point of Failure',mits:['Deploy active-active firewall HA pair','Use anycast routing for failover','Monitor firewall CPU and connection table saturation']},
  ],
  waf:[
    {stride:'T',sev:'high',name:'WAF Rule Bypass via Obfuscation',mits:['Keep WAF rule sets updated (managed rules)','Enable anomaly scoring mode','Test with OWASP ZAP and scanner tools']},
    {stride:'R',sev:'medium',name:'Insufficient WAF Logging',mits:['Forward WAF logs to SIEM','Alert on rule match spikes','Retain WAF logs 90+ days for forensics']},
  ],
  loadbalancer:[
    {stride:'D',sev:'high',name:'LB Overload / SYN Flood Bypass',mits:['Enable connection rate limiting','Use SYN proxy on LB','Integrate with upstream DDoS scrubbing']},
    {stride:'I',sev:'medium',name:'TLS Termination Exposes Internal Traffic',mits:['Re-encrypt traffic between LB and backends','Use mTLS for backend connections','Restrict LB admin interface to management network']},
  ],
  microservice:[
    {stride:'S',sev:'high',name:'Service-to-Service Spoofing',mits:['Enforce mTLS between all services','Use service mesh (Istio, Linkerd)','Validate JWT on every inter-service call']},
    {stride:'E',sev:'high',name:'Privilege Escalation via Service Account',mits:['Scope service accounts to minimum permissions','Rotate service account credentials automatically','Use workload identity instead of static keys']},
    {stride:'T',sev:'medium',name:'Dependency Injection / Supply Chain',mits:['Pin all dependency versions','Run SBOM analysis in CI','Block packages not in approved registry']},
  ],
  lambda:[
    {stride:'E',sev:'high',name:'Over-Privileged Execution Role',mits:['Follow least-privilege IAM for function role','Use resource-based policies to restrict invocation','Audit role permissions with IAM Access Analyzer']},
    {stride:'I',sev:'high',name:'Environment Variable Secret Exposure',mits:['Use secrets manager (AWS Secrets Manager, Vault)','Never hardcode credentials in function code','Encrypt environment variables at rest']},
    {stride:'D',sev:'medium',name:'Function Timeout / Runaway Cost',mits:['Set function memory and timeout limits','Implement DLQs for failed invocations','Alert on concurrent execution spikes']},
  ],
  messagequeue:[
    {stride:'T',sev:'high',name:'Message Injection / Payload Tampering',mits:['Validate and schema-validate all messages','Use message signing (HMAC)','Reject malformed messages at consumer']},
    {stride:'I',sev:'high',name:'Unauthorized Queue Access',mits:['Use IAM policies to restrict queue access','Encrypt messages in transit and at rest','Audit queue access logs']},
    {stride:'D',sev:'medium',name:'Queue Flooding / Backpressure Failure',mits:['Implement dead-letter queues','Set max message size and retention limits','Monitor queue depth and alert on thresholds']},
  ],
  vpn:[
    {stride:'S',sev:'high',name:'Stolen VPN Credentials',mits:['Enforce MFA for VPN access','Use certificate-based client auth','Detect and alert on concurrent sessions from same user']},
    {stride:'I',sev:'medium',name:'Split Tunneling Data Leak',mits:['Disable split tunneling for sensitive access','Enforce full-tunnel mode for privileged users','Log all DNS queries over VPN']},
  ],
  cdn:[
    {stride:'T',sev:'high',name:'Cache Poisoning via Host Header Injection',mits:['Validate and normalize Host headers at origin','Use CDN origin shields','Test with cache poisoning scanner (Param Miner)']},
    {stride:'I',sev:'medium',name:'Sensitive Content Served via CDN',mits:['Set Cache-Control: no-store on authenticated responses','Use signed URLs for private content','Audit cached response headers']},
  ],
  idp:[
    {stride:'S',sev:'critical',name:'Identity Provider Compromise',mits:['Enable MFA on all IdP admin accounts','Restrict IdP admin to named IP ranges','Monitor for suspicious federation token issuance']},
    {stride:'T',sev:'high',name:'SAML / OAuth Token Forgery',mits:['Validate token signatures strictly','Use short-lived tokens (15 min access tokens)','Rotate signing keys quarterly']},
    {stride:'R',sev:'medium',name:'Insufficient SSO Session Logging',mits:['Log all authentication events to SIEM','Alert on privilege escalation in tokens','Audit token scope changes']},
  ],
  siem:[
    {stride:'T',sev:'high',name:'Log Tampering / SIEM Evasion',mits:['Write logs to immutable (WORM) storage','Use forward-only log streaming','Detect gaps in log continuity']},
    {stride:'D',sev:'medium',name:'Alert Fatigue / SIEM Overload',mits:['Tune detection rules to reduce false positives','Implement alert prioritization by severity','Use SOAR for automated triage']},
  ],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP MODE
// Toggles between 'analyze' (STRIDE detection) and 'blast'
// (blast radius simulation) modes in the right panel.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let appMode = 'analyze'; // 'analyze' | 'blast'
let blastSourceId=null;

function setMode(mode){
  appMode=mode;
  document.getElementById('modeAnalyze').classList.toggle('active',mode==='analyze');
  document.getElementById('modeBlast').classList.toggle('active',mode==='blast');
  document.getElementById('analyzeContent').style.display=mode==='analyze'?'block':'none';
  document.getElementById('blastContent').style.display=mode==='blast'?'block':'none';
  document.getElementById('blastInfo').style.display=mode==='blast'?'block':'none';
  document.getElementById('ctpSection').style.display='none';
  document.getElementById('edgeEditorSection').style.display='none';
  if(mode==='analyze')clearBlast();
  // Update canvas cursor
  document.getElementById('canvas').style.cursor=mode==='blast'?'crosshair':'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPONENT THREAT PROFILE INSPECTOR
// Shows per-node STRIDE threats in the right panel when a
// node is selected. Reads from COMPONENT_THREATS lookup.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showComponentThreats(nodeId){
  const nd=S.nodes[nodeId];if(!nd)return;
  const def=DEFS[nd.type];if(!def)return;
  const threats=COMPONENT_THREATS[nd.type]||[];
  const section=document.getElementById('ctpSection');

  const strideColors={S:'#9b59b6',T:'#e67e22',R:'#3498db',I:'#e74c3c',D:'#2ecc71',E:'#ff6b6b'};
  const strideNames={S:'Spoofing',T:'Tampering',R:'Repudiation',I:'Info Disclosure',D:'Denial of Service',E:'Elev. of Privilege'};
  const sevColor={critical:'#ef4444',high:'#f97316',medium:'#facc15',low:'#34d399'};
  const strides=[...new Set(threats.map(t=>t.stride))];

  const opt=(opts,cur)=>opts.map(([v,l])=>`<option value="${v}"${v===cur?' selected':''}>${l}</option>`).join('');

  const tzColorMap={internet:'#ff6b6b',dmz:'#ff8c00',internal:'#60a5fa',secure:'#34d399'};
  const ndTZ=nd.trustZone||'internal';
  const tzC=tzColorMap[ndTZ]||'#60a5fa';
  section.innerHTML=`<div class="ctp-panel">
    <div class="ctp-header">
      <span class="ctp-icon">${def.icon}</span>
      <span class="ctp-name">${nd.label}</span>
      <button class="ctp-close" onclick="document.getElementById('ctpSection').style.display='none'">‚úï</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--s3);border-bottom:1px solid var(--border)">
      <span style="font-size:9px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:var(--text3)">TRUST ZONE</span>
      <span style="font-size:10px;font-weight:800;font-family:'JetBrains Mono',monospace;padding:2px 8px;border-radius:3px;background:${tzC}18;color:${tzC};border:1px solid ${tzC}33">${ndTZ.toUpperCase()}</span>
    </div>

    <!-- Node blast properties -->
    <div class="np-panel" style="margin-bottom:8px">
      <div class="np-title">‚öôÔ∏è Blast Radius Properties</div>
      <div class="np-row">
        <div class="np-fg">
          <span class="np-lbl">Network Zone</span>
          <select class="np-sel" onchange="updateNodeProp('${nodeId}','zone',this.value)">
            ${opt([['public','üåê Public'],['dmz','üî∂ DMZ'],['private','üîµ Private'],['isolated','üü¢ Isolated']],nd.zone||'private')}
          </select>
        </div>
        <div class="np-fg">
          <span class="np-lbl">IAM Privilege</span>
          <select class="np-sel" onchange="updateNodeProp('${nodeId}','iamPriv',this.value)">
            ${opt([['none','None'],['standard','Standard'],['assumerole','AssumeRole'],['admin','Admin']],nd.iamPriv||'standard')}
          </select>
        </div>
      </div>
      <div class="np-row">
        <div class="np-fg">
          <span class="np-lbl">Trust Zone</span>
          <select class="np-sel" onchange="updateNodeTrustZone('${nodeId}',this.value)">
            ${opt([['internet','üåê Internet'],['dmz','üî∂ DMZ'],['internal','üîµ Internal'],['restricted','üîí Restricted']],nd.trustZone||'internal')}
          </select>
        </div>
        <div class="np-fg">
          <span class="np-lbl">Data Class</span>
          <select class="np-sel" onchange="updateNodeProp('${nodeId}','props.dataClassification',this.value)">
            ${opt([['public','Public'],['internal','Internal'],['pii','PII'],['secret','Secret']],nd.props?.dataClassification||'internal')}
          </select>
        </div>
      </div>
      <div class="np-fg">
        <span class="np-lbl">Compromise Impact</span>
        <select class="np-sel" onchange="updateNodeProp('${nodeId}','compromiseImpact',this.value)">
          ${opt([['low','Low ‚Äî limited blast, scoped credentials'],['medium','Medium ‚Äî typical internal service'],['high','High ‚Äî admin/deploy pipeline, bypasses scoping']],nd.compromiseImpact||'medium')}
        </select>
      </div>
    </div>

    ${threats.length?`<div class="ctp-stride-row">${strides.map(s=>`<span class="ctp-badge" style="color:${strideColors[s]};border-color:${strideColors[s]}44;background:${strideColors[s]}18">${strideNames[s]}</span>`).join('')}</div>
    ${threats.map(t=>`
      <div class="ctp-threat" style="border-left-color:${sevColor[t.sev]}">
        <div class="ctp-tname"><span style="color:${sevColor[t.sev]};font-size:9px;font-family:'JetBrains Mono',monospace;margin-right:5px">${t.sev.toUpperCase()}</span>${t.name}</div>
        ${t.mits.map(m=>`<div class="ctp-mit">${m}</div>`).join('')}
      </div>`).join('')}`:''}
  </div>`;
  section.style.display='block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BLAST RADIUS ‚Äî 6-FACTOR THEORETICAL ATTACK PATH MODEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ö†Ô∏è  IMPORTANT: These are DESIGN-TIME estimates based on the
//     architecture you've drawn. Detection percentages are
//     computed from configurable weights ‚Äî they are NOT measured
//     values from live infrastructure. Do not treat them as
//     authoritative security measurements.
//
// Model factors:
//   1. TLS strength (tlsStrength)
//   2. Credential scope (canPossessCredential)
//   3. Network route existence (hasNetworkRoute)
//   4. Compromise impact level (isHighImpactCompromise)
//   5. Detector node probabilities (DETECTOR_PROBS + BFS accumulator)
//   6. IAM privilege escalation paths (getPrivEscTargets)
//
// Algorithm: BFS from a compromised source node, evaluating
// each outbound edge against the 6 factors. Detection probability
// accumulates multiplicatively: P(detected) = 1 - ‚àè(1 - P·µ¢)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _lastBlastDist=null;
let _lastBlockedEdges=new Set();
let _lastDetectScores={};  // nodeId ‚Üí detection probability 0-1
let _lastPrivEscNodes=new Set(); // nodes reachable only via privilege escalation

// ‚îÄ‚îÄ Factor 1: TLS strength score (0=none, 1=weak, 2=strong) ‚îÄ‚îÄ
function tlsStrength(enc){
  if(enc==='TLS 1.3'||enc==='TLS 1.2 (strong)')return 2;
  if(enc==='TLS 1.2 (weak ciphers)'||enc==='TLS 1.0/1.1')return 1;
  return 0; // None
}

// ‚îÄ‚îÄ Factor 2: Can a compromised node actually possess this edge's credential? ‚îÄ‚îÄ
// credScope: 'shared' = yes always, 'service-bound' = only if it's the direct source,
// 'vault' = requires admin/assumeRole privilege to retrieve
function canPossessCredential(edge, compromisedNodeId, compromisedNode){
  if(!edge.credScope||edge.credScope==='shared')return true;
  if(edge.credScope==='service-bound'){
    // Only the actual source node owns this credential
    return edge.from===compromisedNodeId;
  }
  if(edge.credScope==='vault'){
    // Vault-managed: attacker needs admin or assumeRole IAM privilege
    return ['admin','assumerole'].includes(compromisedNode?.iamPriv);
  }
  return true;
}

// ‚îÄ‚îÄ Factor 3: Network route exists between zones? ‚îÄ‚îÄ
function hasNetworkRoute(edge, fromNode, toNode){
  if(!edge.networkRoute||edge.networkRoute==='direct')return true;
  if(edge.networkRoute==='vpc-peering')return true; // peering exists, just slower
  if(edge.networkRoute==='none')return false; // explicit no-route, network-layer block
  return true;
}

// ‚îÄ‚îÄ Factor 4: Compromise impact ‚Äî high-impact nodes bypass credential checks ‚îÄ‚îÄ
// A compromised CI/CD pipeline or admin node effectively has all credentials
function isHighImpactCompromise(node){
  return node?.compromiseImpact==='high'||node?.iamPriv==='admin';
}

// ‚îÄ‚îÄ Factor 5: Detection probability accumulator ‚îÄ‚îÄ
// Each detector node (SIEM/WAF/Firewall) on a path adds detection probability.
// Modeled as: P(detected) = 1 - ‚àè(1 - P_i) across all detectors seen
const DETECTOR_PROBS={
  siem:0.85,   // SIEM has high probability of catching lateral movement
  waf:0.60,    // WAF catches known attack patterns
  firewall:0.45, // Firewall logs but may miss valid-credential lateral movement
  idp:0.70,    // IdP anomaly detection on unusual token use
};

// ‚îÄ‚îÄ Factor 6: Privilege escalation paths ‚îÄ‚îÄ
// Nodes with iamPriv=assumerole or admin can reach nodes they have no direct edge to,
// if those target nodes share the same zone OR there's an implicit admin path.
function getPrivEscTargets(nodeId, node, allNodes, edges){
  if(!['admin','assumerole'].includes(node?.iamPriv))return new Set();
  const targets=new Set();
  Object.values(allNodes).forEach(n=>{
    if(n.id===nodeId)return;
    // Admin privilege: can reach any node in same or lower-trust zone via IAM
    if(node.iamPriv==='admin'){
      targets.add(n.id); // admin can reach everything (IAM full access)
    } else if(node.iamPriv==='assumerole'){
      // AssumeRole: can reach nodes in same zone or nodes with lower privilege
      if(n.zone===node.zone||['standard','none'].includes(n.iamPriv)){
        targets.add(n.id);
      }
    }
  });
  return targets;
}

// ‚îÄ‚îÄ Master traversal check ‚îÄ‚îÄ
// Returns {traversable:bool, blockReason:string|null, detectionAdded:number}
function evaluateEdge(edge, fromNodeId, compromisedPath, allNodes){
  const fromNode=allNodes[fromNodeId];
  const toNode=allNodes[edge.to];
  const isExternal=['untrusted','hostile'].includes(fromNode?.trust);
  const isHighImpact=isHighImpactCompromise(fromNode);

  // Network layer check ‚Äî hard block regardless of anything else
  if(!hasNetworkRoute(edge,fromNode,toNode)){
    return{traversable:false,blockReason:'no-network-route',detectionAdded:0};
  }

  // For external/untrusted nodes: apply full auth+encryption+TLS checks
  if(isExternal){
    const strongAuth=['JWT','OAuth2','mTLS','IAM Role','API Key','Basic Auth'];
    const hasAuth=strongAuth.includes(edge.auth);
    const encStr=tlsStrength(edge.encryption);
    if(hasAuth&&encStr>=2){
      return{traversable:false,blockReason:'auth-and-strong-tls',detectionAdded:0};
    }
    if(hasAuth&&encStr===1){
      // Weak TLS ‚Äî auth present but encryption downgrade possible
      return{traversable:true,blockReason:null,detectionAdded:0.15};
    }
  }

  // Post-compromise internal traversal: check credential scoping
  // UNLESS high-impact compromise (admin/CI-CD) ‚Äî those bypass scoping
  if(!isExternal&&!isHighImpact){
    if(!canPossessCredential(edge,fromNodeId,fromNode)){
      return{traversable:false,blockReason:'credential-not-scoped',detectionAdded:0};
    }
  }

  // TLS downgrade risk even on internal paths (adds detection noise but traversable)
  const encStr=tlsStrength(edge.encryption);
  const detAdded=encStr===0?0.05:0; // unencrypted internal traffic is anomalous

  return{traversable:true,blockReason:null,detectionAdded:detAdded};
}

function runBlast(sourceId){
  clearBlast(false);
  blastSourceId=sourceId;
  const sourceNode=S.nodes[sourceId];

  // BFS: tracks {nodeId, hopDist, detectionAccum, path}
  const dist={};
  const detectScores={};
  const blockedEdges=new Set();
  const blockedReasons={};
  const privEscNodes=new Set();

  // Seed detection from source node itself
  const srcDetect=DETECTOR_PROBS[sourceNode?.type]||0;
  detectScores[sourceId]=srcDetect;

  const queue=[{id:sourceId,d:0,detect:srcDetect}];
  while(queue.length){
    const{id:cur,d,detect}=queue.shift();
    if(dist[cur]!==undefined)continue;
    dist[cur]=d;
    detectScores[cur]=detect;

    S.edges.forEach(e=>{
      if(e.from!==cur)return;
      const result=evaluateEdge(e,cur,dist,S.nodes);
      const toNode=S.nodes[e.to];

      if(result.traversable){
        // Accumulate detection: P(not detected) = product of (1 - P_i)
        const nodeDetect=DETECTOR_PROBS[toNode?.type]||0;
        const edgeDetect=result.detectionAdded||0;
        // Running detection: 1 - (1-prev)*(1-nodeDetect)*(1-edgeDetect)
        const prevUndetected=1-(detect||0);
        const newUndetected=prevUndetected*(1-nodeDetect)*(1-edgeDetect);
        const newDetect=Math.min(0.99,1-newUndetected);
        queue.push({id:e.to,d:d+1,detect:newDetect});
      } else {
        blockedEdges.add(e.id);
        blockedReasons[e.id]=result.blockReason;
      }
    });
  }

  // Factor 6: privilege escalation ‚Äî add nodes reachable only via IAM escalation
  if(['admin','assumerole'].includes(sourceNode?.iamPriv)){
    const escalatableTargets=getPrivEscTargets(sourceId,sourceNode,S.nodes,S.edges);
    escalatableTargets.forEach(tid=>{
      if(dist[tid]===undefined){
        privEscNodes.add(tid);
        const toNode=S.nodes[tid];
        const nodeDetect=DETECTOR_PROBS[toNode?.type]||0;
        detectScores[tid]=Math.min(0.99,1-(1-(detectScores[sourceId]||0))*(1-nodeDetect)*(1-0.4));
      }
    });
  }

  _lastBlastDist=dist;
  _lastBlockedEdges=blockedEdges;
  _lastDetectScores=detectScores;
  _lastPrivEscNodes=privEscNodes;

  // ‚îÄ‚îÄ Apply visual classes ‚îÄ‚îÄ
  Object.keys(S.nodes).forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    // Clear all
    el.classList.remove('blast-source','blast-reached','blast-reached-2','blast-safe','stride-highlight');
    el.querySelector('.detect-badge')?.remove();

    if(id===sourceId){
      el.classList.add('blast-source');
    } else if(privEscNodes.has(id)){
      el.classList.add('blast-reached-2');
      _addDetectBadge(el,detectScores[id],'PRIV-ESC');
    } else if(dist[id]===1){
      el.classList.add('blast-reached');
      _addDetectBadge(el,detectScores[id]);
    } else if(dist[id]!==undefined&&dist[id]>=2){
      el.classList.add('blast-reached-2');
      _addDetectBadge(el,detectScores[id]);
    } else {
      el.classList.add('blast-safe');
    }
  });

  // ‚îÄ‚îÄ Summary panel ‚îÄ‚îÄ
  const reached=Object.keys(dist).filter(id=>id!==sourceId).length+privEscNodes.size;
  const total=Object.keys(S.nodes).length-1;
  const pct=total>0?Math.round(reached/total*100):0;
  const blocked=blockedEdges.size;
  const privEscCount=privEscNodes.size;

  // Confidence: how often would this blast radius be detected?
  // Take the mean detection probability across all reachable nodes
  const reachableDetects=[...Object.entries(detectScores)].filter(([id])=>id!==sourceId).map(([,v])=>v);
  const privDetects=[...privEscNodes].map(id=>detectScores[id]||0);
  const allDetects=[...reachableDetects,...privDetects];
  const avgDetect=allDetects.length?allDetects.reduce((a,b)=>a+b,0)/allDetects.length:0;
  const detectPct=Math.round(avgDetect*100);

  // Summarize blocked reasons
  const reasonCounts={};
  Object.values(blockedReasons).forEach(r=>{reasonCounts[r]=(reasonCounts[r]||0)+1;});
  const reasonSummary=Object.entries(reasonCounts).map(([k,v])=>{
    const labels={'no-network-route':'üöß no network route','auth-and-strong-tls':'üõ° auth+TLS','credential-not-scoped':'üîë scoped credentials'};
    return `${v}√ó ${labels[k]||k}`;
  }).join(', ');

  document.getElementById('blastCount').innerHTML=
    `<strong style="color:#ef4444">${reached}</strong>/${total} nodes reachable (${pct}%)`+
    (privEscCount?` ¬∑ <span style="color:#a78bfa">${privEscCount} via priv-esc</span>`:'')+'<br>'+
    (blocked?`<span style="color:#34d399">Blocked: ${reasonSummary}</span><br>`:'<span style="color:var(--text3)">No edges blocked</span><br>')+
    `<span style="color:${detectPct>70?'#34d399':detectPct>35?'#facc15':'#ef4444'}">Avg detection prob: ${detectPct}%</span>`;

  redrawWithBlast(dist,blockedEdges,blockedReasons,privEscNodes);
}

// Helper: add detection probability badge to a node element
function _addDetectBadge(el,prob,label){
  if(prob===undefined)return;
  const pct=Math.round((prob||0)*100);
  const badge=document.createElement('div');
  badge.className='detect-badge '+(pct>70?'detect-high':pct>35?'detect-med':'detect-low');
  badge.textContent=label||`${pct}% det`;
  // node is already position:absolute ‚Äî do NOT override with relative here
  el.appendChild(badge);
}

function redrawWithBlast(dist,blockedEdges=new Set(),blockedReasons={},privEscNodes=new Set()){
  const svg=document.getElementById('svgLayer');
  svg.querySelectorAll('path,text,rect').forEach(el=>el.remove());
  S.edges.forEach(e=>{
    const f=pp(e.from,'r'),t=pp(e.to,'l');if(!f||!t)return;
    const dx=(t.x-f.x)*.4;
    const isTraversed=dist&&dist[e.from]!==undefined&&dist[e.to]!==undefined&&dist[e.to]===dist[e.from]+1;
    const isBlocked=blockedEdges.has(e.id);
    const reason=blockedReasons[e.id];
    const isPrivEscPath=privEscNodes.has(e.to);

    const strokeColor=isTraversed?'#ef4444':isPrivEscPath?'#a78bfa':isBlocked?(reason==='no-network-route'?'#374151':'#34d399'):(e._atkColor||ec(e));
    const strokeWidth=isTraversed||isPrivEscPath?'2.5':isBlocked?'1.5':(e._atk?'2.5':'1.5');

    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${f.x},${f.y} C${f.x+dx},${f.y} ${t.x-dx},${t.y} ${t.x},${t.y}`);
    path.setAttribute('fill','none');path.setAttribute('stroke',strokeColor);path.setAttribute('stroke-width',strokeWidth);
    path.setAttribute('class','c-norm'+(e._atk?' c-atk':''));
    if(isTraversed)path.setAttribute('filter','drop-shadow(0 0 5px #ef4444)');
    if(isPrivEscPath)path.setAttribute('filter','drop-shadow(0 0 4px #a78bfa)');
    if(isBlocked)path.setAttribute('stroke-dasharray','3 4');
    if(reason==='no-network-route')path.setAttribute('stroke-dasharray','2 6');
    svg.appendChild(path);

    const hit=document.createElementNS('http://www.w3.org/2000/svg','path');
    hit.setAttribute('d',`M${f.x},${f.y} C${f.x+dx},${f.y} ${t.x-dx},${t.y} ${t.x},${t.y}`);
    hit.setAttribute('fill','none');hit.setAttribute('stroke','transparent');hit.setAttribute('stroke-width','18');
    hit.setAttribute('class','edge-hit');hit.dataset.eid=e.id;
    hit.addEventListener('click',ev=>{ev.stopPropagation();openEdgeEditor(e.id);});
    hit.addEventListener('contextmenu',ev=>{ev.preventDefault();openEdgeEditor(e.id);});
    svg.appendChild(hit);

    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    const prefix=isBlocked?(reason==='no-network-route'?'üöß ':reason==='credential-not-scoped'?'üîë ':'üõ° '):(isPrivEscPath?'‚¨ÜÔ∏è ':'');
    lbl.setAttribute('x',(f.x+t.x)/2);lbl.setAttribute('y',(f.y+t.y)/2-6);
    lbl.setAttribute('text-anchor','middle');lbl.setAttribute('fill',strokeColor);
    lbl.setAttribute('font-size','9');lbl.setAttribute('font-family','JetBrains Mono,monospace');
    lbl.setAttribute('class','edge-hit');lbl.dataset.eid=e.id;
    lbl.style.cssText='text-decoration:underline dotted;cursor:pointer;';
    lbl.textContent=prefix+e.protocol+(e.trustBoundary!=='No'?' ‚ö†':'');
    lbl.addEventListener('click',ev=>{ev.stopPropagation();openEdgeEditor(e.id);});
    lbl.addEventListener('contextmenu',ev=>{ev.preventDefault();openEdgeEditor(e.id);});
    svg.appendChild(lbl);
  });
}

function clearBlast(resetMode=true){
  blastSourceId=null;
  _lastBlastDist=null;
  _lastBlockedEdges=new Set();
  _lastDetectScores={};
  _lastPrivEscNodes=new Set();
  Object.keys(S.nodes).forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    el.classList.remove('blast-source','blast-reached','blast-reached-2','blast-safe','atk-path-critical','atk-path-high','atk-path-entry','boundary-violation');
    el.querySelector('.detect-badge')?.remove();
  });
  const countEl=document.getElementById('blastCount');
  if(countEl)countEl.textContent='Click a node to simulate compromise';
  redraw();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDGE EDITOR
// Populates the right-panel edge inspector when a data-flow
// edge label is clicked. Allows editing protocol, auth,
// encryption, credential scope, and network route.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEdgeEditor(edgeId){
  const edge=S.edges.find(e=>e.id===edgeId);if(!edge)return;
  const from=S.nodes[edge.from],to=S.nodes[edge.to];
  const section=document.getElementById('edgeEditorSection');

  const opt=(vals,cur)=>vals.map(v=>`<option${v===cur?' selected':''}>${v}</option>`).join('');

  section.innerHTML=`<div class="edge-editor">
    <div class="edge-editor-title">
      <span>‚úèÔ∏è Edit: ${from?.label||'?'} ‚Üí ${to?.label||'?'}</span>
      <button style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px" onclick="document.getElementById('edgeEditorSection').style.display='none'">‚úï</button>
    </div>
    <div class="ee-row">
      <div class="ee-fg"><span class="ee-lbl">Protocol</span>
        <select class="ee-sel" onchange="updateEdge('${edgeId}','protocol',this.value)">
          ${opt(['HTTPS','HTTP','TCP','UDP','gRPC','WebSocket','AMQP','SQL','Redis','S3'],edge.protocol)}</select></div>
      <div class="ee-fg"><span class="ee-lbl">Data Class</span>
        <select class="ee-sel" onchange="updateEdge('${edgeId}','dataClass',this.value)">
          ${opt(['Public','Internal','Confidential','Restricted','PII','PHI','PCI'],edge.dataClass)}</select></div>
    </div>
    <div class="ee-row">
      <div class="ee-fg"><span class="ee-lbl">Auth</span>
        <select class="ee-sel" onchange="updateEdge('${edgeId}','auth',this.value)">
          ${opt(['None','API Key','JWT','OAuth2','mTLS','IAM Role','Basic Auth'],edge.auth)}</select></div>
      <div class="ee-fg"><span class="ee-lbl">Encryption</span>
        <select class="ee-sel" onchange="updateEdge('${edgeId}','encryption',this.value)">
          ${opt(['TLS 1.3','TLS 1.2 (strong)','TLS 1.2 (weak ciphers)','TLS 1.0/1.1','None'],edge.encryption)}</select></div>
    </div>
    <div class="ee-row">
      <div class="ee-fg"><span class="ee-lbl">Credential Scope</span>
        <select class="ee-sel" onchange="updateEdge('${edgeId}','credScope',this.value)">
          ${opt(['shared','service-bound','vault'],edge.credScope||'shared')}</select></div>
      <div class="ee-fg"><span class="ee-lbl">Network Route</span>
        <select class="ee-sel" onchange="updateEdge('${edgeId}','networkRoute',this.value)">
          ${opt(['direct','vpc-peering','none'],edge.networkRoute||'direct')}</select></div>
    </div>
    <div class="ee-fg" style="margin-bottom:6px"><span class="ee-lbl">Trust Boundary</span>
      <select class="ee-sel" onchange="updateEdge('${edgeId}','trustBoundary',this.value)">
        ${opt(['No','Yes ‚Äî Internet to DMZ','Yes ‚Äî DMZ to Internal','Yes ‚Äî Internal to Restricted'],edge.trustBoundary)}</select></div>
    <button class="ee-del" onclick="deleteEdge('${edgeId}')">üóë Delete This Connection</button>
  </div>`;
  section.style.display='block';

  // Switch to analyze mode so the panel is visible
  if(appMode==='blast'){setMode('analyze');}
}

function updateEdge(edgeId,field,val){
  const edge=S.edges.find(e=>e.id===edgeId);
  if(edge){
    edge[field]=val;
    if(blastSourceId)runBlast(blastSourceId);
    else redraw();
  }
}

function deleteEdge(edgeId){
  S.edges=S.edges.filter(e=>e.id!==edgeId);
  document.getElementById('edgeEditorSection').style.display='none';
  redraw();
}

// Update a node property and re-render its panel
function updateNodeTrustZone(nodeId,tz){
  if(!S.nodes[nodeId])return;
  S.nodes[nodeId].trustZone=tz;
  // Update zone CSS class
  const el=document.getElementById(nodeId);
  if(el){
    el.classList.remove('tz-internet-node','tz-dmz-node','tz-internal-node','tz-secure-node');
    el.classList.add('tz-'+tz+'-node');
  }
  renderTrustZoneOverlays();
  if(blastSourceId)runBlast(blastSourceId);
}
function updateNodeProp(nodeId,prop,val){
  if(!S.nodes[nodeId])return;
  if(prop.startsWith('props.')){
    // Handle nested props: props.dataClassification ‚Üí S.nodes[id].props.dataClassification
    const key=prop.slice(6); // remove 'props.'
    if(!S.nodes[nodeId].props)S.nodes[nodeId].props={};
    S.nodes[nodeId].props[key]=val;
  } else {
    S.nodes[nodeId][prop]=val;
  }
  // If blast is active and this is the source, re-run blast with new props
  if(blastSourceId)runBlast(blastSourceId);
}
let dragType=null;
document.querySelectorAll('.pal-item[draggable]').forEach(el=>{el.addEventListener('dragstart',e=>{dragType=el.dataset.type;e.dataTransfer.effectAllowed='copy';});});
const canvasWrap=document.getElementById('canvasWrap');
canvasWrap.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy';});
canvasWrap.addEventListener('drop',e=>{
  e.preventDefault();if(!dragType)return;
  const r=canvasWrap.getBoundingClientRect();
  // Divide by zoom scale so dropped position is correct in canvas-space
  const x=(e.clientX-r.left-vpX)/vpZ-58;
  const y=(e.clientY-r.top-vpY)/vpZ-28;
  const id=createNode(dragType,x,y);
  dragType=null;upHint();
  if(id){setMode('analyze');showComponentThreats(id);}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NODE CREATION & MANAGEMENT
// createNode() builds a node DOM element and adds it to S.nodes.
// makeDrag() attaches mouse-based drag behavior to a node element.
// selNode() updates the right-panel property inspector.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createNode(type,x,y){
  const def=DEFS[type];if(!def)return;
  const id='n'+S.nextId++;
  // trustZone map from zone string for nodes not explicitly defined
  const _zoneTZ={public:'internet',dmz:'dmz',private:'internal',isolated:'restricted'};
  S.nodes[id]={id,type,x,y,label:def.label,trust:def.trust,
    zone:def.zone||'private',
    trustZone:def.trustZone||_zoneTZ[def.zone||'private']||'internal',
    iamPriv:def.iamPriv||'standard',
    compromiseImpact:'medium',
    isDetector:!!def.isDetector
  };
  const el=document.createElement('div');el.className='node';el.id=id;
  el.style.left=x+'px';el.style.top=y+'px';
  // Build structure without interpolating user-controlled strings into innerHTML
  el.innerHTML=`<div class="node-hdr" style="background:${def.color}18"><span class="node-ico"></span><span class="node-title" style="color:${def.color}"></span></div><div class="node-body"><span class="node-body-text"></span><br><span style="color:var(--text3);font-size:9px"></span></div><div class="node-pills" id="pills-${id}"></div><div class="port port-r" data-node="${id}"></div><div class="port port-l" data-node="${id}"></div>`;
  // Safe textContent assignment ‚Äî immune to XSS
  el.querySelector('.node-ico').textContent=def.icon;
  el.querySelector('.node-title').textContent=def.label;
  el.querySelector('.node-body-text').textContent=def.body;
  el.querySelectorAll('.node-body span')[1].textContent=def.trust.toUpperCase();
  // Port events
  el.querySelectorAll('.port').forEach(p=>p.addEventListener('mousedown',e=>{e.stopPropagation();handlePort(id,p);}));
  // Node click: use mouseup to detect clean click vs drag
  let _clickX,_clickY;
  el.addEventListener('mousedown',e=>{if(e.target.classList.contains('port'))return;_clickX=e.clientX;_clickY=e.clientY;});
  el.addEventListener('mouseup',e=>{
    if(e.target.classList.contains('port'))return;
    if(Math.abs(e.clientX-_clickX)<5&&Math.abs(e.clientY-_clickY)<5)selNode(id);
  });
  makeDrag(el,S.nodes[id]);
  // Apply trust zone class for visual zone indicator
  const tz=S.nodes[id].trustZone||'internal';
  el.classList.add('tz-'+tz+'-node');
  document.getElementById('canvas').appendChild(el);
  return id;
}
function makeDrag(el,nd){
  let sx,sy,sl,st,moved=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('port'))return;
    e.preventDefault();sx=e.clientX;sy=e.clientY;sl=nd.x;st=nd.y;moved=false;
    const mv=e2=>{
      // Divide by vpZ: mouse moves in screen-px, node coords are canvas-px
      const dx=(e2.clientX-sx)/vpZ,dy=(e2.clientY-sy)/vpZ;
      if(Math.abs(dx)>3||Math.abs(dy)>3)moved=true;
      nd.x=sl+dx;nd.y=st+dy;el.style.left=nd.x+'px';el.style.top=nd.y+'px';
      if(blastSourceId)redrawWithBlast(_lastBlastDist,_lastBlockedEdges,{},_lastPrivEscNodes);else redraw();
      _debounceTZOverlay();
    };
    const up=()=>{
      document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);
    };
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
  });
}
function selNode(id){
  if(S.sel){const p=document.getElementById(S.sel);if(p)p.classList.remove('selected');}
  S.sel=id;
  const el=document.getElementById(id);if(el)el.classList.add('selected');
  if(appMode==='blast'){
    runBlast(id);
  } else {
    showComponentThreats(id);
    document.getElementById('edgeEditorSection').style.display='none';
  }
}
function handlePort(nodeId,portEl){
  if(!S.connecting){S.connecting={nodeId,portEl};portEl.classList.add('active');document.getElementById('canvas').style.cursor='crosshair';}
  else{if(S.connecting.nodeId===nodeId){S.connecting.portEl.classList.remove('active');S.connecting=null;document.getElementById('canvas').style.cursor='';return;}
    S.connecting.portEl.classList.remove('active');S.pendConn={from:S.connecting.nodeId,to:nodeId};S.connecting=null;document.getElementById('canvas').style.cursor='';document.getElementById('connModal').style.display='flex';}
}
function cancelConn(){S.pendConn=null;document.getElementById('connModal').style.display='none';}
function confirmConn(){
  if(!S.pendConn)return;
  const e={id:'e'+S.nextId++,from:S.pendConn.from,to:S.pendConn.to,
    protocol:document.getElementById('cp').value,
    dataClass:document.getElementById('cd').value,
    auth:document.getElementById('ca').value,
    encryption:document.getElementById('ce').value,
    credScope:document.getElementById('ccs').value,
    networkRoute:document.getElementById('cnr').value,
    trustBoundary:document.getElementById('ctb').value,
    _atk:false,_atkColor:null};
  if(!S.edges.find(x=>x.from===e.from&&x.to===e.to))S.edges.push(e);
  S.pendConn=null;document.getElementById('connModal').style.display='none';redraw();
}
document.addEventListener('keydown',e=>{
  if((e.key==='Delete'||e.key==='Backspace')&&S.sel&&document.activeElement.tagName==='BODY'){const el=document.getElementById(S.sel);if(el)el.remove();delete S.nodes[S.sel];S.edges=S.edges.filter(ed=>ed.from!==S.sel&&ed.to!==S.sel);S.sel=null;redraw();upHint();}
  if(e.key==='a'&&document.activeElement.tagName==='BODY')runAnalysis();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SVG EDGE RENDERING
// pp()    ‚Äî returns the {x,y} port position for a node side ('r'ight/'l'eft)
// ec()    ‚Äî returns the edge stroke color based on encryption/auth status
// redraw() ‚Äî clears and redraws all SVG edges on the canvas layer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pp(id,side){const nd=S.nodes[id];const el=document.getElementById(id);if(!nd||!el)return{x:0,y:0};return side==='r'?{x:nd.x+el.offsetWidth,y:nd.y+el.offsetHeight/2}:{x:nd.x,y:nd.y+el.offsetHeight/2};}
function ec(e){if(e.encryption==='None')return'#ef4444';if(e.auth==='None')return'#facc15';return'#f59e0b';}
function redraw(){
  const svg=document.getElementById('svgLayer');
  svg.querySelectorAll('path,text,rect').forEach(el=>el.remove());
  S.edges.forEach(e=>{
    const f=pp(e.from,'r'),t=pp(e.to,'l');if(!f||!t)return;
    const dx=(t.x-f.x)*.4;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${f.x},${f.y} C${f.x+dx},${f.y} ${t.x-dx},${t.y} ${t.x},${t.y}`);
    path.setAttribute('fill','none');path.setAttribute('stroke',e._atkColor||ec(e));path.setAttribute('stroke-width',e._atk?'2.5':'1.5');
    path.setAttribute('class','c-norm'+(e._atk?' c-atk':''));
    if(e._atk)path.setAttribute('filter',`drop-shadow(0 0 4px ${e._atkColor})`);
    svg.appendChild(path);
    // Invisible wide hit area ‚Äî click or right-click opens edge editor
    const hit=document.createElementNS('http://www.w3.org/2000/svg','path');
    hit.setAttribute('d',`M${f.x},${f.y} C${f.x+dx},${f.y} ${t.x-dx},${t.y} ${t.x},${t.y}`);
    hit.setAttribute('fill','none');hit.setAttribute('stroke','transparent');hit.setAttribute('stroke-width','18');
    hit.setAttribute('class','edge-hit');hit.dataset.eid=e.id;
    hit.addEventListener('click',ev=>{ev.stopPropagation();openEdgeEditor(e.id);});
    hit.addEventListener('contextmenu',ev=>{ev.preventDefault();openEdgeEditor(e.id);});
    svg.appendChild(hit);
    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x',(f.x+t.x)/2);lbl.setAttribute('y',(f.y+t.y)/2-6);lbl.setAttribute('text-anchor','middle');lbl.setAttribute('fill',ec(e));lbl.setAttribute('font-size','9');lbl.setAttribute('font-family','JetBrains Mono,monospace');
    lbl.setAttribute('class','edge-hit');lbl.dataset.eid=e.id;
    lbl.style.cssText='text-decoration:underline dotted;cursor:pointer;';
    const srcNd=S.nodes[e.from||e.source],tgtNd=S.nodes[e.to||e.target];
    const isBV=srcNd&&tgtNd&&(srcNd.trustZone||'internal')!==(tgtNd.trustZone||'internal');
    lbl.textContent=e.protocol+(isBV?' üöß':'')+(e.trustBoundary!=='No'?' ‚ö†':'');
    lbl.addEventListener('click',ev=>{ev.stopPropagation();openEdgeEditor(e.id);});
    lbl.addEventListener('contextmenu',ev=>{ev.preventDefault();openEdgeEditor(e.id);});
    svg.appendChild(lbl);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYSIS UTILITIES
// rr()     ‚Äî Risk Rating matrix: maps (likelihood, impact) ‚Üí risk level string
// sc()     ‚Äî Severity Color: maps severity string ‚Üí hex color
// sn()     ‚Äî Stride Name: maps STRIDE letter ‚Üí full category name
// scolor() ‚Äî Stride Color: maps STRIDE letter ‚Üí hex color
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sc(s){return{critical:'#ef4444',high:'#f97316',medium:'#facc15',low:'#34d399'}[s]||'#888';}
function sn(s){return{S:'Spoofing',T:'Tampering',R:'Repudiation',I:'Information Disclosure',D:'Denial of Service',E:'Elevation of Privilege'}[s]||s;}
function scolor(s){return{S:'#9b59b6',T:'#e67e22',R:'#3498db',I:'#e74c3c',D:'#2ecc71',E:'#ff6b6b'}[s]||'#888';}
function rr(l,i){const m={'High,High':'Critical','High,Medium':'High','High,Low':'Medium','Medium,High':'High','Medium,Medium':'Medium','Medium,Low':'Low','Low,High':'Medium','Low,Medium':'Low','Low,Low':'Low'};return m[`${l},${i}`]||'Medium';}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRAPH INTELLIGENCE ENGINE ‚Äî v2
// Implements full attack path detection, trust boundary
// violation analysis, and context-aware path rules.
//
// Public API:
//   buildGraph(nodes, edges)           ‚Üí adjacency map
//   findAllPaths(graph, startId, max)  ‚Üí all paths (BFS)
//   getEntryNodes(nodes)               ‚Üí internet-zone nodes
//   detectAttackPaths(nodes, edges)    ‚Üí [{path,risk,reason,owasp}]
//   detectBoundaryViolations(nodes,edges) ‚Üí [{...finding}]
//   evaluatePathRules(graph,nodes,edges) ‚Üí [{...threat}]
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Trust zone ordering (lower = less trusted)
const TZ_ORDER={internet:0,dmz:1,internal:2,restricted:3};

// Build adjacency list using the FORMAL graph model (source/target + from/to alias)
function buildGraph(nodes,edges){
  const graph={};
  const nodeArr=Array.isArray(nodes)?nodes:Object.values(nodes);
  nodeArr.forEach(n=>{graph[n.id]=[];});
  edges.forEach(e=>{
    const src=e.source||e.from;
    const tgt=e.target||e.to;
    if(graph[src]!==undefined)graph[src].push({target:tgt,edge:e});
  });
  return graph;
}

// BFS: find ALL paths from startNode up to maxDepth hops
// Returns array of path arrays (each path = array of nodeIds)
function findAllPaths(graph,startNode,maxDepth=5){
  const paths=[];
  // queue entries: [currentPath] where currentPath is array of nodeIds
  const queue=[[startNode]];
  const MAX_PATHS=200; // circuit-breaker for large graphs
  while(queue.length>0&&paths.length<MAX_PATHS){
    const path=queue.shift();
    const last=path[path.length-1];
    if(path.length>maxDepth)continue;
    const neighbors=graph[last]||[];
    for(const neighbor of neighbors){
      // Avoid infinite loops in cyclic graphs
      if(path.includes(neighbor.target))continue;
      const newPath=[...path,neighbor.target];
      paths.push(newPath);
      queue.push(newPath);
    }
  }
  return paths;
}

// Return all nodes in the 'internet' trust zone (BFS entry points)
function getEntryNodes(nodes){
  const nodeArr=Array.isArray(nodes)?nodes:Object.values(nodes);
  return nodeArr.filter(n=>
    n.trustZone==='internet'||
    n.zone==='public'||
    ['internet','user','attacker'].includes(n.type)
  );
}

// Resolve a nodeId to the node object from either array or object map
function _resolveNode(nodes,id){
  if(Array.isArray(nodes))return nodes.find(n=>n.id===id);
  return nodes[id];
}

// Detect attack paths: internet entry ‚Üí any node containing 'secret'/'pii' data
// Also detect internet ‚Üí database paths
function detectAttackPaths(nodes,edges){
  let apIdx=1;
  const nodeArr=Array.isArray(nodes)?nodes:Object.values(nodes);
  const graph=buildGraph(nodes,edges);
  const entryNodes=getEntryNodes(nodes);
  const attackPaths=[];

  entryNodes.forEach(entry=>{
    const allPaths=findAllPaths(graph,entry.id,6);
    allPaths.forEach(path=>{
      if(path.length<2)return;
      const targetId=path[path.length-1];
      const targetNode=_resolveNode(nodes,targetId);
      if(!targetNode)return;

      const isHighValue=
        targetNode.type==='database'||
        targetNode.type==='storage'||
        targetNode.trustZone==='restricted'||
        ['secret','pii','phi','pci'].includes((targetNode.props?.dataClassification||'').toLowerCase());

      if(!isHighValue)return;

      // Determine if the path has any security weaknesses
      const pathEdges=[];
      for(let i=0;i<path.length-1;i++){
        const e=edges.find(ed=>(ed.from||ed.source)===path[i]&&(ed.to||ed.target)===path[i+1]);
        if(e)pathEdges.push(e);
      }
      const hasUnencrypted=pathEdges.some(e=>!e.encryption||e.encryption==='None'||e.encryption==='none');
      const hasNoAuth=pathEdges.some(e=>!e.auth||e.auth==='None'||e.auth==='none');
      const crossesBoundary=path.some((nid,i)=>{
        if(i===0)return false;
        const prev=_resolveNode(nodes,path[i-1]);
        const cur=_resolveNode(nodes,nid);
        if(!prev||!cur)return false;
        return (prev.trustZone||'internal')!==(cur.trustZone||'internal');
      });

      // Risk calculation
      let risk='HIGH';
      let reasons=[];
      if(entry.type==='attacker')risk='CRITICAL';
      if(targetNode.trustZone==='restricted'||targetNode.type==='database'){
        if(hasUnencrypted&&hasNoAuth)risk='CRITICAL';
      }
      if(hasUnencrypted)reasons.push('plaintext channel');
      if(hasNoAuth)reasons.push('unauthenticated edge');
      if(crossesBoundary)reasons.push('trust boundary crossed');

      attackPaths.push({
        id:'AP-'+(apIdx++),
        path,
        pathLabels:path.map(id=>{
          const n=_resolveNode(nodes,id);
          return n?n.label:id;
        }),
        risk,
        entryNode:entry,
        targetNode,
        reasons,
        reason:reasons.length?reasons.join(', '):'Path from internet to sensitive data',
        owasp:'A01:2021 Broken Access Control',
        hasUnencrypted,
        hasNoAuth,
        crossesBoundary,
        pathEdges,
      });
    });
  });

  // Deduplicate: keep only highest-risk path per (entry,target) pair
  const seen=new Map();
  attackPaths.forEach(ap=>{
    const key=ap.path[0]+':'+ap.path[ap.path.length-1];
    const riskOrd={CRITICAL:0,HIGH:1,MEDIUM:2,LOW:3};
    const existing=seen.get(key);
    if(!existing||riskOrd[ap.risk]<riskOrd[existing.risk])seen.set(key,ap);
  });
  return [...seen.values()].sort((a,b)=>{
    const ord={CRITICAL:0,HIGH:1,MEDIUM:2,LOW:3};
    return ord[a.risk]-ord[b.risk];
  });
}

// Detect trust boundary violations: edges crossing zones without proper security
function detectBoundaryViolations(nodes,edges){
  const findings=[];
  const tzColors={internet:'#ff6b6b',dmz:'#ff8c00',internal:'#60a5fa',secure:'#34d399'};

  edges.forEach(edge=>{
    const srcId=edge.source||edge.from;
    const tgtId=edge.target||edge.to;
    const source=_resolveNode(nodes,srcId);
    const target=_resolveNode(nodes,tgtId);
    if(!source||!target)return;

    const srcZone=source.trustZone||source.zone||'internal';
    const tgtZone=target.trustZone||target.zone||'internal';
    const crossingBoundary=srcZone!==tgtZone;
    if(!crossingBoundary)return;

    const noAuth=!edge.auth||edge.auth==='None'||edge.auth==='none';
    const noEnc=!edge.encryption||edge.encryption==='None'||edge.encryption==='none';
    const isEscalating=TZ_ORDER[srcZone]===undefined||TZ_ORDER[tgtZone]===undefined
      ? false
      : TZ_ORDER[srcZone]<TZ_ORDER[tgtZone]; // going toward more secure zone

    let severity='Medium';
    let sevKey='medium';
    if(noAuth&&noEnc&&isEscalating){severity='Critical';sevKey='critical';}
    else if(noAuth||noEnc){severity='High';sevKey='high';}

    if(noAuth||noEnc){
      findings.push({
        id:'BV-'+edge.id,
        type:'boundary',
        ruleType:'edge',
        threat:'Insecure Trust Boundary Crossing',
        name:'Insecure Trust Boundary Crossing',
        stride:'E',
        sev:sevKey,
        owasp:'A01:2021 Broken Access Control',
        severity,
        edgeId:edge.id,
        srcZone,tgtZone,
        sourceName:source.label||srcId,
        targetName:target.label||tgtId,
        sourceId:srcId,
        targetId:tgtId,
        isEscalating,
        noAuth,noEnc,
        desc:`${source.label||srcId} (${srcZone}) ‚Üí ${target.label||tgtId} (${tgtZone}) crosses a trust boundary without ${noAuth&&noEnc?'authentication or encryption':noAuth?'authentication':'encryption'}. This allows unauthorized access across security zones.`,
        like:'High',
        imp:'High',
        mits:[
          'Enforce mTLS at every trust boundary crossing',
          'Require strong authentication (JWT/OAuth2) for cross-zone calls',
          'Deploy an API gateway or service mesh at zone boundaries',
          'Use network micro-segmentation to enforce zone isolation',
        ],
        affected:[srcId,tgtId],
      });
    }
  });
  return findings;
}

// Path-level rule evaluation ‚Äî evaluates rules that require path context
function evaluatePathRules(graph,nodes,edges){
  const findings=[];
  const nodeArr=Array.isArray(nodes)?nodes:Object.values(nodes);
  const entryNodes=getEntryNodes(nodes);

  // PATH RULE 1: Privilege escalation path
  // Any path containing an admin-role node with an unauthenticated edge
  const pathPrivEscRule={
    id:'PR-001',
    name:'Privilege Escalation Path (Graph)',
    stride:'E',
    sev:'critical',
    like:'Medium',
    imp:'High',
    owasp:'A01:2021 Broken Access Control',
    desc:'A traversal path exists containing an admin-privileged node reachable via an unauthenticated edge. An attacker can exploit the missing auth to inherit elevated privileges.',
    mits:['Enforce authentication on every edge involving admin-role nodes','Implement least-privilege: no admin credentials for application paths','Add network-layer ACLs to block unauthenticated admin access'],
  };
  entryNodes.forEach(entry=>{
    const allPaths=findAllPaths(graph,entry.id,5);
    allPaths.forEach(path=>{
      const hasAdmin=path.some(nid=>{
        const n=_resolveNode(nodes,nid);
        return n?.iamPriv==='admin'||(n?.props?.role==='admin');
      });
      if(!hasAdmin)return;
      const hasNoAuthEdge=path.some((_,i)=>{
        if(i===0)return false;
        const e=edges.find(ed=>(ed.from||ed.source)===path[i-1]&&(ed.to||ed.target)===path[i]);
        return e&&(!e.auth||e.auth==='None'||e.auth==='none');
      });
      if(hasAdmin&&hasNoAuthEdge){
        const aff=[...new Set(path)];
        // Only push once per finding set
        if(!findings.find(f=>f.id===pathPrivEscRule.id)){
          findings.push({...pathPrivEscRule,affected:aff,
            desc:pathPrivEscRule.desc+` Path: ${path.map(id=>{const n=_resolveNode(nodes,id);return n?.label||id;}).join(' ‚Üí ')}`
          });
        }
      }
    });
  });

  // PATH RULE 2: Internet ‚Üí Internal ‚Üí Secure (deep penetration path)
  const deepPenetrateRule={
    id:'PR-002',
    name:'Deep Penetration Path (Internet ‚Üí Restricted Zone)',
    stride:'E',
    sev:'critical',
    like:'High',
    imp:'High',
    owasp:'A01:2021 Broken Access Control',
    desc:'An internet-origin actor can traverse through intermediate zones to reach a restricted zone via a path with insufficient controls.',
    mits:['Add WAF and firewall between internet and internal zones','Enforce zero-trust: every hop must authenticate','Deploy intrusion detection on zone boundary traffic'],
  };
  entryNodes.forEach(entry=>{
    const allPaths=findAllPaths(graph,entry.id,6);
    allPaths.forEach(path=>{
      const zones=path.map(nid=>{
        const n=_resolveNode(nodes,nid);
        return n?.trustZone||'internal';
      });
      // Only flag if path ends in restricted zone AND path has genuine security weaknesses
      const hasInternet=zones[0]==='internet';
      const hasRestricted=zones[zones.length-1]==='restricted';
      if(!hasInternet||!hasRestricted||path.length<3)return;
      // Collect edges on path and check for missing controls
      const pathEdges=[];
      for(let i=0;i<path.length-1;i++){
        const e=edges.find(ed=>(ed.from||ed.source)===path[i]&&(ed.to||ed.target)===path[i+1]);
        if(e)pathEdges.push(e);
      }
      const hasNoAuth=pathEdges.some(e=>!e.auth||e.auth==='None'||e.auth==='none');
      const hasNoEnc=pathEdges.some(e=>!e.encryption||e.encryption==='None'||e.encryption==='none');
      // Only fire if path is genuinely insecure: missing auth AND missing encryption
      if(hasNoAuth&&hasNoEnc){
        const pathLabels=path.map(id=>{const n=_resolveNode(nodes,id);return n?.label||id;}).join(' ‚Üí ');
        const existingRule=findings.find(f=>f.id===deepPenetrateRule.id);
        if(!existingRule){
          findings.push({...deepPenetrateRule,
            affected:[...new Set(path)],
            desc:`Multi-zone penetration path detected: ${pathLabels}. An internet-origin actor can traverse through intermediate zones to reach the restricted zone via unauthenticated, unencrypted connections.`,
          });
        }
      }
    });
  });

  return findings;
}

// ‚îÄ‚îÄ‚îÄ Attack Path UI State ‚îÄ‚îÄ‚îÄ
let S_attackPaths=[];      // Last computed attack paths
let S_boundaryFindings=[]; // Last computed boundary violations
let S_pathFindings=[];     // Last computed path rule results
let _highlightedPathIdx=-1; // Which AP is currently highlighted

// Highlight a specific attack path on the canvas + SVG
function highlightAttackPath(apIdx){
  // Clear previous highlights
  clearAttackPathHighlights();
  const ap=S_attackPaths[apIdx];
  if(!ap)return;
  _highlightedPathIdx=apIdx;

  // Highlight nodes in path
  ap.path.forEach((nid,i)=>{
    const el=document.getElementById(nid);
    if(!el)return;
    if(i===0)el.classList.add('atk-path-entry');
    else if(i===ap.path.length-1)el.classList.add('atk-path-critical');
    else el.classList.add('atk-path-high');
  });

  // Re-render SVG with path edges highlighted in red
  _renderSVGWithAttackPath(ap);
}

function clearAttackPathHighlights(){
  document.querySelectorAll('.node').forEach(el=>{
    el.classList.remove('atk-path-critical','atk-path-high','atk-path-entry');
  });
  _highlightedPathIdx=-1;
  redraw(); // restore normal SVG
}

function _renderSVGWithAttackPath(ap){
  // Overlay attack path edges in red on top of normal SVG
  const svg=document.getElementById('svgLayer');
  // Remove old attack path overlays
  svg.querySelectorAll('.ap-edge-overlay').forEach(el=>el.remove());

  const pathEdgeSet=new Set();
  for(let i=0;i<ap.path.length-1;i++){
    pathEdgeSet.add(ap.path[i]+'->'+ap.path[i+1]);
  }

  S.edges.forEach(e=>{
    const from=e.from||e.source;
    const to=e.to||e.target;
    if(!pathEdgeSet.has(from+'->'+to))return;
    const f=pp(from,'r'),t=pp(to,'l');
    if(!f||!t)return;
    const dx=(t.x-f.x)*.4;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${f.x},${f.y} C${f.x+dx},${f.y} ${t.x-dx},${t.y} ${t.x},${t.y}`);
    path.setAttribute('fill','none');
    path.setAttribute('stroke','#ef4444');
    path.setAttribute('stroke-width','3');
    path.setAttribute('stroke-dasharray','8 4');
    path.setAttribute('class','ap-edge-overlay');
    path.setAttribute('filter','drop-shadow(0 0 6px #ef4444)');
    path.style.animation='dash 1s linear infinite';
    svg.appendChild(path);
  });
}

// Render the Attack Paths panel
function renderAttackPaths(){
  const con=document.getElementById('attackPathsContainer');
  if(!con)return;

  if(!S_attackPaths.length&&!S_boundaryFindings.length&&!S_pathFindings.length){
    con.innerHTML='<div style="text-align:center;color:var(--text3);padding:16px 0;font-size:11px">No attack paths detected.<br>Run analysis first.</div>';
    return;
  }

  const riskColor={CRITICAL:'#ef4444',HIGH:'#f97316',MEDIUM:'#facc15',LOW:'#34d399'};
  const tzColor={internet:'#ff6b6b',dmz:'#ff8c00',internal:'#60a5fa',secure:'#34d399'};

  let html='';

  // Attack paths section
  if(S_attackPaths.length){
    html+=`<div style="font-size:10px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-bottom:7px">‚öîÔ∏è Attack Paths (${S_attackPaths.length})</div>`;
    S_attackPaths.forEach((ap,i)=>{
      const rc=riskColor[ap.risk]||'#f97316';
      const pathViz=ap.pathLabels.map((lbl,j)=>
        `<span class="ap-node-chip ${j===0?'ap-entry':j===ap.pathLabels.length-1?'ap-target':''}">${lbl}</span>`+
        (j<ap.pathLabels.length-1?'<span class="ap-arrow">‚Üí</span>':'')
      ).join('');
      html+=`<div class="ap-panel" onclick="highlightAttackPath(${i})" title="Click to highlight on canvas">
        <div class="ap-header">
          <span class="ap-risk-badge" style="background:${rc}22;color:${rc};border:1px solid ${rc}44">${ap.risk}</span>
          <span style="font-size:10px;font-weight:700;color:var(--text)">Path ${i+1}</span>
          <span style="font-size:9px;color:var(--text3);margin-left:auto">${ap.path.length} hops</span>
        </div>
        <div class="ap-path-viz">${pathViz}</div>
        <div class="ap-reason">${ap.reason}</div>
        <div class="ap-owasp">üîó ${ap.owasp}</div>
      </div>`;
    });
  }

  // Path rule findings
  if(S_pathFindings.length){
    html+=`<div style="font-size:10px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin:10px 0 7px">üîó Path Rules (${S_pathFindings.length})</div>`;
    S_pathFindings.forEach(f=>{
      html+=`<div class="ap-panel" style="border-color:rgba(249,115,22,.3)">
        <div class="ap-header">
          <span class="ap-risk-badge" style="background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)">${f.sev.toUpperCase()}</span>
          <span style="font-size:10px;font-weight:700;color:var(--text)">${f.name}</span>
        </div>
        <div class="ap-reason" style="margin-top:4px">${f.desc}</div>
        <div class="ap-owasp">üîó ${f.owasp||''}</div>
      </div>`;
    });
  }

  // Boundary violations section
  if(S_boundaryFindings.length){
    html+=`<div style="font-size:10px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin:10px 0 7px">üöß Boundary Violations (${S_boundaryFindings.length})</div>`;
    S_boundaryFindings.forEach(bv=>{
      const sc2=bv.severity==='Critical'?'#ef4444':bv.severity==='High'?'#f97316':'#facc15';
      html+=`<div class="bv-card">
        <div class="bv-flow">
          <span class="bv-zone" style="background:${(tzColor[bv.srcZone]||'#888')}22;color:${tzColor[bv.srcZone]||'#888'}">${bv.srcZone.toUpperCase()}</span>
          <span>‚Üí</span>
          <span class="bv-zone" style="background:${(tzColor[bv.tgtZone]||'#888')}22;color:${tzColor[bv.tgtZone]||'#888'}">${bv.tgtZone.toUpperCase()}</span>
          <span style="margin-left:auto;font-size:9px;font-weight:800;color:${sc2}">${bv.severity.toUpperCase()}</span>
        </div>
        <div style="font-size:10px;color:var(--text2)">${bv.sourceName} ‚Üí ${bv.targetName}</div>
        <div style="font-size:9px;color:var(--text3);margin-top:3px">${bv.noAuth?'‚ùå No Auth':''}${bv.noAuth&&bv.noEnc?' ¬∑ ':''}${bv.noEnc?'‚ùå No Encryption':''}</div>
        <div class="ap-owasp">üîó ${bv.owasp}</div>
      </div>`;
    });
  }

  con.innerHTML=html||'<div style="text-align:center;color:var(--low);padding:12px 0;font-size:11px">‚úÖ No attack paths or violations</div>';
}

// Full unified analysis pipeline
function runFullAnalysis(nodes,edges){
  const graph=buildGraph(nodes,edges);
  S_attackPaths=detectAttackPaths(nodes,edges);
  S_boundaryFindings=detectBoundaryViolations(nodes,edges);
  S_pathFindings=evaluatePathRules(graph,nodes,edges);

  // Merge boundary + path findings into S.threats (as proper rule results)
  const mergeAsThreats=(findings)=>{
    findings.forEach(f=>{
      if(!S.threats.find(t=>t.id===f.id)){
        S.threats.push({...f});
        (f.affected||[]).forEach(nid=>{
          const pp2=document.getElementById('pills-'+nid);
          if(pp2&&!pp2.querySelector('[data-t="'+f.id+'"]')){
            const pill=document.createElement('span');
            pill.className='pill';
            pill.dataset.t=f.id;
            pill.style.cssText=`background:${sc(f.sev)}22;color:${sc(f.sev)};border:1px solid ${sc(f.sev)}55`;
            pill.textContent=f.id;
            pp2.appendChild(pill);
          }
        });
        if(!S.cmRows[f.id])S.cmRows[f.id]={response:'Mitigate',status:'Non-Mitigated'};
      }
    });
  };

  mergeAsThreats(S_boundaryFindings);
  mergeAsThreats(S_pathFindings);

  // Highlight boundary violation nodes on canvas
  S_boundaryFindings.forEach(bv=>{
    const srcEl=document.getElementById(bv.sourceId);
    const tgtEl=document.getElementById(bv.targetId);
    if(srcEl)srcEl.classList.add('boundary-violation');
    if(tgtEl)tgtEl.classList.add('boundary-violation');
  });

  renderAttackPaths();
  renderTrustZoneOverlays();
}

// Render trust zone background overlays on canvas
function renderTrustZoneOverlays(){
  document.querySelectorAll('.trust-zone-overlay').forEach(el=>el.remove());
  const canvas=document.getElementById('canvas');
  if(!canvas||!Object.keys(S.nodes).length)return;

  const TZ={
    internet:{cls:'tz-internet',lbl:'tz-label-internet',name:'üåê INTERNET'},
    dmz:     {cls:'tz-dmz',     lbl:'tz-label-dmz',     name:'üî∂ DMZ'},
    internal:{cls:'tz-internal',lbl:'tz-label-internal', name:'üîµ INTERNAL'},
    restricted:{cls:'tz-secure',lbl:'tz-label-secure',   name:'üîí RESTRICTED'},
  };

  const LANE_PAD_X   = 18;   // horizontal padding inside each swim lane
  const LANE_PAD_TOP = 36;   // top padding ‚Äî label lives here
  const LANE_PAD_BOT = 20;   // bottom padding

  // Group nodes by trustZone
  const groups={internet:[],dmz:[],internal:[],restricted:[]};
  Object.values(S.nodes).forEach(nd=>{
    const tz=nd.trustZone||'internal';
    if(groups[tz])groups[tz].push(nd);
  });

  // Two-rAF approach: first rAF lets browser finish layout, second reads sizes
  requestAnimationFrame(()=>{requestAnimationFrame(()=>{
    document.querySelectorAll('.trust-zone-overlay').forEach(el=>el.remove());

    // Measure each zone's bounding box
    const zoneBox={};
    let gY0=Infinity, gY1=-Infinity;

    Object.entries(groups).forEach(([tz,nds])=>{
      if(!nds.length)return;
      let x0=Infinity,y0=Infinity,x1=-Infinity,y1=-Infinity;
      nds.forEach(nd=>{
        const el=document.getElementById(nd.id);
        // Use nd.x (always canonical) + offsetWidth (accurate after double-rAF)
        const w=el&&el.offsetWidth>30?el.offsetWidth:180;
        const h=el&&el.offsetHeight>30?el.offsetHeight:90;
        x0=Math.min(x0,nd.x);
        y0=Math.min(y0,nd.y);
        x1=Math.max(x1,nd.x+w);
        y1=Math.max(y1,nd.y+h);
      });
      zoneBox[tz]={x0,x1,y0,y1};
      gY0=Math.min(gY0,y0);
      gY1=Math.max(gY1,y1);
    });

    if(gY0===Infinity)return;

    // All lanes share the same top/bottom ‚Äî clean swim-lane appearance
    const laneTop    = gY0 - LANE_PAD_TOP;
    const laneHeight = gY1 - gY0 + LANE_PAD_TOP + LANE_PAD_BOT;

    Object.entries(TZ).forEach(([tz,cfg])=>{
      const bx=zoneBox[tz];
      if(!bx)return;

      const div=document.createElement('div');
      div.className='trust-zone-overlay '+cfg.cls;
      div.setAttribute('data-tz',tz);
      div.style.cssText=
        `left:${bx.x0-LANE_PAD_X}px;`+
        `top:${laneTop}px;`+
        `width:${bx.x1-bx.x0+LANE_PAD_X*2}px;`+
        `height:${laneHeight}px;`;

      const lbl=document.createElement('div');
      lbl.className='tz-label '+cfg.lbl;
      lbl.textContent=cfg.name;
      div.appendChild(lbl);

      canvas.insertBefore(div,canvas.firstChild);
    });
  });});
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODEL NORMALIZATION (Enhanced Rule Engine)
// Enriches nodes and edges with formal props required by the
// 6-rule OWASP threat engine. Missing fields are defaulted.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function normalizeNodes(nodes){
  // Zone ‚Üí trustZone canonical mapping
  const zoneTZMap={public:'internet',dmz:'dmz',private:'internal',isolated:'restricted'};
  Object.values(nodes).forEach(nd=>{
    if(!nd.props)nd.props={};
    // Ensure trustZone is set from DEFS or zone field
    if(!nd.trustZone){
      const def=DEFS[nd.type];
      nd.trustZone=def?.trustZone||zoneTZMap[nd.zone||'private']||'internal';
    }
    // dataClassification on node ‚Äî driven by trustZone for richer semantics
    if(nd.props.dataClassification===undefined){
      const tzDC={internet:'public',dmz:'internal',internal:'internal',restricted:'secret'};
      nd.props.dataClassification=nd.type==='database'?'secret':
        (tzDC[nd.trustZone]||'internal');
    }
    if(nd.props.auth===undefined){
      // API nodes default to auth:false (unauthenticated) ‚Äî triggers R-001
      nd.props.auth=!['api','webserver'].includes(nd.type);
    }
    if(nd.props.encryption===undefined){
      // Default to true for all types; R-002 uses inbound edge encryption checks,
      // not this props flag, so we do not force false for databases here.
      nd.props.encryption=true;
    }
    if(nd.props.role===undefined){
      nd.props.role=nd.iamPriv==='admin'?'admin':(nd.iamPriv==='assumerole'?'service':'user');
    }
    if(nd.props.exposed===undefined){
      nd.props.exposed=nd.zone==='public'||['internet','user','attacker'].includes(nd.type);
    }
    // dataClassification set above via trustZone
  });
}
function normalizeEdges(edges){
  edges.forEach(e=>{
    // Canonical protocol (uppercase) for HTTP detection
    if(!e.normalizedProtocol)e.normalizedProtocol=(e.protocol||'').toUpperCase();
    // dataClassification alias for R-004/R-005 rule compatibility
    if(!e.dataClassification)e.dataClassification=e.dataClass||'Public';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRIDE ANALYSIS ENGINE
// runAnalysis() normalizes data model, evaluates all RULES,
// then renders results to the threat register and canvas pills.
// Results are stored in S.threats[] and rendered in the threat
// register (Step 2 right panel + Step 3 countermeasures table).
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runAnalysis(){
  if(!Object.keys(S.nodes).length){alert('Add components to the DFD first.');return;}
  document.querySelectorAll('.node-pills').forEach(p=>p.innerHTML='');
  S.threats=[];
  // Step 1: Normalize data model (add default props if missing)
  normalizeNodes(S.nodes);
  normalizeEdges(S.edges);
  // Step 2: Build graph ‚Äî all rules share adjacency list
  const adj=buildAdjacency(S.nodes,S.edges);
  // Step 3: Evaluate node rules, edge rules, graph/path rules
  for(const rule of RULES){
    const res=rule.check(S.nodes,S.edges,adj);
    if(res){
      S.threats.push({...rule,affected:res.aff||[]});
      (res.aff||[]).forEach(nid=>{const pp2=document.getElementById('pills-'+nid);if(pp2&&!pp2.querySelector(`[data-t="${rule.id}"]`)){const pill=document.createElement('span');pill.className='pill';pill.dataset.t=rule.id;pill.style.cssText=`background:${sc(rule.sev)}22;color:${sc(rule.sev)};border:1px solid ${sc(rule.sev)}55`;pill.textContent=rule.id;pp2.appendChild(pill);}});
      if(!S.cmRows[rule.id])S.cmRows[rule.id]={response:'Mitigate',status:'Non-Mitigated'};
    }
  }
  // Step 4: Run full unified analysis pipeline (attack paths + boundary violations + path rules)
  runFullAnalysis(S.nodes,S.edges);

  renderDetected();
  const cnts={S:0,T:0,R:0,I:0,D:0,E:0};
  S.threats.forEach(t=>cnts[t.stride]=(cnts[t.stride]||0)+1);
  Object.entries(cnts).forEach(([k,v])=>{const el=document.getElementById('c'+k);if(el)el.textContent=v;});
  const apCount=S_attackPaths.length;
  const bvCount=S_boundaryFindings.length;
  document.getElementById('statusBar').textContent=
    `Analysis complete ‚Äî ${S.threats.length} threats ¬∑ ${apCount} attack paths ¬∑ ${bvCount} boundary violations`;
  document.getElementById('stab3').classList.add('done');
  // Update attack path panel tab badge
  const apBadge=document.getElementById('apTabBadge');
  if(apBadge)apBadge.textContent=apCount+bvCount;
}

function renderDetected(){
  const con=document.getElementById('detectedThreats');
  if(!S.threats.length){con.innerHTML='<div style="text-align:center;color:var(--low);padding:20px 0;font-size:12px">‚úÖ No threats detected</div>';return;}
  const ord={critical:0,high:1,medium:2,low:3};
  const sorted=[...S.threats].sort((a,b)=>ord[a.sev]-ord[b.sev]);
  // Triage-first: collapsed by default, click to expand
  // Enhanced rules (R-00x) show OWASP mapping + rule engine badge
  con.innerHTML=sorted.map(t=>{
    const isEnhanced=t.id&&t.id.startsWith('R-');
    const owaspBadge=t.owasp?`<div style="font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--info);background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.3);border-radius:3px;padding:2px 5px;margin-bottom:5px;display:inline-block">üîó ${t.owasp}</div>`:'';
    const typeBadge=isEnhanced?`<span style="font-size:8px;background:rgba(245,158,11,.15);color:var(--accent);border:1px solid rgba(245,158,11,.3);border-radius:2px;padding:1px 4px;margin-left:4px;font-family:'JetBrains Mono',monospace">RULE ENGINE</span>`:'';
    return`
    <div class="threat-card tc-collapsed" id="tc-${t.id}" onclick="toggleThreatCard('${t.id}')">
      <div class="tc-head" style="cursor:pointer;margin-bottom:0">
        <div class="sev-dot" style="background:${sc(t.sev)}"></div>
        <div style="flex:1;min-width:0">
          <div class="tc-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${t.name}</div>
          <div class="tc-id">${t.id}${typeBadge} ¬∑ <span style="color:${sc(t.sev)}">${t.sev.toUpperCase()}</span></div>
        </div>
        <span style="font-size:10px;color:var(--text3);flex-shrink:0;padding-left:4px" id="tc-chevron-${t.id}">‚ñ∏</span>
      </div>
      <div class="tc-body" id="tc-body-${t.id}" style="display:none;margin-top:8px">
        <span class="tc-stride" style="color:${scolor(t.stride)};border-color:${scolor(t.stride)}44">${sn(t.stride)}</span>
        ${owaspBadge}
        <div class="tc-desc">${t.desc}</div>
        ${t.mits.map(m=>`<div class="tc-mit">${m}</div>`).join('')}
      </div>
    </div>`;
  }).join('');
}

function switchRpTab(tab){
  ['threats','paths'].forEach(t=>{
    document.getElementById('rpTab-'+t).classList.toggle('active',t===tab);
    document.getElementById('rpPanel-'+t).style.display=t===tab?'block':'none';
  });
  if(tab==='paths'&&S_attackPaths.length===0&&S_boundaryFindings.length===0){
    // Don't clear highlights when switching if paths exist
  }
  if(tab==='threats')clearAttackPathHighlights();
}

function toggleThreatCard(id){
  const body=document.getElementById('tc-body-'+id);
  const chevron=document.getElementById('tc-chevron-'+id);
  const card=document.getElementById('tc-'+id);
  const open=body.style.display==='none';
  body.style.display=open?'block':'none';
  chevron.textContent=open?'‚ñæ':'‚ñ∏';
  card.classList.toggle('tc-collapsed',!open);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTERMEASURES FILTER
// strideFilter holds the currently active STRIDE category filter (null = all).
// filterSTRIDE() toggles the filter and highlights affected canvas nodes.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let strideFilter=null;
function filterSTRIDE(s,el){
  strideFilter=strideFilter===s?null:s;
  document.querySelectorAll('.stride-card').forEach((c,i)=>c.classList.toggle('af',['S','T','R','I','D','E'][i]===strideFilter));
  renderCM();
  // Highlight affected nodes on canvas
  document.querySelectorAll('.node').forEach(n=>n.classList.remove('stride-highlight'));
  if(strideFilter){
    const affNodes=new Set();
    S.threats.filter(t=>t.stride===strideFilter).forEach(t=>(t.affected||[]).forEach(id=>affNodes.add(id)));
    affNodes.forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('stride-highlight');});
  }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTERMEASURES REGISTER (Step 3)
// Renders S.threats[] as an editable table where users can set
// Accept/Eliminate/Mitigate/Transfer per threat and track status.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCM(){
  const tbody=document.getElementById('cmTbody');
  const th=strideFilter?S.threats.filter(t=>t.stride===strideFilter):S.threats;
  if(!th.length){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;color:var(--text3);padding:28px">Run analysis in Step 2 first</td></tr>';return;}
  const ord={critical:0,high:1,medium:2,low:3};
  tbody.innerHTML=[...th].sort((a,b)=>ord[a.sev]-ord[b.sev]).map(t=>{
    const row=S.cmRows[t.id]||{response:'Mitigate',status:'Non-Mitigated'};
    const risk=rr(t.like,t.imp);
    return`<tr><td>${t.id}${t.owasp?'<br><span style="font-size:8px;color:var(--info);font-family:\'JetBrains Mono\',monospace">'+t.owasp+'</span>':''}</td><td style="color:var(--text);font-weight:600;font-size:12px">${t.name}</td><td><span style="font-size:10px;padding:2px 5px;border-radius:3px;background:${scolor(t.stride)}22;color:${scolor(t.stride)};border:1px solid ${scolor(t.stride)}44;font-family:'JetBrains Mono',monospace">${t.stride}</span></td><td style="font-size:11px;font-weight:700;color:${sc(t.sev)}">${t.sev.toUpperCase()}</td><td style="font-size:11px">${t.like}</td><td style="font-size:11px">${t.imp}</td><td style="font-size:11px;font-weight:700;color:${sc(risk.toLowerCase())}">${risk}</td><td><select class="cm-select" onchange="updCM('${t.id}','response',this.value)"><option ${row.response==='Mitigate'?'selected':''}>Mitigate</option><option ${row.response==='Accept'?'selected':''}>Accept</option><option ${row.response==='Eliminate'?'selected':''}>Eliminate</option><option ${row.response==='Transfer'?'selected':''}>Transfer</option></select></td><td><select class="cm-select" onchange="updCM('${t.id}','status',this.value)"><option ${row.status==='Non-Mitigated'?'selected':''}>Non-Mitigated</option><option ${row.status==='Partial'?'selected':''}>Partial</option><option ${row.status==='Mitigated'?'selected':''}>Mitigated</option></select></td></tr>`;
  }).join('');
}
function updCM(id,field,val){if(!S.cmRows[id])S.cmRows[id]={response:'Mitigate',status:'Non-Mitigated'};S.cmRows[id][field]=val;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXECUTIVE SUMMARY ‚Äî MATURITY METRICS
// calculateMaturityMetrics() is the single source of truth for
// all KPI data used by the executive summary modal and the
// exported report. All callers must read from this function.
//
// Maturity levels (based on CMMI-inspired model):
//   Initial  ‚Äî criticals > 0, or no analysis run
//   Defined  ‚Äî criticals < 3, partial mitigation
//   Managed  ‚Äî zero criticals, >70% of threats mitigated
//   Proactive ‚Äî zero criticals, >80% mitigated (shown as "Proactive / Secure Design")
//
// DREAD scoring: threats don't carry explicit DREAD fields in
// the current rule schema, so we approximate from severity:
//   critical‚Üí9, high‚Üí7, medium‚Üí5, low‚Üí3
// This is intentionally simple ‚Äî the score is a directional
// indicator, not a precise measurement.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculateMaturityMetrics(){
  const total   = S.threats.length;
  const criticals = S.threats.filter(t=>t.sev==='critical').length;
  const highs   = S.threats.filter(t=>t.sev==='high').length;
  const mitigated = Object.values(S.cmRows).filter(r=>r.status==='Mitigated').length;
  const partial = Object.values(S.cmRows).filter(r=>r.status==='Partial').length;
  const mitigPct= total > 0 ? mitigated / total : 0;

  // Approximate DREAD average from severity (see comment above)
  const sevDread = {critical:9, high:7, medium:5, low:3};
  const totalDread = S.threats.reduce((acc,t)=>acc+(sevDread[t.sev]||5),0);
  const avgDread   = total > 0 ? (totalDread/total).toFixed(1) : '‚Äî';

  // Detection confidence: presence of SIEM/WAF/Firewall nodes in the DFD
  const nodeTypes = Object.values(S.nodes).map(n=>n.type);
  const detectors = ['siem','waf','firewall'].filter(t=>nodeTypes.includes(t));
  // P(detected) modelled as 1 - ‚àè(1 - P_i) using DETECTOR_PROBS weights
  const detProbs  = {siem:0.85, waf:0.60, firewall:0.45};
  const detectConf= detectors.length
    ? Math.round((1 - detectors.reduce((p,t)=>p*(1-detProbs[t]),1))*100)
    : 0;
  const detectorNodes = detectors.map(t=>Object.values(S.nodes).find(n=>n.type===t)).filter(Boolean);

  // Maturity level determination
  let level, statusColor, levelDesc;
  if(total===0){
    level='Not Assessed'; statusColor='var(--text3)';
    levelDesc='No analysis has been run. Build a DFD and run analysis first.';
  } else if(criticals>0){
    level='Initial'; statusColor='var(--crit)';
    levelDesc='Critical vulnerabilities require immediate remediation before deployment.';
  } else if(mitigPct>0.8){
    level='Proactive'; statusColor='var(--low)';
    levelDesc='Security posture exceeds baseline. Architecture demonstrates secure-by-design principles.';
  } else if(mitigPct>0.7 && criticals===0){
    level='Managed'; statusColor='var(--low)';
    levelDesc='Risk is well-understood and largely under control. Continue mitigation progress.';
  } else if(criticals<3){
    level='Defined'; statusColor='var(--med)';
    levelDesc='Threats are identified but mitigation coverage needs improvement.';
  } else {
    level='Initial'; statusColor='var(--crit)';
    levelDesc='High number of unresolved critical risks. Prioritize remediation immediately.';
  }

  // STRIDE business-impact narratives (only included if that category has threats)
  const STRIDE_NARRATIVES = {
    S:'Potential for unauthorized identity assumption, credential theft, and fraudulent transactions.',
    T:'Risk of data integrity violations, undetected modification of records, and audit log tampering.',
    R:'Inability to attribute actions to users, undermining audit trails and regulatory accountability.',
    I:'Risk of regulatory non-compliance (GDPR / PCI-DSS / HIPAA) and loss of customer trust through data exposure.',
    D:'Operational risk involving service downtime, SLA breaches, and direct revenue loss.',
    E:'Attackers may gain administrative control, enabling lateral movement across the entire system.',
  };
  const activeNarratives = [...new Set(S.threats.map(t=>t.stride))]
    .filter(s=>STRIDE_NARRATIVES[s])
    .map(s=>({stride:s,name:sn(s),text:STRIDE_NARRATIVES[s]}));

  // Action plan items
  const actions=[];
  if(criticals>0)
    actions.push({tag:'IMMEDIATE',color:'var(--crit)',bg:'rgba(239,68,68,.1)',
      text:`Remediate ${criticals} critical vulnerabilit${criticals===1?'y':'ies'}. Secure unencrypted data paths and implement missing WAF/Firewall controls.`});
  if(!detectors.includes('waf')&&!detectors.includes('firewall'))
    actions.push({tag:'HIGH PRIORITY',color:'var(--high)',bg:'rgba(249,115,22,.1)',
      text:'No WAF or Firewall detected in the architecture. Add perimeter controls to reduce attack surface.'});
  if(mitigated<total)
    actions.push({tag:'SHORT-TERM',color:'var(--accent)',bg:'rgba(245,158,11,.1)',
      text:`Complete countermeasure register for ${total-mitigated} pending threat${total-mitigated===1?'':'s'}.`});
  if(!detectors.includes('siem'))
    actions.push({tag:'ONGOING',color:'var(--info)',bg:'rgba(96,165,250,.1)',
      text:'No SIEM detected. Implement centralized log aggregation and anomaly alerting for operational visibility.'});
  if(actions.length===0)
    actions.push({tag:'MAINTAIN',color:'var(--low)',bg:'rgba(52,211,153,.1)',
      text:'Security posture is strong. Schedule periodic threat model reviews as architecture evolves.'});

  return{
    total,criticals,highs,mitigated,partial,mitigPct,
    avgDread,detectConf,detectors,detectorNodes,
    level,statusColor,levelDesc,
    activeNarratives,actions,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXECUTIVE SUMMARY HTML BUILDER
// Generates the full inner HTML for both the modal view and
// the "Management Overview" section prepended to exportReport().
// `forExport=true` switches to light-mode inline styles
// suitable for a standalone HTML document.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildExecSummaryHTML(m, forExport=false){
  const appName  = document.getElementById('appName').value||'Unnamed Application';
  const appVer   = document.getElementById('appVersion').value||'1.0';
  const docOwner = document.getElementById('docOwner').value||'‚Äî';
  const docDate  = document.getElementById('docDate').value||new Date().toISOString().split('T')[0];

  const mitigPct = m.total>0 ? Math.round(m.mitigPct*100) : 0;

  // Maturity band colour vars ‚Äî resolved to hex for export mode
  const colorMap={'var(--crit)':'#ef4444','var(--high)':'#f97316','var(--med)':'#facc15',
    'var(--low)':'#34d399','var(--accent)':'#f59e0b','var(--info)':'#60a5fa','var(--text3)':'#3d5275'};
  const col = c => forExport ? (colorMap[c]||c) : c;

  if(forExport){
    // ‚îÄ‚îÄ Light-mode export version ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const narrativeRows = m.activeNarratives.map(n=>
      `<tr><td style="font-weight:700;white-space:nowrap;color:${col(scolor(n.stride))}">${n.name}</td><td style="color:#444">${n.text}</td></tr>`
    ).join('');
    const actionRows = m.actions.map(a=>
      `<tr><td style="font-weight:700;white-space:nowrap;color:${col(a.color)}">${a.tag}</td><td style="color:#444">${a.text}</td></tr>`
    ).join('');
    return `
<div style="page-break-after:always;border:1px solid #ddd;border-radius:10px;padding:28px 32px;margin-bottom:32px;font-family:Arial,sans-serif">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
    <div>
      <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#888;margin-bottom:4px">MANAGEMENT OVERVIEW</div>
      <div style="font-size:22px;font-weight:800;color:#111">${appName} <span style="font-weight:400;font-size:16px;color:#666">v${appVer}</span></div>
      <div style="font-size:12px;color:#666;margin-top:2px">Prepared by ${docOwner} ¬∑ ${docDate}</div>
    </div>
    <div style="background:${col(m.statusColor)}18;border:1px solid ${col(m.statusColor)}44;border-radius:8px;padding:10px 16px;text-align:center">
      <div style="font-size:18px;font-weight:800;color:${col(m.statusColor)};font-family:monospace">${m.level}</div>
      <div style="font-size:10px;color:#666;font-weight:700;letter-spacing:.5px;text-transform:uppercase">Security Maturity</div>
    </div>
  </div>
  <div style="background:#f8f9fa;border-left:4px solid ${col(m.statusColor)};padding:12px 16px;border-radius:0 8px 8px 0;font-size:13px;color:#333;margin-bottom:20px">
    ${m.levelDesc} This architecture contains <strong>${m.criticals} critical</strong> and <strong>${m.highs} high</strong> severity threats.
    The average DREAD risk score is <strong>${m.avgDread}/10</strong>.
  </div>
  <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
    <tr>
      <td style="width:25%;padding:12px;background:#f1f5f9;border-radius:8px;text-align:center">
        <div style="font-size:28px;font-weight:800;color:#ef4444;font-family:monospace">${m.total}</div>
        <div style="font-size:11px;color:#666;text-transform:uppercase;font-weight:700">Total Threats</div>
      </td>
      <td style="width:4%"></td>
      <td style="width:25%;padding:12px;background:#f1f5f9;border-radius:8px;text-align:center">
        <div style="font-size:28px;font-weight:800;color:#ef4444;font-family:monospace">${m.criticals}</div>
        <div style="font-size:11px;color:#666;text-transform:uppercase;font-weight:700">Critical</div>
      </td>
      <td style="width:4%"></td>
      <td style="width:25%;padding:12px;background:#f1f5f9;border-radius:8px;text-align:center">
        <div style="font-size:28px;font-weight:800;color:#f59e0b;font-family:monospace">${m.avgDread}/10</div>
        <div style="font-size:11px;color:#666;text-transform:uppercase;font-weight:700">Avg DREAD Score</div>
      </td>
      <td style="width:4%"></td>
      <td style="width:25%;padding:12px;background:#f1f5f9;border-radius:8px;text-align:center">
        <div style="font-size:28px;font-weight:800;color:#16a34a;font-family:monospace">${m.detectConf}%</div>
        <div style="font-size:11px;color:#666;text-transform:uppercase;font-weight:700">Detection Confidence</div>
      </td>
    </tr>
  </table>
  <div style="margin-bottom:18px">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#888;margin-bottom:6px">Mitigation Progress ‚Äî ${mitigPct}% of threats mitigated (${m.mitigated}/${m.total})</div>
    <div style="background:#e5e7eb;border-radius:6px;height:10px;overflow:hidden">
      <div style="height:100%;width:${mitigPct}%;background:${mitigPct>80?'#16a34a':mitigPct>50?'#f59e0b':'#ef4444'};border-radius:6px"></div>
    </div>
  </div>
  ${m.activeNarratives.length?`
  <div style="margin-bottom:18px">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#888;margin-bottom:8px">Business Risk by Threat Category</div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr><th style="text-align:left;padding:6px 10px;background:#f1f5f9;border-radius:4px;font-size:10px;letter-spacing:.5px">CATEGORY</th><th style="text-align:left;padding:6px 10px;background:#f1f5f9;font-size:10px;letter-spacing:.5px">BUSINESS IMPACT</th></tr></thead>
      <tbody>${narrativeRows}</tbody>
    </table>
  </div>`:''}
  <div>
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#888;margin-bottom:8px">Recommended Actions</div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <tbody>${actionRows}</tbody>
    </table>
  </div>
  <div style="margin-top:16px;font-size:10px;color:#999;border-top:1px solid #eee;padding-top:10px">
    ‚ö† This summary is generated from a design-time threat model. Detection confidence is a theoretical estimate based on architecture configuration, not measured against live infrastructure. Validate findings with penetration testing before production deployment.
  </div>
</div>`;
  }

  // ‚îÄ‚îÄ Dark-mode modal version ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const narrativeItems = m.activeNarratives.map(n=>`
    <div class="exec-risk-item" style="border-left-color:${scolor(n.stride)}">
      <div class="exec-risk-cat" style="color:${scolor(n.stride)}">${n.name}</div>
      <div class="exec-risk-text">${n.text}</div>
    </div>`).join('');

  const actionItems = m.actions.map(a=>`
    <div class="exec-action">
      <div class="exec-action-tag" style="background:${a.bg};color:${a.color}">${a.tag}</div>
      <div class="exec-action-text">${a.text}</div>
    </div>`).join('');

  const detectorChips = m.detectorNodes.length
    ? m.detectorNodes.map(n=>`<span class="detect-node-chip" style="background:rgba(52,211,153,.12);color:var(--low);border:1px solid rgba(52,211,153,.3)">${n.label}</span>`).join('')
    : `<span class="detect-node-chip" style="background:rgba(239,68,68,.12);color:var(--crit);border:1px solid rgba(239,68,68,.3)">None detected</span>`;

  const barColor = mitigPct>80?'var(--low)':mitigPct>50?'var(--accent)':'var(--crit)';

  return `
    <div class="exec-header">
      <div>
        <div class="exec-title">üìã Executive Security Summary</div>
        <div class="exec-subtitle">${appName} v${appVer} ¬∑ ${docOwner} ¬∑ ${docDate}</div>
      </div>
      <button class="exec-close" onclick="closeExecSummary()" title="Close">‚úï</button>
    </div>

    <!-- Maturity Band -->
    <div class="maturity-band" style="background:${m.statusColor}10;border-color:${m.statusColor}40">
      <div>
        <div class="maturity-level" style="color:${m.statusColor}">${m.level}</div>
        <div class="maturity-label" style="color:${m.statusColor}">Security Maturity</div>
      </div>
      <div class="maturity-desc">${m.levelDesc}</div>
    </div>

    <!-- KPI row -->
    <div class="exec-kpis">
      <div class="exec-kpi">
        <div class="exec-kpi-val" style="color:var(--crit)">${m.total}</div>
        <div class="exec-kpi-lbl">Total Threats</div>
      </div>
      <div class="exec-kpi">
        <div class="exec-kpi-val" style="color:var(--crit)">${m.criticals}</div>
        <div class="exec-kpi-lbl">Critical</div>
      </div>
      <div class="exec-kpi">
        <div class="exec-kpi-val" style="color:var(--accent)">${m.avgDread}/10</div>
        <div class="exec-kpi-lbl">Avg DREAD Score</div>
      </div>
      <div class="exec-kpi">
        <div class="exec-kpi-val" style="color:${m.detectConf>60?'var(--low)':m.detectConf>30?'var(--med)':'var(--crit)'}">${m.detectConf}%</div>
        <div class="exec-kpi-lbl">Detection Confidence</div>
      </div>
    </div>

    <!-- Risk vs Mitigation progress -->
    <div class="exec-section">
      <div class="exec-section-title">Risk vs. Mitigation</div>
      <div class="exec-progress-label">
        <span>${m.mitigated} of ${m.total} threats mitigated</span>
        <span style="color:${barColor}">${mitigPct}%</span>
      </div>
      <div class="exec-progress-wrap">
        <div class="exec-progress-bar" style="width:${mitigPct}%;background:${barColor}"></div>
      </div>
    </div>

    <!-- Risk Impact Statement -->
    <div class="exec-section">
      <div class="exec-section-title">Risk Impact Statement</div>
      <div class="exec-narrative">
        This architecture currently contains <strong style="color:${m.statusColor}">${m.criticals} critical</strong>
        and <strong style="color:var(--high)">${m.highs} high</strong> severity vulnerabilities.
        The average DREAD risk score across all identified threats is <strong>${m.avgDread}/10</strong>.
        ${m.criticals>0
          ? 'Immediate remediation is required before this system is considered safe for production.'
          : m.mitigPct>0.8
            ? 'The security posture is strong. Continue monitoring and review as the architecture evolves.'
            : 'Mitigation coverage should be increased before sign-off.'}
      </div>
    </div>

    <!-- Business Risk Narratives -->
    ${m.activeNarratives.length?`
    <div class="exec-section">
      <div class="exec-section-title">Business Risk by Threat Category</div>
      ${narrativeItems}
    </div>`:''}

    <!-- Detection Confidence -->
    <div class="exec-section">
      <div class="exec-section-title">Detection Coverage</div>
      <div class="exec-narrative">
        <div style="margin-bottom:6px">Detection confidence is <strong style="color:${m.detectConf>60?'var(--low)':m.detectConf>30?'var(--med)':'var(--crit)'}">${m.detectConf}%</strong>
        based on ${m.detectors.length?m.detectors.join(', ').toUpperCase()+' node':'no detection'} presence in the DFD.
        ${m.detectConf<60?'Adding SIEM, WAF, and Firewall nodes will improve detection coverage.':''}</div>
        <div class="detect-nodes">${detectorChips}</div>
        <div style="margin-top:8px;font-size:10px;color:var(--text3)">‚ö† Detection confidence is a design-time estimate ‚Äî validate with penetration testing and red-team exercises against live infrastructure.</div>
      </div>
    </div>

    <!-- Action Plan -->
    <div class="exec-section">
      <div class="exec-section-title">Action Plan</div>
      ${actionItems}
    </div>

    <div class="exec-footer">
      <button class="btn btn-primary" style="flex:1" onclick="exportReport()">‚¨á Export Full Report (includes this summary)</button>
      <button class="btn btn-ghost" onclick="closeExecSummary()">Close</button>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXECUTIVE SUMMARY MODAL ‚Äî OPEN / CLOSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openExecSummary(){
  if(!S.threats.length){
    alert('Run analysis in Step 2 first to generate an executive summary.');
    return;
  }
  const m = calculateMaturityMetrics();
  document.getElementById('execModalContent').innerHTML = buildExecSummaryHTML(m, false);
  document.getElementById('execModal').style.display = 'flex';
}
function closeExecSummary(){
  document.getElementById('execModal').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASSESSMENT (Step 4)
// Refreshes the checklist scorecard: counts nodes, edges, threats,
// and criticals to produce a completeness/readiness summary.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshAssess(){
  const nc=Object.keys(S.nodes).length,ec=S.edges.length,th=S.threats.length;
  const crit=S.threats.filter(t=>t.sev==='critical').length;
  const high=S.threats.filter(t=>t.sev==='high').length;
  const med=S.threats.filter(t=>t.sev==='medium').length;
  const mit=Object.values(S.cmRows).filter(r=>r.status==='Mitigated').length;
  const par=Object.values(S.cmRows).filter(r=>r.status==='Partial').length;
  document.getElementById('aN').textContent=nc;document.getElementById('aE').textContent=ec;document.getElementById('aT').textContent=th;
  document.getElementById('aC').textContent=crit;document.getElementById('aH').textContent=high;document.getElementById('aM').textContent=med;
  document.getElementById('aMit').textContent=mit;document.getElementById('aPar').textContent=par;document.getElementById('aUnm').textContent=Math.max(0,th-mit-par);
  const name=document.getElementById('appName').value.trim();
  const desc=document.getElementById('appDesc').value.trim();
  const owner=document.getElementById('docOwner').value.trim();
  const entryR=document.getElementById('entryTbody').querySelectorAll('tr').length;
  const exitR=document.getElementById('exitTbody').querySelectorAll('tr').length;
  const trustR=document.getElementById('trustTbody').querySelectorAll('tr').length;
  const assetR=document.getElementById('assetsTbody').querySelectorAll('tr').length;
  setChk('kDfd',nc>0&&ec>0);
  setChk('kScope',!!(name&&desc&&owner));
  setChk('kEntry',entryR>0&&exitR>0);
  setChk('kTrust',trustR>0);
  setChk('kAssets',assetR>0);
  setChk('kThreats',th>0);
  setChk('kControls',th>0&&Object.keys(S.cmRows).length>=th);
  setChk('kRisk',th>0);
}
function setChk(id,ok){const el=document.getElementById(id);if(!el)return;el.textContent=ok?'‚úì Done':'‚úó Missing';el.className='chk-status '+(ok?'chk-ok':'chk-fail');}

// ‚ïê‚ïê‚ïê SIMULATION ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRAFFIC SIMULATION & ATTACK VISUALIZATION
// Simulates benign packet flows across edges and can replay
// named attack patterns (SQLi, DDoS, lateral movement, exfil)
// by animating colored particles along data-flow paths.
// These are for VISUALIZATION only ‚Äî not actual attacks.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSim(){S.simRunning?stopSim():startSim();}
function startSim(){
  if(!S.edges.length){alert('Add data flows first.');return;}
  S.simRunning=true;S.pkt=0;
  document.getElementById('simDot').classList.add('run');
  document.getElementById('simLbl').textContent='RUNNING';document.getElementById('simLbl').style.color='var(--accent)';
  document.getElementById('simToggleBtn').textContent='‚èπ Stop Traffic Sim';
  S.simInt=setInterval(()=>{S.pkt+=Math.floor(Math.random()*50+10);document.getElementById('pktCnt').textContent=S.pkt.toLocaleString();if(S.edges.length)spawnP(S.edges[Math.floor(Math.random()*S.edges.length)]);},200);
}
function stopSim(){
  clearInterval(S.simInt);S.simRunning=false;
  S.edges.forEach(e=>{e._atk=false;e._atkColor=null;});
  document.getElementById('simDot').classList.remove('run');
  document.getElementById('simLbl').textContent='IDLE';document.getElementById('simLbl').style.color='var(--text3)';
  document.getElementById('simToggleBtn').textContent='‚ñ∂ Start Traffic Sim';
  redraw();
}
function spawnP(edge){
  const f=pp(edge.from,'r'),t=pp(edge.to,'l');if(!f||!t)return;
  const p=document.createElement('div');p.className='particle';const c=edge._atkColor||ec(edge);
  p.style.cssText=`background:${c};box-shadow:0 0 5px ${c};left:${f.x}px;top:${f.y-2.5}px`;
  document.getElementById('canvas').appendChild(p);
  let step=0;const a=setInterval(()=>{step++;const tt=step/18;p.style.left=(f.x+(t.x-f.x)*tt)+'px';p.style.top=((f.y+(t.y-f.y)*tt)-2.5)+'px';p.style.opacity=1-tt*.3;if(step>=18){clearInterval(a);p.remove();}},700/18);
}
async function runAttack(type){
  if(!Object.keys(S.nodes).length){alert('Add components first.');return;}
  const sc2={sqli:{name:'SQL Injection',color:'#ff4444',tgt:['api','webserver','database'],steps:['Scanning endpoints...','Sending malformed SQL payloads...','Attempting auth bypass...','Checking blind SQLi...','Exploiting error-based injection...']},ddos:{name:'DDoS Flood',color:'#ff8c00',tgt:['webserver','loadbalancer','cdn'],steps:['Spawning botnet nodes...','Initiating SYN flood...','Saturating bandwidth...','Testing rate limiting...','Volumetric amplification...']},lateral:{name:'Lateral Movement',color:'#ffd700',tgt:['microservice','api','database','cache'],steps:['Foothold established...','Enumerating internal network...','Scanning weak credentials...','Privilege escalation...','Pivoting toward data stores...']},exfil:{name:'Data Exfiltration',color:'#ff4444',tgt:['database','storage','cache'],steps:['Locating data stores...','Staging covert channel...','Encoding data...','DNS tunneling attempt...','Evading DLP controls...']}};
  const s=sc2[type];if(!s)return;
  for(const step of s.steps){
    await sleep(500);
    S.edges.forEach(e=>{const to=S.nodes[e.to];if(to&&s.tgt.includes(to.type)){e._atk=true;e._atkColor=s.color;spawnP(e);const nel=document.getElementById(e.to);if(nel){nel.classList.add('threatened');setTimeout(()=>nel.classList.remove('threatened'),1800);}}});
    redraw();
  }
  S.trig++;document.getElementById('trigCnt').textContent=S.trig;
  await sleep(2000);
  S.edges.forEach(e=>{e._atk=false;e._atkColor=null;});redraw();
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// ‚ïê‚ïê‚ïê CLEAR / UTILS ‚ïê‚ïê‚ïê
function clearCanvas(){
  S_attackPaths=[];S_boundaryFindings=[];S_pathFindings=[];_highlightedPathIdx=-1;
  const apBadge=document.getElementById('apTabBadge');if(apBadge)apBadge.textContent='0';
  const apCon=document.getElementById('attackPathsContainer');
  if(apCon)apCon.innerHTML='<div style="text-align:center;color:var(--text3);padding:24px 0;font-size:12px">Run analysis to detect attack paths</div>';
  document.querySelectorAll('.trust-zone-overlay').forEach(el=>el.remove());
  Object.keys(S.nodes).forEach(id=>{const el=document.getElementById(id);if(el)el.remove();});
  S.nodes={};S.edges=[];S.threats=[];S.cmRows={};S.nextId=1;
  blastSourceId=null;_lastBlastDist=null;
  document.getElementById('svgLayer').querySelectorAll('path,text,rect').forEach(e=>e.remove());
  document.getElementById('detectedThreats').innerHTML='<div style="text-align:center;color:var(--text3);padding:24px 0;font-size:12px">Build DFD then press Analyze</div>';
  document.getElementById('ctpSection').style.display='none';
  document.getElementById('edgeEditorSection').style.display='none';
  const countEl=document.getElementById('blastCount');if(countEl)countEl.textContent='Click a node to simulate compromise';
  upHint();
}
function upHint(){document.getElementById('emptyHint').style.display=Object.keys(S.nodes).length?'none':'block';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT / EXPORT
// exportReport() ‚Äî generates a standalone HTML threat report
// saveProject()  ‚Äî serializes S state to JSON and downloads it
// loadProject()  ‚Äî restores S state from a saved JSON file
//
// NOTE: Threats are intentionally NOT saved in project files.
// They are always recomputed from current COMPONENT_THREATS
// rules on load, preventing stale threat data in saved files.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportReport(){
  const name=document.getElementById('appName').value||'Unnamed Application';
  const ver=document.getElementById('appVersion').value||'1.0';
  const desc=document.getElementById('appDesc').value||'No description.';
  const owner=document.getElementById('docOwner').value||'‚Äî';
  const parts=document.getElementById('docParticipants').value||'‚Äî';
  const rev=document.getElementById('docReviewer').value||'‚Äî';
  const date=document.getElementById('docDate').value||new Date().toISOString().split('T')[0];
  const ord={critical:0,high:1,medium:2,low:3};
  const sorted=[...S.threats].sort((a,b)=>ord[a.sev]-ord[b.sev]);
  const scl=s=>({critical:'#dc2626',high:'#ea580c',medium:'#ca8a04',low:'#16a34a'}[s]||'#666');

  // Build Management Overview ‚Äî prepended before all technical sections
  const execHtml = S.threats.length ? buildExecSummaryHTML(calculateMaturityMetrics(), true) : '';

  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Threat Model ‚Äî ${name}</title>
<style>body{font-family:Arial,sans-serif;max-width:1100px;margin:40px auto;color:#222;line-height:1.6;}h1{font-size:26px;border-bottom:3px solid #222;padding-bottom:8px;}h2{font-size:17px;border-left:4px solid #0d6efd;padding-left:12px;margin-top:28px;}table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}th{background:#222;color:#fff;padding:8px 11px;text-align:left;}td{padding:7px 11px;border-bottom:1px solid #ddd;vertical-align:top;}tr:nth-child(even)td{background:#f8f9fa;}.meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;background:#f8f9fa;padding:14px;border-radius:8px;font-size:13px;}.meta label{font-weight:700;font-size:11px;display:block;text-transform:uppercase;color:#666;}</style></head>
<body><h1>üõ° Threat Model Report</h1><p style="color:#666;margin-top:-4px">Generated by ThreatCanvas ¬∑ OWASP Threat Modeling Process (Larry Conklin)</p>
${execHtml}
<h2>1. Project Information</h2>
<div class="meta"><div><label>Application</label>${name} v${ver}</div><div><label>Date</label>${date}</div><div><label>Document Owner</label>${owner}</div><div><label>Participants</label>${parts}</div><div><label>Reviewer</label>${rev}</div><div><label>Threats Found</label>${S.threats.length}</div></div>
<div style="margin-top:10px;padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:13px"><strong>Description:</strong> ${desc}</div>
<h2>2. Architecture ‚Äî DFD Components</h2>
<table><thead><tr><th>Component</th><th>Type</th><th>Trust Level</th></tr></thead><tbody>${Object.values(S.nodes).map(n=>`<tr><td>${n.label}</td><td>${n.type}</td><td>${n.trust}</td></tr>`).join('')}</tbody></table>
<h2>3. Data Flows</h2>
<table><thead><tr><th>From</th><th>To</th><th>Protocol</th><th>Data Class</th><th>Auth</th><th>Encryption</th><th>Trust Boundary</th></tr></thead><tbody>${S.edges.map(e=>`<tr><td>${S.nodes[e.from]?.label||e.from}</td><td>${S.nodes[e.to]?.label||e.to}</td><td>${e.protocol}</td><td>${e.dataClass}</td><td>${e.auth}</td><td>${e.encryption}</td><td>${e.trustBoundary}</td></tr>`).join('')}</tbody></table>
<h2>4. Threat List (STRIDE)</h2>
${!S.threats.length?'<p>No threats detected.</p>':`<table><thead><tr><th>ID</th><th>Threat</th><th>STRIDE</th><th>Severity</th><th>Likelihood</th><th>Impact</th><th>Risk</th><th>Response</th><th>Status</th></tr></thead><tbody>${sorted.map(t=>{const row=S.cmRows[t.id]||{response:'‚Äî',status:'Non-Mitigated'};return`<tr><td>${t.id}</td><td>${t.name}</td><td>${sn(t.stride)}</td><td style="color:${scl(t.sev)};font-weight:700">${t.sev.toUpperCase()}</td><td>${t.like}</td><td>${t.imp}</td><td style="color:${scl(rr(t.like,t.imp).toLowerCase())};font-weight:700">${rr(t.like,t.imp)}</td><td>${row.response}</td><td>${row.status}</td></tr>`;}).join('')}</tbody></table>`}
<h2>5. Countermeasure Details</h2>
${sorted.map(t=>`<div style="background:#f8f9fa;border-left:4px solid ${scl(t.sev)};padding:12px 14px;margin-bottom:12px;border-radius:0 8px 8px 0"><strong>${t.id}: ${t.name}</strong> <span style="font-size:12px;color:#666">‚Äî ${sn(t.stride)} ¬∑ Control: ${t.ctrl}</span><p style="margin:7px 0;font-size:13px">${t.desc}</p><strong style="font-size:12px">Mitigations:</strong><ul style="margin:4px 0;font-size:13px">${t.mits.map(m=>`<li>${m}</li>`).join('')}</ul></div>`).join('')}
<h2>6. Risk Summary</h2>
<table><thead><tr><th>Severity</th><th>Count</th><th>%</th></tr></thead><tbody>${['critical','high','medium','low'].map(s=>{const cnt=S.threats.filter(t=>t.sev===s).length;return`<tr><td style="color:${scl(s)};font-weight:700">${s.toUpperCase()}</td><td>${cnt}</td><td>${S.threats.length?Math.round(cnt/S.threats.length*100):0}%</td></tr>`;}).join('')}</tbody></table>
<p style="margin-top:28px;font-size:11px;color:#999;border-top:1px solid #ddd;padding-top:10px">Generated ${new Date().toLocaleString()} ¬∑ ThreatCanvas ¬∑ OWASP Threat Modeling Process</p>
</body></html>`;
  const blob=new Blob([html],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`threat-model-${name.replace(/\s+/g,'-').toLowerCase()}.html`;a.click();
}

// ‚ïê‚ïê‚ïê SAVE / LOAD PROJECT ‚ïê‚ïê‚ïê

function _readScopeTable(tbodyId){
  const rows=[];
  document.getElementById(tbodyId).querySelectorAll('tr').forEach(tr=>{
    const cells=[...tr.querySelectorAll('td')];
    if(!cells.length)return;
    // Last cell is always the delete button ‚Äî skip it
    const row=cells.slice(0,-1).map(td=>{
      const sel=td.querySelector('select');
      return sel?sel.value:td.textContent.trim();
    });
    rows.push(row);
  });
  return rows;
}

function saveProject(){
  const appName=document.getElementById('appName').value||'Unnamed';
  const payload={
    _tc:'ThreatCanvas/2.0',
    savedAt:new Date().toISOString(),
    projectInfo:{
      appName:document.getElementById('appName').value,
      appVersion:document.getElementById('appVersion').value,
      appDesc:document.getElementById('appDesc').value,
      docOwner:document.getElementById('docOwner').value,
      docParticipants:document.getElementById('docParticipants').value,
      docReviewer:document.getElementById('docReviewer').value,
      docDate:document.getElementById('docDate').value,
    },
    scopeTables:{
      trust:_readScopeTable('trustTbody'),
      entry:_readScopeTable('entryTbody'),
      exit:_readScopeTable('exitTbody'),
      assets:_readScopeTable('assetsTbody'),
      deps:_readScopeTable('depsTbody'),
    },
    // STATE DRIFT PROTECTION: save topology + user decisions only.
    // Threat objects are NOT saved ‚Äî they are always recomputed from current
    // rules on load, so old saves never silently present stale threat data.
    topology:{
      nodes:S.nodes,
      edges:S.edges.map(e=>({...e,_atk:false,_atkColor:null})),
      nextId:S.nextId,
    },
    cmRows:S.cmRows,
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`threatcanvas-${appName.replace(/\s+/g,'-').toLowerCase()}-${new Date().toISOString().slice(0,10)}.json`;
  a.click();URL.revokeObjectURL(a.href);
  const btn=document.querySelector('.btn-save');
  const orig=btn.textContent;
  btn.textContent='‚úì Saved!';btn.style.color='#00ff99';
  setTimeout(()=>{btn.textContent=orig;btn.style.color='';},1800);
}

// Scope table rebuild helpers ‚Äî each handles its unique column structure
function _buildTrustRow(i,c){return`<tr><td>TL-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">${c[1]||''}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[2]||''}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`;}
function _buildEntryRow(i,c){return`<tr><td>EP-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">${c[1]||''}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[2]||''}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[3]||''}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`;}
// BUG FIX: Use <select> (consistent with ROW_TEMPLATES.exit) so risk is editable after load.
// Previously used a static <span> which made the risk level read-only after restoring a project.
function _buildExitRow(i,c){const r=c[3]||'Medium';return`<tr><td>XP-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">${c[1]||''}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[2]||''}</td><td><select style="background:var(--s2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;padding:2px"><option ${r==='High'?'selected':''}>High</option><option ${r==='Medium'?'selected':''}>Medium</option><option ${r==='Low'?'selected':''}>Low</option></select></td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`;}
function _buildAssetsRow(i,c){return`<tr><td>A-${i}</td><td contenteditable="true" style="outline:none;color:var(--text)">${c[1]||''}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[2]||''}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[3]||''}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`;}
function _buildDepsRow(i,c){return`<tr><td>DEP-${i}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${c[1]||''}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`;}

function loadProject(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    let data;
    try{data=JSON.parse(ev.target.result);}
    catch{alert('Invalid file ‚Äî could not parse JSON.');input.value='';return;}
    if(!data._tc||!data._tc.startsWith('ThreatCanvas')){
      if(!confirm('This may not be a ThreatCanvas project file. Load anyway?')){input.value='';return;}
    }
    // ‚îÄ‚îÄ 1. Restore form fields ‚îÄ‚îÄ
    const pi=data.projectInfo||{};
    ['appName','appVersion','appDesc','docOwner','docParticipants','docReviewer','docDate']
      .forEach(id=>{const el=document.getElementById(id);if(el&&pi[id]!==undefined)el.value=pi[id];});
    // ‚îÄ‚îÄ 2. Rebuild scope tables ‚îÄ‚îÄ
    const st=data.scopeTables||{};
    [['trustTbody','trust',_buildTrustRow],['entryTbody','entry',_buildEntryRow],
     ['exitTbody','exit',_buildExitRow],['assetsTbody','assets',_buildAssetsRow],
     ['depsTbody','deps',_buildDepsRow]].forEach(([tbId,key,builder])=>{
      const tbody=document.getElementById(tbId);tbody.innerHTML='';ROW_COUNTS[key]=0;
      (st[key]||[]).forEach(cols=>{ROW_COUNTS[key]++;tbody.insertAdjacentHTML('beforeend',builder(ROW_COUNTS[key],cols));});
    });
    // ‚îÄ‚îÄ 3. Clear canvas and restore topology ‚îÄ‚îÄ
    clearCanvas();
    const topo=data.topology||{};
    S.nodes=topo.nodes||{};
    S.edges=(topo.edges||[]).map(e=>({...e,_atk:false,_atkColor:null}));
    S.nextId=topo.nextId||1;
    // ‚îÄ‚îÄ 4. Restore user decisions (cmRows) only ‚Äî threats are always recomputed ‚îÄ‚îÄ
    S.cmRows=data.cmRows||{};
    // ‚îÄ‚îÄ 5. Rebuild node DOM from topology ‚îÄ‚îÄ
    Object.values(S.nodes).forEach(nd=>{
      const def=DEFS[nd.type];if(!def)return;
      // Ensure trustZone is set when loading old saves that didn't have it
      if(!nd.trustZone){
        const _ztz={public:'internet',dmz:'dmz',private:'internal',isolated:'restricted'};
        nd.trustZone=def.trustZone||_ztz[nd.zone||'private']||'internal';
      }
      const el=document.createElement('div');el.className='node';el.id=nd.id;
      el.style.left=nd.x+'px';el.style.top=nd.y+'px';
      el.innerHTML=`<div class="node-hdr" style="background:${def.color}18"><span class="node-ico"></span><span class="node-title" style="color:${def.color}"></span></div><div class="node-body"><span class="node-body-text"></span><br><span style="color:var(--text3);font-size:9px"></span></div><div class="node-pills" id="pills-${nd.id}"></div><div class="port port-r" data-node="${nd.id}"></div><div class="port port-l" data-node="${nd.id}"></div>`;
      el.querySelector('.node-ico').textContent=def.icon;
      el.querySelector('.node-title').textContent=nd.label;
      el.querySelector('.node-body-text').textContent=def.body;
      el.querySelectorAll('.node-body span')[1].textContent=nd.trust.toUpperCase();
      el.querySelectorAll('.port').forEach(p=>p.addEventListener('mousedown',ev=>{ev.stopPropagation();handlePort(nd.id,p);}));
      let _lx,_ly;
      el.addEventListener('mousedown',ev=>{if(ev.target.classList.contains('port'))return;_lx=ev.clientX;_ly=ev.clientY;});
      el.addEventListener('mouseup',ev=>{if(ev.target.classList.contains('port'))return;if(Math.abs(ev.clientX-_lx)<5&&Math.abs(ev.clientY-_ly)<5)selNode(nd.id);});
      makeDrag(el,S.nodes[nd.id]);
      el.classList.add('tz-'+(nd.trustZone||'internal')+'-node');
      document.getElementById('canvas').appendChild(el);
    });
    // ‚îÄ‚îÄ 6. Redraw edges, run fresh analysis against current ruleset ‚îÄ‚îÄ
    redraw();upHint();
    goStep(2);
    setTimeout(()=>{
      runAnalysis();zoomFit();
      setTimeout(renderTrustZoneOverlays, 150);
      document.getElementById('statusBar').textContent=`Project loaded ‚Äî ${S.threats.length} threats detected`;
    },250);
    input.value='';
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXAMPLE PROJECT LOADER
// Populates all scope tables, creates a realistic college
// library DFD, and runs analysis ‚Äî useful for demos/onboarding.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadExample(){
  document.getElementById('appName').value='College Library Website';
  document.getElementById('appVersion').value='1.0';
  document.getElementById('appDesc').value='Online portal for students, faculty, and librarians to search, request, and manage books. Role-based access: Students (search), Staff (request), Librarians (admin).';
  document.getElementById('docOwner').value='David Lowry';
  document.getElementById('docParticipants').value='David Rook';
  document.getElementById('docReviewer').value='Eoin Keary';
  document.getElementById('docDate').value='2026-02-18';
  // Trust levels
  document.getElementById('trustTbody').innerHTML='';
  ROW_COUNTS.trust=0;
  [['Anonymous Web User','Connected to site, no authentication'],['Student / Staff','Valid login credentials, search/request access'],['Librarian','Create users, add books, view PII'],['DB Administrator','Full read/write DB access'],['Web Server Process','Process executing application code']].forEach(([n,d])=>{ROW_COUNTS.trust++;document.getElementById('trustTbody').insertAdjacentHTML('beforeend',`<tr><td>TL-${ROW_COUNTS.trust}</td><td contenteditable="true" style="outline:none;color:var(--text)">${n}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${d}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`);});
  // Entry points
  document.getElementById('entryTbody').innerHTML='';ROW_COUNTS.entry=0;
  [['HTTPS Port','All pages served over TLS only','TL-1, TL-2, TL-3'],['Main Library Page','Splash page for all users','TL-1'],['Login Page','Auth form accepting credentials','TL-1, TL-2, TL-3'],['Search Page','Book search query input','TL-2, TL-3']].forEach(([n,d,t])=>{ROW_COUNTS.entry++;document.getElementById('entryTbody').insertAdjacentHTML('beforeend',`<tr><td>EP-${ROW_COUNTS.entry}</td><td contenteditable="true" style="outline:none;color:var(--text)">${n}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${d}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${t}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`);});
  // Exit points
  document.getElementById('exitTbody').innerHTML='';ROW_COUNTS.exit=0;
  [['Login Error Messages','May reveal valid usernames (account harvesting)','High'],['Search Results','XSS if results not sanitised','Medium'],['SQL Error Output','Exposes schema if errors not suppressed','High']].forEach(([n,d,r])=>{ROW_COUNTS.exit++;document.getElementById('exitTbody').insertAdjacentHTML('beforeend',`<tr><td>XP-${ROW_COUNTS.exit}</td><td contenteditable="true" style="outline:none;color:var(--text)">${n}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${d}</td><td><select style="background:var(--s2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;padding:2px"><option ${r==='High'?'selected':''}>High</option><option ${r==='Medium'?'selected':''}>Medium</option><option ${r==='Low'?'selected':''}>Low</option></select></td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`);});
  // Assets
  document.getElementById('assetsTbody').innerHTML='';ROW_COUNTS.assets=0;
  [['User Login Credentials','Student/staff passwords in DB','TL-2, TL-4, TL-5'],['Personal Data (PII)','Student/staff personal information','TL-3, TL-4'],['Library Availability','24/7 service uptime','TL-4, TL-5'],['Audit Log Data','Trail of all user operations','TL-3']].forEach(([n,d,t])=>{ROW_COUNTS.assets++;document.getElementById('assetsTbody').insertAdjacentHTML('beforeend',`<tr><td>A-${ROW_COUNTS.assets}</td><td contenteditable="true" style="outline:none;color:var(--text)">${n}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${d}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${t}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`);});
  // External deps
  document.getElementById('depsTbody').innerHTML='';ROW_COUNTS.deps=0;
  [['Apache on hardened Linux ‚Äî latest OS + security patches applied'],['MySQL on hardened Linux ‚Äî latest patches, private network only'],['Web-to-DB connection over private network (no internet exposure)'],['Perimeter firewall ‚Äî only TLS traffic permitted inbound']].forEach(([d])=>{ROW_COUNTS.deps++;document.getElementById('depsTbody').insertAdjacentHTML('beforeend',`<tr><td>DEP-${ROW_COUNTS.deps}</td><td contenteditable="true" style="outline:none;color:var(--text2)">${d}</td><td><button class="del-btn" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`);});
  // Build DFD
  goStep(2);clearCanvas();
  const ids=[];
  [{t:'user',x:20,y:130},{t:'internet',x:20,y:275},{t:'attacker',x:20,y:405},{t:'waf',x:284,y:185},{t:'loadbalancer',x:284,y:320},{t:'webserver',x:548,y:80},{t:'api',x:548,y:235},{t:'database',x:812,y:155},{t:'cache',x:812,y:305},{t:'storage',x:812,y:28},{t:'idp',x:548,y:385},{t:'siem',x:548,y:480}].forEach(n=>ids.push(createNode(n.t,n.x,n.y)));
  const [uId,iId,aId,wId,lbId,wsId,apiId,dbId,cId,stId,idpId,siemId]=ids;
  [[uId,wId,'HTTPS','Internal','JWT','TLS 1.3','No'],[iId,wId,'HTTPS','Public','None','TLS 1.2 (strong)','Yes ‚Äî Internet to DMZ'],[aId,wId,'HTTP','Internal','None','None','Yes ‚Äî Internet to DMZ'],[wId,lbId,'HTTPS','Internal','API Key','TLS 1.3','No'],[lbId,wsId,'HTTP','Internal','None','None','No'],[lbId,apiId,'HTTPS','Confidential','JWT','TLS 1.3','No'],[wsId,stId,'S3','Confidential','IAM Role','TLS 1.3','Yes ‚Äî Internal to Restricted'],[apiId,dbId,'SQL','PII','None','None','Yes ‚Äî Internal to Restricted'],[apiId,cId,'Redis','Confidential','None','TLS 1.2 (strong)','No'],[apiId,idpId,'HTTPS','Confidential','OAuth2','TLS 1.3','No'],[wsId,siemId,'TCP','Internal','API Key','TLS 1.2 (strong)','No'],[apiId,siemId,'TCP','Internal','API Key','TLS 1.2 (strong)','No']].forEach(([from,to,p,d,a,e,tb])=>S.edges.push({id:'e'+S.nextId++,from,to,protocol:p,dataClass:d,auth:a,encryption:e,trustBoundary:tb,_atk:false,_atkColor:null}));
  redraw();upHint();
  setTimeout(()=>{
    runAnalysis();   // adds threat pills ‚Üí expands node widths
    // Double rAF ensures browser has fully reflowed pill badges before
    // zoomFit reads offsetWidth/offsetHeight for bounding-box calculation.
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      zoomFit();     // scales viewport to fit all nodes at correct sizes
      setTimeout(renderTrustZoneOverlays, 150);
    }));
  },250);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZATION
// Sets today's date in the scope form and initializes UI mode.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Init
document.getElementById('docDate').value=new Date().toISOString().split('T')[0];
setMode('analyze');
</script>
</body>
</html>
